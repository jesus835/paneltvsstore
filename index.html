<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Codex Panel - Smart elevator monitoring dashboard">
    <meta name="author" content="Codex Panel">
    <meta name="theme-color" content="#1a1a2e">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://script.google.com https://script.googleusercontent.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://cdnjs.cloudflare.com https://script.google.com https://script.googleusercontent.com;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>Codex Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Just+Another+Hand&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8d5f2 0%, #f5e6ff 100%);
            min-height: 100vh;
        }

        /* Hide both by default - script will show the correct one */
        .login-container {
            display: none;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* Show login if not logged in */
        html.not-logged-in .login-container {
            display: flex !important;
        }

        /* Show dashboard if logged in */
        html.logged-in #dashboardContainer {
            display: flex !important;
        }

        /* Hide dashboard if not logged in */
        html.not-logged-in #dashboardContainer {
            display: none !important;
        }

        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease-out;
        }

        .loading-screen-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            width: auto;
            max-width: 90%;
        }

        html.logged-in .loading-screen {
            display: flex;
        }

        html.not-logged-in .loading-screen {
            display: none !important;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            font-size: 36px;
            font-weight: 700;
            color: white;
            margin-bottom: 20px;
            letter-spacing: -1px;
        }

        .loading-logo .highlight {
            color: #c8ff00;
        }

        .loading-subtitle {
            font-size: 16px;
            font-weight: 400;
            font-family: 'Just Another Hand', cursive;
            color: rgba(255, 255, 255, 0.9);
            margin-top: -25px;
            margin-bottom: 20px;
            margin-left: 0;
            letter-spacing: 1px;
            text-align: left;
            align-self: flex-start;
        }

        .loading-dots {
            display: flex;
            gap: 8px;
            align-self: center;
            margin-top: 10px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #c8ff00;
            border-radius: 50%;
            animation: loadingPulse 1.5s ease-in-out infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .loading-dot:nth-child(4) {
            animation-delay: 0.6s;
        }

        @keyframes loadingPulse {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header .logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            margin: 0 auto 20px;
        }

        .login-header h1 {
            font-size: 28px;
            color: #1a1a2e;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #888;
            font-size: 14px;
        }

        .login-form-group {
            margin-bottom: 25px;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1a1a2e;
            font-weight: 600;
            font-size: 14px;
        }

        .login-form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .login-form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-error {
            color: #ef5350;
            font-size: 13px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }

        .dashboard-container {
            display: none;
            height: 100vh;
            overflow: hidden;
        }

        .dashboard-container.active,
        .dashboard-container[style*="display: flex"] {
            display: flex !important;
        }

        .sidebar {
            width: 200px;
            background: #1a1a2e;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: #c8ff00;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a2e;
            padding: 5px;
        }

        .logo-icon img {
            filter: brightness(0);
            margin-left: 6%;
        }

        .menu-item {
            padding: 12px 16px;
            color: #a0a0b0;
            text-decoration: none;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            position: relative;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-item.active {
            background: #c8ff00;
            color: #1a1a2e;
        }

        .menu-item .badge {
            position: absolute;
            right: 12px;
            background: white;
            color: #1a1a2e;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .mobile-app-promo {
            margin-top: auto;
            background: #c8ff00;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
        }

        .mobile-app-promo i {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .mobile-app-promo h4 {
            margin: 10px 0;
            font-size: 14px;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .company-data-section {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
            color: #1a1a2e;
        }

        .search-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-box {
            background: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box input {
            border: none;
            outline: none;
            background: transparent;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header {
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .section-header h2 {
            font-size: 18px;
            color: #1a1a2e;
        }

        .view-all {
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .course-card {
            background: white;
            padding: 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .course-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .course-info {
            flex: 1;
            min-width: 0;
        }

        .course-info h3 {
            font-size: 14px;
            margin-bottom: 3px;
        }

        .course-info p {
            color: #888;
            font-size: 11px;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        .rating i {
            color: #ffa726;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 0;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .activity-card,
        .schedule-card {
            background: white;
            padding: 15px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .notifications-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            max-height: 100%;
            padding-right: 5px;
        }

        /* Custom scrollbar for notifications list */
        .notifications-list::-webkit-scrollbar {
            width: 6px;
        }

        .notifications-list::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 3px;
        }

        .notifications-list::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .notifications-list::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        /* Toast notification styles for recent activity */
        .toast {
            background: white !important;
            border-radius: 12px !important;
            padding: 16px 20px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
            position: relative !important;
            overflow: hidden !important;
            margin-bottom: 12px !important;
            border: 1px solid #e0e0e0 !important;
            min-height: 60px !important;
            z-index: 1000 !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .toast .icon {
            width: 24px;
            height: 24px;
            background: #27ae60;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .toast .msg {
            flex: 1;
            color: #333;
        }

        .toast .msg strong {
            font-size: 14px;
            font-weight: 600;
            color: #1e1e1e;
        }

        .toast .msg small {
            font-size: 12px;
            color: #666;
        }

        .toast .progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #27ae60;
            width: 100%;
        }

        .notification-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .notification-item:hover {
            background: #f0f0f0;
        }

        .notification-icon {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-content h4 {
            font-size: 14px;
            margin-bottom: 3px;
            color: #1a1a2e;
        }

        .notification-content p {
            font-size: 11px;
            color: #888;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .card-header h2 {
            font-size: 16px;
        }

        .chart-container {
            height: 200px;
            position: relative;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100%;
        }

        .bar {
            width: 30px;
            background: #1a1a2e;
            border-radius: 8px 8px 0 0;
            position: relative;
        }

        .bar.highlight {
            background: #c8ff00;
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #888;
        }

        .increase-badge {
            background: #d4f8d4;
            color: #2e7d32;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .schedule-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .schedule-item:hover {
            background: #f0f0f0;
        }

        .schedule-icon {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .schedule-content {
            flex: 1;
            margin-left: 10px;
            min-width: 0;
        }

        .schedule-content h4 {
            font-size: 14px;
            margin-bottom: 3px;
        }

        .schedule-content p {
            font-size: 11px;
            color: #888;
        }

        .courses-taking {
            background: white;
            padding: 25px;
            border-radius: 20px;
        }

        .course-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .course-item:last-child {
            border-bottom: none;
        }

        .course-avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .course-details {
            flex: 1;
        }

        .course-details h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .instructor {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #888;
        }

        .instructor img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .course-progress {
            text-align: right;
        }

        .progress-text {
            font-size: 13px;
            color: #888;
            margin-bottom: 5px;
        }

        .time-remaining {
            font-size: 14px;
            font-weight: 600;
        }

        .progress-circle {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }

        .right-sidebar {
            width: 300px;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .premium-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .premium-card h3 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .premium-card p {
            font-size: 13px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .plan-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .plan-status-badge.active {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.4);
            color: #4ade80;
        }

        .plan-status-badge.inactive {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
        }

        .plan-status-badge i {
            font-size: 14px;
        }

        .premium-btn {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 30px;
            border: none;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }

        .premium-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
            background: linear-gradient(135deg, #128C7E 0%, #25D366 100%);
        }

        .premium-btn:active {
            transform: translateY(0);
        }

        .premium-illustration {
            position: absolute;
            right: -20px;
            bottom: -10px;
            font-size: 120px;
            opacity: 0.08;
        }

        .calendar-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day {
            text-align: center;
            padding: 8px;
            font-size: 13px;
            border-radius: 8px;
            cursor: pointer;
        }

        .calendar-day.header {
            font-weight: bold;
            color: #888;
        }

        .calendar-day.today {
            background: #c8ff00;
            font-weight: bold;
        }

        .calendar-day.inactive {
            color: #ccc;
        }

        .assignments-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
        }

        .assignment-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .assignment-item:last-child {
            border-bottom: none;
        }

        .assignment-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .assignment-info {
            flex: 1;
        }

        .assignment-info h4 {
            font-size: 14px;
            margin-bottom: 3px;
        }

        .assignment-info p {
            font-size: 11px;
            color: #888;
        }

        .assignment-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-progress {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-upcoming {
            background: #fff3e0;
            color: #f57c00;
        }

        .add-btn {
            width: 35px;
            height: 35px;
            background: #c8ff00;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #1a1a2e;
            color: #c8ff00;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        select {
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
        }

        .input-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }

        .input-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .company-name-input {
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            background: white;
            color: #1a1a2e;
            font-size: 14px;
            transition: all 0.3s;
        }

        .company-name-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.company-name-input {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .client-option:hover {
            background: #f9f9f9 !important;
        }

        .client-option[data-selected="true"] {
            background: #f0f4ff !important;
        }

        #clientModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }


        .update-btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: #c8ff00;
            color: #1a1a2e;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(200, 255, 0, 0.3);
        }

        .update-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(200, 255, 0, 0.4);
            background: #b8e600;
        }

        .update-btn:active {
            transform: translateY(0);
        }

        /* Custom scrollbar for users list */
        #usersList {
            scrollbar-width: thin;
            scrollbar-color: #667eea #f0f0f0;
        }

        #usersList::-webkit-scrollbar {
            width: 8px;
        }

        #usersList::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        #usersList::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        #usersList::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        /* Custom scrollbar for clients list */
        #clientsListContainer {
            scrollbar-width: thin;
            scrollbar-color: #667eea #f0f0f0;
        }

        #clientsListContainer::-webkit-scrollbar {
            width: 8px;
        }

        #clientsListContainer::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        #clientsListContainer::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        #clientsListContainer::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        /* Custom scrollbar for devices list */
        #devicesList {
            scrollbar-width: thin;
            scrollbar-color: #667eea #f0f0f0;
        }

        #devicesList::-webkit-scrollbar {
            width: 8px;
        }

        #devicesList::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        #devicesList::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        #devicesList::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        /* Custom scrollbar for buildings list */
        #buildingsList {
            scrollbar-width: thin;
            scrollbar-color: #667eea #f0f0f0;
        }

        #buildingsList::-webkit-scrollbar {
            width: 8px;
        }

        #buildingsList::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        #buildingsList::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        #buildingsList::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        /* Custom scrollbar for custom alerts list */
        #customAlertsList {
            scrollbar-width: thin;
            scrollbar-color: #667eea #f0f0f0;
        }

        #customAlertsList::-webkit-scrollbar {
            width: 8px;
        }

        #customAlertsList::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        #customAlertsList::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        #customAlertsList::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        /* Form group styles for devices */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 7px;
            font-size: 0.85rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* Message styles */
        #deviceMsg.success {
            color: #27ae60;
            font-weight: 600;
        }

        #deviceMsg.error {
            color: #e74c3c;
            font-weight: 600;
        }

        /* Color Picker Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-close:hover {
            color: #e74c3c;
            transform: rotate(90deg);
        }

        .quick-color {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .quick-color:hover {
            transform: scale(1.1);
            border-color: #1a1a2e;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .quick-color:active {
            transform: scale(0.95);
        }

        #colorPickerBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        #colorPickerBtn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
    </style>
    <script>
        // Check login state immediately in head - before body renders
        (function () {
            try {
                const isLoggedIn = localStorage.getItem('isLoggedIn');
                if (isLoggedIn === 'true') {
                    document.documentElement.classList.add('logged-in');
                } else {
                    document.documentElement.classList.add('not-logged-in');
                }
            } catch (e) {
                console.error('Error checking login state:', e);
                document.documentElement.classList.add('not-logged-in');
            }
        })();
    </script>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-screen-content">
            <div class="loading-logo" id="loadingLogoText">
                <span class="highlight"></span>
            </div>
            <div class="loading-subtitle">Custom Panel By Codex</div>
            <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
    </div>

    <!-- Inline script to load cached company name immediately for loading screen -->
    <script>
        (function () {
            try {
                const cachedCompanyData = localStorage.getItem('dashboard_companyData');
                if (cachedCompanyData) {
                    try {
                        const data = JSON.parse(cachedCompanyData);
                        if (data.companyName) {
                            // Store in a global variable that will be used when DOM loads
                            window._cachedCompanyName = data.companyName;

                            // Update immediately since element now exists
                            const loadingLogo = document.getElementById('loadingLogoText');
                            if (loadingLogo && data.companyName) {
                                const nameParts = data.companyName.split(' ');
                                if (nameParts.length > 1) {
                                    const mainName = nameParts[0];
                                    const highlightName = nameParts.slice(1).join(' ');
                                    loadingLogo.innerHTML = `${mainName}<span class="highlight"> ${highlightName}</span>`;
                                } else {
                                    loadingLogo.innerHTML = `${data.companyName}<span class="highlight"></span>`;
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing cached company data:', e);
                    }
                }
            } catch (e) {
                console.error('Error loading cached company data:', e);
            }
        })();
    </script>

    <!-- Login Section -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-header">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h1>Welcome Back</h1>
                <p>Sign in to access your dashboard</p>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="login-form-group">
                    <label for="loginEmail">
                        <i class="fas fa-envelope" style="margin-right: 8px; color: #667eea;"></i>Email
                    </label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="login-form-group">
                    <label for="loginPassword">
                        <i class="fas fa-lock" style="margin-right: 8px; color: #667eea;"></i>Password
                    </label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <div class="login-error" id="loginError">
                    Invalid email or password. Please try again.
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt" style="margin-right: 8px;"></i>Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <img src="https://i.imgur.com/Y0RVLxy.png" alt="Codex Logo"
                        style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                Codex
            </div>

            <a href="#" class="menu-item" id="dashboardMenuItem" onclick="showDashboard(event)">
                <i class="fas fa-th-large"></i>
                Dashboard
            </a>
            <a href="#" class="menu-item" id="companyDataMenuItem" onclick="toggleCompanyData(event)">
                <i class="fas fa-book"></i>
                Company Data
            </a>
            <a href="#" class="menu-item" id="usersMenuItem" onclick="showUsers(event)">
                <i class="fas fa-users"></i>
                Users
            </a>
            <a href="#" class="menu-item" id="notificationsMenuItem" onclick="showNotifications(event)">
                <i class="fas fa-bell"></i>
                Send Notifications
            </a>
            <a href="#" class="menu-item" id="devicesMenuItem" onclick="showDevices(event)">
                <i class="fas fa-mobile-alt"></i>
                Devices
            </a>
            <a href="#" class="menu-item" id="reportsMenuItem" onclick="showReports(event)">
                <i class="fas fa-file-alt"></i>
                Reports
            </a>
            <a href="#" class="menu-item" id="buildingsMenuItem" onclick="showBuildings(event)">
                <i class="fas fa-building"></i>
                Buildings
            </a>
            <a href="#" class="menu-item" id="supportMenuItem" onclick="showSupport(event)">
                <i class="fas fa-life-ring"></i>
                Service Request
            </a>
            <a href="#" class="menu-item" onclick="openLogoutModal(event)">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>

        <div class="main-content" id="mainContent">
            <div class="header">
                <h1>Welcome back ðŸ‘‹</h1>
            </div>

            <div class="section-header">
                <h2>Control Center</h2>
            </div>

            <div
                style="background: white; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); flex-shrink: 0;">
                <p style="font-size: 13px; color: #1a1a2e; margin-bottom: 10px;">
                    <i class="fas fa-info-circle" style="margin-right: 8px; color: #667eea;"></i>
                    Go to Company Data section to manage your company information
                </p>
                <button class="update-btn" onclick="toggleCompanyData(event)"
                    style="min-width: 200px; padding: 8px 16px; font-size: 13px;">
                    <i class="fas fa-arrow-right" style="margin-right: 8px;"></i>
                    Go to Company Data
                </button>
            </div>

            <div class="courses-grid">
                <div class="course-card">
                    <div class="course-icon" style="background: #fff3e0;">
                        <i class="fas fa-pen" style="color: #f57c00;"></i>
                    </div>
                    <div class="course-info">
                        <h3 id="companyNameDisplay">Eduplex</h3>
                        <p id="adminEmailDisplay">admin@example.com</p>
                        <div class="rating">
                            <span id="timezoneDisplay">UTC-5</span>
                        </div>
                    </div>
                </div>

                <div class="course-card">
                    <div class="course-icon" style="background: #fff9c4;">
                        <i class="fas fa-graduation-cap" id="logoDisplay" style="color: #f9a825;"></i>
                    </div>
                    <div class="course-info">
                    </div>
                </div>

                <div class="course-card">
                    <div class="course-icon" style="background: #e8eaf6;">
                        <img id="signatureImageDisplay" src="" alt="Signature"
                            style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                    <div class="course-info">
                    </div>
                </div>
            </div>

            <div class="two-column">
                <div class="activity-card">
                    <div class="card-header"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>Recent Activity</h2>
                        <button onclick="showReports(event)"
                            style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s;">
                            View all
                        </button>
                    </div>
                    <div class="notifications-list" id="recentActivityList">
                        <!-- Recent activity will be loaded dynamically here -->
                    </div>
                </div>

                <div class="schedule-card">
                    <div class="card-header"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>Registered Users</h2>
                        <button onclick="showUsers(event)"
                            style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s;">
                            View all
                        </button>
                    </div>
                    <div class="schedule-list" id="randomUsersList">
                        <!-- Users will be loaded dynamically here -->
                    </div>
                </div>
            </div>

        </div>

        <div class="right-sidebar" id="rightSidebar">
            <div class="premium-card" id="premiumCard">
                <div class="logo" style="margin-bottom: 15px;">
                    <div class="logo-icon" style="width: 30px; height: 30px; font-size: 14px;">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    Codex
                </div>
                <h3>Professional Plan</h3>
                <div id="planStatusText" class="plan-status-badge">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading plan status...</span>
                </div>
                <div id="planActivateButton">
                    <a href="#" onclick="openWhatsApp(); return false;" class="premium-btn">
                        <i class="fab fa-whatsapp" style="margin-right: 8px;"></i>Activate Plan
                    </a>
                </div>
                <div class="premium-illustration">
                    ðŸ’¼
                </div>
            </div>


            <div class="assignments-card">
                <div class="card-header">
                    <h3>Implementation URL</h3>
                </div>

                <div style="margin-bottom: 20px;">
                    <button onclick="downloadAllUrls()" class="premium-btn"
                        style="width: 100%; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                        <i class="fas fa-download" style="margin-right: 8px;"></i>Descargar Todas las URLs
                    </button>
                </div>

            </div>

            <!-- Daily Alerts Counter -->
            <div class="assignments-card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3>Daily Alerts</h3>
                </div>
                <div style="padding: 30px; text-align: center;">
                    <div style="font-size: 48px; font-weight: 700; color: #667eea; margin-bottom: 10px;" id="dailyAlertsCount">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div style="font-size: 14px; color: #666; font-weight: 500;">
                        Alerts sent today
                    </div>
                </div>
            </div>
        </div>

        <!-- Plan Required Modal -->
        <div id="planRequiredModal" onclick="if(event.target.id === 'planRequiredModal') closePlanRequiredModal();"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); text-align: center;">
                <div
                    style="width: 60px; height: 60px; margin: 0 auto 20px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-lock" style="font-size: 30px; color: #f59e0b;"></i>
                </div>
                <h2 style="margin: 0 0 15px 0; color: #1a1a2e; font-size: 24px;">Plan Requerido</h2>
                <p style="margin: 0 0 25px 0; color: #666; font-size: 15px; line-height: 1.5;">
                    Se requiere un plan Professional activo para descargar las URLs de implementaciÃ³n.
                </p>
                <button onclick="closePlanRequiredModal(); openWhatsApp();"
                    style="background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-right: 10px;">
                    Activar Plan
                </button>
                <button onclick="closePlanRequiredModal()"
                    style="background: #e0e0e0; color: #666; border: none; padding: 12px 30px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    Cerrar
                </button>
            </div>
        </div>

        <!-- Limit Modal -->
        <div id="limitModal" onclick="if(event.target.id === 'limitModal') closeLimitModal();"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); text-align: center;">
                <div
                    style="width: 60px; height: 60px; margin: 0 auto 20px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 30px; color: #dc2626;"></i>
                </div>
                <h2 style="margin: 0 0 15px 0; color: #1a1a2e; font-size: 24px;">Limit Reached</h2>
                <p style="margin: 0 0 25px 0; color: #666; font-size: 15px; line-height: 1.5;">
                    You have reached the limit of available URLs. No more implementation URLs can be generated.
                </p>
                <button onclick="closeLimitModal()"
                    style="background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    Entendido
                </button>
            </div>
        </div>

        <div class="company-data-section" id="devicesSection" style="display: none;">
            <div class="header">
                <h1>Devices</h1>
            </div>
            <div style="padding: 40px;">
                <div class="section-header">
                    <h2>Devices Management</h2>
                    <button class="update-btn" onclick="toggleAddDeviceForm()" style="min-width: 150px;">
                        <i class="fas fa-plus" style="margin-right: 8px;"></i>Add Device
                    </button>
                </div>

                <div id="addDeviceFormContainer"
                    style="display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: rgba(0, 0, 0, 0.08) 0px 2px 8px; margin-bottom: 30px;">
                    <h3 style="font-size: 20px; color: #1a1a2e; margin-bottom: 20px;">
                        <i class="fas fa-mobile-alt" style="margin-right: 8px; color: #667eea;"></i>Add New Device
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div class="input-card">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-fingerprint" style="margin-right: 8px; color: #667eea;"></i>
                                Device ID
                            </label>
                            <input type="text" id="newId" class="company-name-input" placeholder="e.g., ID09"
                                style="width: 100%;" required="">
                        </div>

                        <div class="input-card">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-building" style="margin-right: 8px; color: #667eea;"></i>
                                Building Name
                            </label>
                            <input type="text" id="newBld" class="company-name-input" placeholder="e.g., Hamilton Tower"
                                style="width: 100%;" required="">
                        </div>

                        <div class="input-card">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-elevator" style="margin-right: 8px; color: #667eea;"></i>
                                Unit/Elevator
                            </label>
                            <input type="text" id="newUnit" class="company-name-input" placeholder="e.g., Elevator A"
                                style="width: 100%;" required="">
                        </div>

                        <div class="input-card">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-envelope" style="margin-right: 8px; color: #667eea;"></i>
                                Client Email
                            </label>
                            <input type="email" id="newEmail" class="company-name-input"
                                placeholder="client@example.com" style="width: 100%;">
                        </div>
                    </div>
                    <p id="deviceMsg" style="margin: 8px 0;"></p>
                    <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                        <button type="button" class="update-btn" onclick="toggleAddDeviceForm()"
                            style="background: #ef5350; min-width: 100px;">
                            Cancel
                        </button>
                        <button type="button" id="addDeviceBtn" class="update-btn" style="min-width: 100px;">
                            <i class="fas fa-save" style="margin-right: 8px;"></i>Save Device
                        </button>
                    </div>
                </div>

                <div id="devicesListContainer"
                    style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">
                    <div id="devicesList" style="max-height: 600px; overflow-y: auto; padding-right: 10px;"
                        class="custom-scrollbar">
                        <!-- Devices will be loaded dynamically here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="company-data-section" id="reportsSection" style="display: none;">
            <div class="header">
                <h1>Reports</h1>
            </div>
            <div style="padding: 40px;">
                <div class="section-header">
                    <h2>Reports</h2>
                </div>
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                    <h3 style="margin:0 0 15px 0;color:#0b3d91;font-size:1rem;">Generate Report</h3>

                    <div class="form-group">
                        <label>Report Type</label>
                        <select id="reportType" style="width:100%;padding:8px;font-size:0.9rem;">
                            <option value="alarms">Alarm History Report</option>
                            <option value="service">Service Log Report</option>
                            <option value="summary">Monthly Summary</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Select Device</label>
                        <select id="reportDeviceSelect" style="width:100%;padding:8px;font-size:0.9rem;">
                            <option value="all">Loading devices...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Date Range</label>
                        <div id="dateRangeContainer" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <input type="date" id="reportStartDate" style="width:100%;padding:8px;font-size:0.85rem;">
                            <input type="date" id="reportEndDate" style="width:100%;padding:8px;font-size:0.85rem;">
                        </div>
                        <div id="monthSelectorContainer" style="display:none;">
                            <input type="month" id="reportMonth" style="width:100%;padding:8px;font-size:0.85rem;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Technician Comments</label>
                        <textarea id="reportComments"
                            placeholder="Enter your observations, findings, or recommendations..."
                            style="width:100%;padding:8px;font-size:0.85rem;border:1px solid #ddd;border-radius:4px;resize:vertical;min-height:80px;font-family:inherit;"></textarea>
                    </div>

                    <button id="generateReportBtn"
                        style="width:100%;padding:10px;font-size:0.95rem;margin-top:10px;">Generate &amp; Download
                        PDF</button>
                    <p id="reportMsg" style="margin: 8px 0px; color: rgb(41, 128, 185);" class="success-msg"></p>
                </div>
            </div>
        </div>

        <div class="company-data-section" id="buildingsSection" style="display: none;">
            <div class="header">
                <h1>Buildings</h1>
            </div>
            <div style="padding: 40px;">
                <div class="section-header">
                    <h2>Buildings Management</h2>
                </div>

                <!-- Custom Alert Names Section -->
                <div
                    style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); margin-bottom: 30px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 20px; color: #1a1a2e; margin: 0;">
                            <i class="fas fa-edit" style="margin-right: 8px; color: #667eea;"></i>Custom Alert Names
                        </h3>
                        <button onclick="toggleCustomAlertForm()"
                            style="padding: 10px 20px; border-radius: 8px; border: 2px solid #667eea; background: white; color: #667eea; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                            <i class="fas fa-plus" style="margin-right: 5px;"></i>Add Custom Names
                        </button>
                    </div>

                    <!-- List of existing custom alert names -->
                    <div id="customAlertsList"
                        style="margin-bottom: 20px; max-height: 500px; overflow-y: auto; padding-right: 10px;">
                        <!-- Custom alerts will be loaded here -->
                    </div>

                    <div id="customAlertForm" style="display: none; margin-top: 20px;">
                        <div
                            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label
                                    style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                    <i class="fas fa-mobile-alt" style="margin-right: 8px; color: #667eea;"></i>Device
                                    ID *
                                </label>
                                <input type="text" id="customAlertDeviceId" class="company-name-input"
                                    placeholder="e.g., ID10" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label
                                    style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                    <i class="fas fa-exclamation-triangle"
                                        style="margin-right: 8px; color: #667eea;"></i>input1
                                </label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="customAlertOutOfService" class="company-name-input"
                                        placeholder="e.g., Out of service" style="flex: 1;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer; white-space: nowrap;">
                                        <input type="checkbox" id="activeInput1" checked
                                            style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 13px; color: #667eea; font-weight: 600;">Active</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label
                                    style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                    <i class="fas fa-fire" style="margin-right: 8px; color: #667eea;"></i>input2
                                </label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="customAlertFireService" class="company-name-input"
                                        placeholder="e.g., Fire service" style="flex: 1;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer; white-space: nowrap;">
                                        <input type="checkbox" id="activeInput2" checked
                                            style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 13px; color: #667eea; font-weight: 600;">Active</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label
                                    style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                    <i class="fas fa-phone" style="margin-right: 8px; color: #667eea;"></i>input3
                                </label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="customAlertPhoneComm" class="company-name-input"
                                        placeholder="e.g., Phone communication" style="flex: 1;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer; white-space: nowrap;">
                                        <input type="checkbox" id="activeInput3" checked
                                            style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 13px; color: #667eea; font-weight: 600;">Active</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label
                                    style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                    <i class="fas fa-tint" style="margin-right: 8px; color: #667eea;"></i>input4
                                </label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="customAlertPitFlooded" class="company-name-input"
                                        placeholder="e.g., Flooded pit" style="flex: 1;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer; white-space: nowrap;">
                                        <input type="checkbox" id="activeInput4" checked
                                            style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 13px; color: #667eea; font-weight: 600;">Active</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label
                                    style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                    <i class="fas fa-building" style="margin-right: 8px; color: #667eea;"></i>input5
                                </label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="customAlertAtFloor" class="company-name-input"
                                        placeholder="e.g., At floor" style="flex: 1;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer; white-space: nowrap;">
                                        <input type="checkbox" id="activeInput5" checked
                                            style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 13px; color: #667eea; font-weight: 600;">Active</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label
                                    style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                    <i class="fas fa-arrows-alt" style="margin-right: 8px; color: #667eea;"></i>input6
                                </label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="customAlertMoving" class="company-name-input"
                                        placeholder="e.g., Moving" style="flex: 1;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer; white-space: nowrap;">
                                        <input type="checkbox" id="activeInput6" checked
                                            style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 13px; color: #667eea; font-weight: 600;">Active</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label
                                    style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                    <i class="fas fa-times-circle" style="margin-right: 8px; color: #667eea;"></i>Status False
                                </label>
                                <input type="text" id="customAlertStatusFalse" class="company-name-input"
                                    placeholder="e.g., NORMAL" style="flex: 1;">
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label
                                    style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                    <i class="fas fa-check-circle" style="margin-right: 8px; color: #667eea;"></i>Status True
                                </label>
                                <input type="text" id="customAlertStatusTrue" class="company-name-input"
                                    placeholder="e.g., ALERTA" style="flex: 1;">
                            </div>
                        </div>
                        <button onclick="saveCustomAlertNames(event)" class="update-btn"
                            style="width: 100%; padding: 12px; font-size: 14px; margin-top: 10px;">
                            <i class="fas fa-save" style="margin-right: 8px;"></i>Save Custom Names
                        </button>
                        <p id="customAlertMsg"
                            style="margin: 10px 0 0 0; color: #27ae60; font-size: 14px; display: none;"></p>
                    </div>
                </div>

                <div id="buildingsList" style="max-height: 700px; overflow-y: auto; padding-right: 10px;"
                    class="custom-scrollbar">
                    <!-- Buildings will be loaded dynamically here -->
                </div>
            </div>
        </div>

        <div class="company-data-section" id="supportSection" style="display: none;">
            <div class="header">
                <h1>Support</h1>
            </div>
            <div style="padding: 40px;">
                <div class="section-header">
                    <h2>Support IDs Management</h2>
                </div>

                <!-- Form to add Support ID -->
                <div
                    style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); margin-bottom: 30px;">
                    <h3 style="font-size: 20px; color: #1a1a2e; margin: 0 0 20px 0;">
                        Add Support ID
                    </h3>
                    <form id="supportIdForm" onsubmit="addSupportId(event)">
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">
                                    ID de Soporte
                                </label>
                                <input type="text" id="supportIdInput" required
                                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                                    placeholder="Enter Support ID">
                            </div>
                            <button type="submit"
                                style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                Add
                            </button>
                        </div>
                        <p id="supportMsg" style="margin: 10px 0 0 0; color: #27ae60; font-size: 14px; display: none;"></p>
                    </form>
                </div>

                <!-- List of Support IDs -->
                <div
                    style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">
                    <h3 style="font-size: 20px; color: #1a1a2e; margin: 0 0 20px 0;">
                        Support IDs List
                    </h3>
                    <div id="supportList" style="max-height: 600px; overflow-y: auto; padding-right: 10px;"
                        class="custom-scrollbar">
                        <!-- Support IDs will be loaded dynamically here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="company-data-section" id="notificationsSection" style="display: none;">
            <div class="header">
                <h1>Send Notifications</h1>
            </div>
            <div style="padding: 40px;">
                <div class="section-header">
                    <h2>Send Notifications to Users</h2>
                </div>
                <div
                    style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">
                    <h3 style="font-size: 20px; color: #1a1a2e; margin-bottom: 25px;">
                        <i class="fas fa-paper-plane" style="margin-right: 8px; color: #667eea;"></i>Send Custom Email
                    </h3>

                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                        <div class="input-card">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-envelope" style="margin-right: 8px; color: #667eea;"></i>
                                Email Subject
                            </label>
                            <input type="text" id="customEmailSubject" class="company-name-input"
                                placeholder="Enter email subject" style="width: 100%;">
                        </div>

                        <div class="input-card">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-align-left" style="margin-right: 8px; color: #667eea;"></i>
                                Email Message
                            </label>
                            <textarea id="customEmailMessage" class="company-name-input"
                                placeholder="Enter your message here..."
                                style="width: 100%; min-height: 150px; resize: vertical; font-family: inherit;"></textarea>
                        </div>

                        <div class="input-card">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-image" style="margin-right: 8px; color: #667eea;"></i>
                                Attach Image
                            </label>
                            <input type="file" id="customEmailImage" accept="image/*" class="company-name-input"
                                style="width: 100%; padding: 12px; cursor: pointer;">
                            <div id="customEmailImagePreview" style="margin-top: 10px; display: none;">
                                <img id="customEmailPreviewImg" src="" alt="Preview"
                                    style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #ccc;">
                                <button type="button" id="removeCustomEmailImageBtn"
                                    style="margin-top: 5px; padding: 5px 10px; background: #ef5350; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Remove
                                    Image</button>
                            </div>
                            <p style="color: #888; font-size: 12px; margin-top: 5px;">Select an image to attach to the
                                email</p>
                        </div>

                        <div class="input-card">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-users" style="margin-right: 8px; color: #667eea;"></i>
                                Select Recipients
                            </label>
                            <div style="margin-bottom: 15px;">
                                <label
                                    style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer;">
                                    <input type="radio" name="recipients" value="all" checked
                                        style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px; color: #1a1a2e;">Send to all clients</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="radio" name="recipients" value="selected"
                                        style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 14px; color: #1a1a2e;">Select specific clients</span>
                                </label>
                            </div>
                            <button type="button" id="openClientModal" onclick="openClientModal()"
                                class="company-name-input"
                                style="display: none; width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; color: #1a1a2e; font-size: 14px; cursor: pointer; text-align: left;">
                                <i class="fas fa-users" style="margin-right: 8px;"></i>Select clients
                            </button>
                        </div>
                    </div>

                    <div id="customEmailMsg"
                        style="margin-top: 20px; padding: 12px; border-radius: 8px; display: none; font-size: 14px;">
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 25px; justify-content: flex-end;">
                        <button class="update-btn" onclick="resetCustomEmailForm()"
                            style="background: #ef5350; min-width: 120px;">
                            Cancel
                        </button>
                        <button class="update-btn" id="sendCustomEmailBtn" onclick="sendCustomEmail()"
                            style="min-width: 150px;">
                            <i class="fas fa-paper-plane" style="margin-right: 8px;"></i>Send Email
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="company-data-section" id="usersSection" style="display: none;">
            <div class="header">
                <h1>Users</h1>
            </div>
            <div style="padding: 40px;">
                <div class="section-header">
                    <h2>Users Management</h2>
                    <button class="update-btn" onclick="toggleAddUserForm()" style="min-width: 150px;">
                        <i class="fas fa-plus" style="margin-right: 8px;"></i>Add User
                    </button>
                </div>

                <div id="addUserForm"
                    style="display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); margin-bottom: 30px;">
                    <h3 style="font-size: 20px; color: #1a1a2e; margin-bottom: 20px;">
                        <i class="fas fa-user-plus" style="margin-right: 8px; color: #667eea;"></i>Add New User
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div class="input-card">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-envelope" style="margin-right: 8px; color: #667eea;"></i>
                                Email
                            </label>
                            <input type="email" id="userEmailInput" class="company-name-input" placeholder="Enter email"
                                style="width: 100%;" required>
                        </div>

                        <div class="input-card">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-lock" style="margin-right: 8px; color: #667eea;"></i>
                                Password
                            </label>
                            <input type="password" id="userPasswordInput" class="company-name-input"
                                placeholder="Enter password" style="width: 100%;" required>
                        </div>

                        <div class="input-card" style="grid-column: span 2;">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-user-tag" style="margin-right: 8px; color: #667eea;"></i>
                                Role Type
                            </label>
                            <select id="userRoleInput" class="company-name-input"
                                style="width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; color: #1a1a2e; font-size: 14px; cursor: pointer;"
                                required>
                                <option value="">Select role type</option>
                                <option value="client">Client</option>
                                <option value="technician">Technician</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                        <button type="button" class="update-btn" onclick="toggleAddUserForm()"
                            style="background: #ef5350; min-width: 100px;">
                            Cancel
                        </button>
                        <button type="button" class="update-btn" onclick="saveUser(event)" style="min-width: 100px;">
                            <i class="fas fa-save" style="margin-right: 8px;"></i>Save User
                        </button>
                    </div>
                </div>

                <div id="usersListContainer"
                    style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">
                    <div id="usersList" style="max-height: 600px; overflow-y: auto; min-height: 100px;">
                        <!-- Users will be loaded dynamically here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="company-data-section" id="companyDataSection" style="display: none;">
            <div class="header">
                <button onclick="openColorPickerModal()" id="colorPickerBtn"
                    style="position: absolute; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">
                    <i class="fas fa-palette"></i>
                    Color Picker
                </button>
                <h1>Company Data</h1>
            </div>
            <div style="padding: 40px;">
                <div class="section-header">
                    <h2>Company Data</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-bottom: 40px;">
                    <div class="input-card">
                        <label
                            style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-building" style="margin-right: 8px; color: #667eea;"></i>
                            Company Name
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="companyNameInput" class="company-name-input"
                                placeholder="Enter company name" style="flex: 1;">
                            <button class="update-btn" onclick="updateCompanyData('companyName', event)"
                                style="min-width: 100px;">Update</button>
                        </div>
                    </div>

                    <div class="input-card">
                        <label
                            style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-image" style="margin-right: 8px; color: #667eea;"></i>
                            Logo
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="logoInput" class="company-name-input"
                                placeholder="Enter logo (icon class or emoji)" style="flex: 1;">
                            <button class="update-btn" onclick="updateCompanyData('logo', event)"
                                style="min-width: 100px;">Update</button>
                        </div>
                    </div>

                    <div class="input-card">
                        <label
                            style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-envelope" style="margin-right: 8px; color: #667eea;"></i>
                            Admin Alert Email
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="email" id="adminEmailInput" class="company-name-input"
                                placeholder="Enter admin email" style="flex: 1;">
                            <button class="update-btn" onclick="updateCompanyData('adminEmail', event)"
                                style="min-width: 100px;">Update</button>
                        </div>
                    </div>

                    <div class="input-card">
                        <label
                            style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-clock" style="margin-right: 8px; color: #667eea;"></i>
                            Timezone
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="timezoneInput" class="company-name-input"
                                placeholder="Enter timezone" style="flex: 1;">
                            <button class="update-btn" onclick="updateCompanyData('timezone', event)"
                                style="min-width: 100px;">Update</button>
                        </div>
                    </div>

                    <div class="input-card" style="grid-column: span 2;">
                        <label
                            style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-signature" style="margin-right: 8px; color: #667eea;"></i>
                            Signature Image URL
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="signatureUrlInput" class="company-name-input"
                                placeholder="Enter signature image URL" style="flex: 1;">
                            <button class="update-btn" onclick="updateCompanyData('signatureUrl', event)"
                                style="min-width: 100px;">Update</button>
                        </div>
                    </div>
                </div>

                <!-- Email Configuration Section - Alerta -->
                <div style="margin-top: 40px;">
                    <div class="section-header" style="margin-bottom: 25px;">
                        <h2>Alert Email Configuration</h2>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px;">
                        <div class="input-card" style="grid-column: span 2;">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-heading" style="margin-right: 8px; color: #667eea;"></i>
                                Email Title
                            </label>
                            <input type="text" id="emailTitleAlertaInput" class="company-name-input"
                                placeholder="Enter email title" style="width: 100%;">
                        </div>

                        <div class="input-card" style="grid-column: span 2;">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-envelope-open-text" style="margin-right: 8px; color: #667eea;"></i>
                                Email Message
                            </label>
                            <textarea id="emailMessageAlertaInput" class="company-name-input"
                                placeholder="Enter email message" style="width: 100%; min-height: 80px; resize: vertical;"></textarea>
                        </div>

                        <div class="input-card" style="grid-column: span 2;">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-ban" style="margin-right: 8px; color: #667eea;"></i>
                                Ignore Message
                            </label>
                            <textarea id="ignoreMessageAlertaInput" class="company-name-input"
                                placeholder="Enter ignore message" style="width: 100%; min-height: 80px; resize: vertical;"></textarea>
                        </div>

                        <div class="input-card" style="grid-column: span 2;">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-comment-dots" style="margin-right: 8px; color: #667eea;"></i>
                                Bottom Message
                            </label>
                            <textarea id="bottomMessageAlertaInput" class="company-name-input"
                                placeholder="Enter bottom message" style="width: 100%; min-height: 80px; resize: vertical;"></textarea>
                        </div>

                        <div class="input-card" style="grid-column: span 2;">
                            <button class="update-btn" onclick="updateEmailConfig('alerta', event)"
                                style="width: 100%; padding: 12px; font-size: 16px;">
                                <i class="fas fa-save" style="margin-right: 8px;"></i>
                                Save Alert Email Configuration
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Email Configuration Section - Resuelto -->
                <div style="margin-top: 40px;">
                    <div class="section-header" style="margin-bottom: 25px;">
                        <h2>Resolved Email Configuration</h2>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px;">
                        <div class="input-card" style="grid-column: span 2;">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-heading" style="margin-right: 8px; color: #667eea;"></i>
                                Email Title
                            </label>
                            <input type="text" id="emailTitleResueltoInput" class="company-name-input"
                                placeholder="Enter email title" style="width: 100%;">
                        </div>

                        <div class="input-card" style="grid-column: span 2;">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-envelope-open-text" style="margin-right: 8px; color: #667eea;"></i>
                                Email Message
                            </label>
                            <textarea id="emailMessageResueltoInput" class="company-name-input"
                                placeholder="Enter email message" style="width: 100%; min-height: 80px; resize: vertical;"></textarea>
                        </div>

                        <div class="input-card" style="grid-column: span 2;">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-ban" style="margin-right: 8px; color: #667eea;"></i>
                                Ignore Message
                            </label>
                            <textarea id="ignoreMessageResueltoInput" class="company-name-input"
                                placeholder="Enter ignore message" style="width: 100%; min-height: 80px; resize: vertical;"></textarea>
                        </div>

                        <div class="input-card" style="grid-column: span 2;">
                            <label
                                style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                                <i class="fas fa-comment-dots" style="margin-right: 8px; color: #667eea;"></i>
                                Bottom Message
                            </label>
                            <textarea id="bottomMessageResueltoInput" class="company-name-input"
                                placeholder="Enter bottom message" style="width: 100%; min-height: 80px; resize: vertical;"></textarea>
                        </div>

                        <div class="input-card" style="grid-column: span 2;">
                            <button class="update-btn" onclick="updateEmailConfig('resuelto', event)"
                                style="width: 100%; padding: 12px; font-size: 16px;">
                                <i class="fas fa-save" style="margin-right: 8px;"></i>
                                Save Resolved Email Configuration
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function toggleCompanyData(event) {
                event.preventDefault();
                const mainContent = document.getElementById('mainContent');
                const companySection = document.getElementById('companyDataSection');
                const usersSection = document.getElementById('usersSection');
                const notificationsSection = document.getElementById('notificationsSection');
                const devicesSection = document.getElementById('devicesSection');
                const reportsSection = document.getElementById('reportsSection');
                const buildingsSection = document.getElementById('buildingsSection');
                const supportSection = document.getElementById('supportSection');
                const rightSidebar = document.getElementById('rightSidebar');
                const dashboardMenuItem = document.getElementById('dashboardMenuItem');
                const companyDataMenuItem = document.getElementById('companyDataMenuItem');
                const usersMenuItem = document.getElementById('usersMenuItem');
                const notificationsMenuItem = document.getElementById('notificationsMenuItem');
                const devicesMenuItem = document.getElementById('devicesMenuItem');
                const reportsMenuItem = document.getElementById('reportsMenuItem');
                const buildingsMenuItem = document.getElementById('buildingsMenuItem');
                const supportMenuItem = document.getElementById('supportMenuItem');

                if (companySection.style.display === 'none') {
                    mainContent.style.display = 'none';
                    rightSidebar.style.display = 'none';
                    usersSection.style.display = 'none';
                    notificationsSection.style.display = 'none';
                    devicesSection.style.display = 'none';
                    reportsSection.style.display = 'none';
                    buildingsSection.style.display = 'none';
                if (supportSection) supportSection.style.display = 'none';
                    companySection.style.display = 'block';
                    dashboardMenuItem.classList.remove('active');
                    companyDataMenuItem.classList.add('active');
                    usersMenuItem.classList.remove('active');
                    notificationsMenuItem.classList.remove('active');
                    devicesMenuItem.classList.remove('active');
                    reportsMenuItem.classList.remove('active');
                    buildingsMenuItem.classList.remove('active');
                if (supportMenuItem) supportMenuItem.classList.remove('active');
                    // Load company data when section is opened
                    loadCompanyData();
                    // Load email configuration when section is opened
                    loadEmailConfig();
                } else {
                    mainContent.style.display = 'block';
                    rightSidebar.style.display = 'flex';
                    companySection.style.display = 'none';
                    usersSection.style.display = 'none';
                    notificationsSection.style.display = 'none';
                    devicesSection.style.display = 'none';
                    reportsSection.style.display = 'none';
                    buildingsSection.style.display = 'none';
                if (supportSection) supportSection.style.display = 'none';
                    dashboardMenuItem.classList.add('active');
                    companyDataMenuItem.classList.remove('active');
                    usersMenuItem.classList.remove('active');
                    notificationsMenuItem.classList.remove('active');
                    devicesMenuItem.classList.remove('active');
                    reportsMenuItem.classList.remove('active');
                    buildingsMenuItem.classList.remove('active');
                if (supportMenuItem) supportMenuItem.classList.remove('active');
                }
            }

            function showDashboard(event) {
                event.preventDefault();
                const mainContent = document.getElementById('mainContent');
                const companySection = document.getElementById('companyDataSection');
                const usersSection = document.getElementById('usersSection');
                const notificationsSection = document.getElementById('notificationsSection');
                const devicesSection = document.getElementById('devicesSection');
                const reportsSection = document.getElementById('reportsSection');
                const buildingsSection = document.getElementById('buildingsSection');
                const supportSection = document.getElementById('supportSection');
                const rightSidebar = document.getElementById('rightSidebar');
                const dashboardMenuItem = document.getElementById('dashboardMenuItem');
                const companyDataMenuItem = document.getElementById('companyDataMenuItem');
                const usersMenuItem = document.getElementById('usersMenuItem');
                const notificationsMenuItem = document.getElementById('notificationsMenuItem');
                const devicesMenuItem = document.getElementById('devicesMenuItem');
                const reportsMenuItem = document.getElementById('reportsMenuItem');
                const buildingsMenuItem = document.getElementById('buildingsMenuItem');
                const supportMenuItem = document.getElementById('supportMenuItem');

                mainContent.style.display = 'block';
                rightSidebar.style.display = 'flex';
                companySection.style.display = 'none';
                usersSection.style.display = 'none';
                notificationsSection.style.display = 'none';
                devicesSection.style.display = 'none';
                reportsSection.style.display = 'none';
                buildingsSection.style.display = 'none';
                if (supportSection) supportSection.style.display = 'none';
                dashboardMenuItem.classList.add('active');
                companyDataMenuItem.classList.remove('active');
                usersMenuItem.classList.remove('active');
                notificationsMenuItem.classList.remove('active');
                devicesMenuItem.classList.remove('active');
                reportsMenuItem.classList.remove('active');
                buildingsMenuItem.classList.remove('active');
                if (supportMenuItem) supportMenuItem.classList.remove('active');

                // Show loading screen when entering dashboard
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'flex';
                    loadingScreen.classList.remove('hidden');
                }

                // Load cached company name for loading screen (from inline script or localStorage)
                const cachedCompanyName = window._cachedCompanyName || (() => {
                    try {
                        const cachedData = localStorage.getItem('dashboard_companyData');
                        if (cachedData) {
                            const data = JSON.parse(cachedData);
                            return data.companyName;
                        }
                    } catch (e) {
                        console.error('Error parsing cached company name:', e);
                    }
                    return null;
                })();

                if (cachedCompanyName) {
                    updateLoadingLogoText(cachedCompanyName);
                }

                // Load company data to update logo and other display elements (with cache fallback)
                loadCompanyData(true);
                // Load random users for dashboard (with cache fallback)
                loadRandomUsers(true);
                // Load recent activity (with cache fallback)
                loadRecentActivity(true);

                // Hide loading screen after data is loaded
                setTimeout(() => {
                    hideLoadingScreen();
                }, 1500);

                // Update data after 5 seconds
                setTimeout(() => {
                    loadCompanyData(false);
                    loadRandomUsers(false);
                    loadRecentActivity(false);
                }, 5000);
            }

            function showUsers(event) {
                event.preventDefault();
                const mainContent = document.getElementById('mainContent');
                const companySection = document.getElementById('companyDataSection');
                const usersSection = document.getElementById('usersSection');
                const notificationsSection = document.getElementById('notificationsSection');
                const devicesSection = document.getElementById('devicesSection');
                const reportsSection = document.getElementById('reportsSection');
                const buildingsSection = document.getElementById('buildingsSection');
                const supportSection = document.getElementById('supportSection');
                const rightSidebar = document.getElementById('rightSidebar');
                const dashboardMenuItem = document.getElementById('dashboardMenuItem');
                const companyDataMenuItem = document.getElementById('companyDataMenuItem');
                const usersMenuItem = document.getElementById('usersMenuItem');
                const notificationsMenuItem = document.getElementById('notificationsMenuItem');
                const devicesMenuItem = document.getElementById('devicesMenuItem');
                const reportsMenuItem = document.getElementById('reportsMenuItem');
                const buildingsMenuItem = document.getElementById('buildingsMenuItem');
                const supportMenuItem = document.getElementById('supportMenuItem');

                mainContent.style.display = 'none';
                rightSidebar.style.display = 'none';
                companySection.style.display = 'none';
                notificationsSection.style.display = 'none';
                devicesSection.style.display = 'none';
                reportsSection.style.display = 'none';
                buildingsSection.style.display = 'none';
                if (supportSection) supportSection.style.display = 'none';
                usersSection.style.display = 'block';
                dashboardMenuItem.classList.remove('active');
                companyDataMenuItem.classList.remove('active');
                usersMenuItem.classList.add('active');
                notificationsMenuItem.classList.remove('active');
                devicesMenuItem.classList.remove('active');
                reportsMenuItem.classList.remove('active');
                buildingsMenuItem.classList.remove('active');
                if (supportMenuItem) supportMenuItem.classList.remove('active');
                // Load users when section is opened
                loadUsers();
            }

            function showNotifications(event) {
                event.preventDefault();
                const mainContent = document.getElementById('mainContent');
                const companySection = document.getElementById('companyDataSection');
                const usersSection = document.getElementById('usersSection');
                const notificationsSection = document.getElementById('notificationsSection');
                const devicesSection = document.getElementById('devicesSection');
                const reportsSection = document.getElementById('reportsSection');
                const buildingsSection = document.getElementById('buildingsSection');
                const supportSection = document.getElementById('supportSection');
                const rightSidebar = document.getElementById('rightSidebar');
                const dashboardMenuItem = document.getElementById('dashboardMenuItem');
                const companyDataMenuItem = document.getElementById('companyDataMenuItem');
                const usersMenuItem = document.getElementById('usersMenuItem');
                const notificationsMenuItem = document.getElementById('notificationsMenuItem');
                const devicesMenuItem = document.getElementById('devicesMenuItem');
                const reportsMenuItem = document.getElementById('reportsMenuItem');
                const buildingsMenuItem = document.getElementById('buildingsMenuItem');
                const supportMenuItem = document.getElementById('supportMenuItem');

                mainContent.style.display = 'none';
                rightSidebar.style.display = 'none';
                companySection.style.display = 'none';
                usersSection.style.display = 'none';
                devicesSection.style.display = 'none';
                reportsSection.style.display = 'none';
                buildingsSection.style.display = 'none';
                if (supportSection) supportSection.style.display = 'none';
                notificationsSection.style.display = 'block';
                dashboardMenuItem.classList.remove('active');
                companyDataMenuItem.classList.remove('active');
                usersMenuItem.classList.remove('active');
                devicesMenuItem.classList.remove('active');
                reportsMenuItem.classList.remove('active');
                buildingsMenuItem.classList.remove('active');
                if (supportMenuItem) supportMenuItem.classList.remove('active');
                notificationsMenuItem.classList.add('active');
            }

            function showDevices(event) {
                event.preventDefault();
                const mainContent = document.getElementById('mainContent');
                const companySection = document.getElementById('companyDataSection');
                const usersSection = document.getElementById('usersSection');
                const notificationsSection = document.getElementById('notificationsSection');
                const devicesSection = document.getElementById('devicesSection');
                const reportsSection = document.getElementById('reportsSection');
                const buildingsSection = document.getElementById('buildingsSection');
                const supportSection = document.getElementById('supportSection');
                const rightSidebar = document.getElementById('rightSidebar');
                const dashboardMenuItem = document.getElementById('dashboardMenuItem');
                const companyDataMenuItem = document.getElementById('companyDataMenuItem');
                const usersMenuItem = document.getElementById('usersMenuItem');
                const notificationsMenuItem = document.getElementById('notificationsMenuItem');
                const devicesMenuItem = document.getElementById('devicesMenuItem');
                const reportsMenuItem = document.getElementById('reportsMenuItem');
                const buildingsMenuItem = document.getElementById('buildingsMenuItem');
                const supportMenuItem = document.getElementById('supportMenuItem');

                mainContent.style.display = 'none';
                rightSidebar.style.display = 'none';
                companySection.style.display = 'none';
                usersSection.style.display = 'none';
                notificationsSection.style.display = 'none';
                reportsSection.style.display = 'none';
                buildingsSection.style.display = 'none';
                if (supportSection) supportSection.style.display = 'none';
                devicesSection.style.display = 'block';
                dashboardMenuItem.classList.remove('active');
                companyDataMenuItem.classList.remove('active');
                usersMenuItem.classList.remove('active');
                notificationsMenuItem.classList.remove('active');
                reportsMenuItem.classList.remove('active');
                buildingsMenuItem.classList.remove('active');
                if (supportMenuItem) supportMenuItem.classList.remove('active');
                devicesMenuItem.classList.add('active');
                // Load devices when section is opened
                loadDevices();
            }

            function showBuildings(event) {
                event.preventDefault();
                const mainContent = document.getElementById('mainContent');
                const companySection = document.getElementById('companyDataSection');
                const usersSection = document.getElementById('usersSection');
                const notificationsSection = document.getElementById('notificationsSection');
                const devicesSection = document.getElementById('devicesSection');
                const reportsSection = document.getElementById('reportsSection');
                const buildingsSection = document.getElementById('buildingsSection');
                const supportSection = document.getElementById('supportSection');
                const rightSidebar = document.getElementById('rightSidebar');
                const dashboardMenuItem = document.getElementById('dashboardMenuItem');
                const companyDataMenuItem = document.getElementById('companyDataMenuItem');
                const usersMenuItem = document.getElementById('usersMenuItem');
                const notificationsMenuItem = document.getElementById('notificationsMenuItem');
                const devicesMenuItem = document.getElementById('devicesMenuItem');
                const reportsMenuItem = document.getElementById('reportsMenuItem');
                const buildingsMenuItem = document.getElementById('buildingsMenuItem');
                const supportMenuItem = document.getElementById('supportMenuItem');

                mainContent.style.display = 'none';
                rightSidebar.style.display = 'none';
                companySection.style.display = 'none';
                usersSection.style.display = 'none';
                notificationsSection.style.display = 'none';
                devicesSection.style.display = 'none';
                reportsSection.style.display = 'none';
                buildingsSection.style.display = 'block';
                if (supportSection) supportSection.style.display = 'none';
                dashboardMenuItem.classList.remove('active');
                companyDataMenuItem.classList.remove('active');
                usersMenuItem.classList.remove('active');
                notificationsMenuItem.classList.remove('active');
                devicesMenuItem.classList.remove('active');
                reportsMenuItem.classList.remove('active');
                buildingsMenuItem.classList.add('active');
                if (supportMenuItem) supportMenuItem.classList.remove('active');
                // Load buildings when section is opened
                loadBuildings();
                // Load custom alerts list when section is opened
                loadCustomAlerts();
            }

            function showSupport(event) {
                event.preventDefault();
                const mainContent = document.getElementById('mainContent');
                const companySection = document.getElementById('companyDataSection');
                const usersSection = document.getElementById('usersSection');
                const notificationsSection = document.getElementById('notificationsSection');
                const devicesSection = document.getElementById('devicesSection');
                const reportsSection = document.getElementById('reportsSection');
                const buildingsSection = document.getElementById('buildingsSection');
                const supportSection = document.getElementById('supportSection');
                const rightSidebar = document.getElementById('rightSidebar');
                const dashboardMenuItem = document.getElementById('dashboardMenuItem');
                const companyDataMenuItem = document.getElementById('companyDataMenuItem');
                const usersMenuItem = document.getElementById('usersMenuItem');
                const notificationsMenuItem = document.getElementById('notificationsMenuItem');
                const devicesMenuItem = document.getElementById('devicesMenuItem');
                const reportsMenuItem = document.getElementById('reportsMenuItem');
                const buildingsMenuItem = document.getElementById('buildingsMenuItem');
                const supportMenuItem = document.getElementById('supportMenuItem');

                mainContent.style.display = 'none';
                rightSidebar.style.display = 'none';
                companySection.style.display = 'none';
                usersSection.style.display = 'none';
                notificationsSection.style.display = 'none';
                devicesSection.style.display = 'none';
                reportsSection.style.display = 'none';
                buildingsSection.style.display = 'none';
                if (supportSection) supportSection.style.display = 'none';
                if (supportSection) supportSection.style.display = 'block';
                dashboardMenuItem.classList.remove('active');
                companyDataMenuItem.classList.remove('active');
                usersMenuItem.classList.remove('active');
                notificationsMenuItem.classList.remove('active');
                devicesMenuItem.classList.remove('active');
                reportsMenuItem.classList.remove('active');
                buildingsMenuItem.classList.remove('active');
                if (supportMenuItem) supportMenuItem.classList.remove('active');
                if (supportMenuItem) supportMenuItem.classList.add('active');
                // Load support IDs when section is opened
                loadSupportIds();
            }

            function toggleAddDeviceForm() {
                const form = document.getElementById('addDeviceForm');
                if (form.style.display === 'none') {
                    form.style.display = 'block';
                } else {
                    form.style.display = 'none';
                }
            }

            function toggleAddUserForm() {
                const form = document.getElementById('addUserForm');
                if (form.style.display === 'none') {
                    form.style.display = 'block';
                } else {
                    form.style.display = 'none';
                }
            }

            function toggleAddDeviceForm() {
                const form = document.getElementById('addDeviceFormContainer');
                if (form.style.display === 'none') {
                    form.style.display = 'block';
                } else {
                    form.style.display = 'none';
                    clearDeviceForm();
                }
            }

            function toggleClient(element, email) {
                const checkIcon = element.querySelector('.fa-check');
                const placeholder = element.querySelector('span');

                if (checkIcon.style.display === 'none') {
                    checkIcon.style.display = 'inline-block';
                    placeholder.style.display = 'none';
                    element.style.background = '#f0f4ff';
                    element.setAttribute('data-selected', 'true');
                } else {
                    checkIcon.style.display = 'none';
                    placeholder.style.display = 'block';
                    element.style.background = 'white';
                    element.removeAttribute('data-selected');
                }
            }

            // Toggle client selection based on radio button
            document.addEventListener('DOMContentLoaded', function () {
                const radioButtons = document.querySelectorAll('input[name="recipients"]');
                const openClientModal = document.getElementById('openClientModal');

                radioButtons.forEach(radio => {
                    radio.addEventListener('change', function () {
                        if (this.value === 'selected') {
                            openClientModal.style.display = 'block';
                        } else {
                            openClientModal.style.display = 'none';
                        }
                    });
                });
            });

            // Function to open WhatsApp with encoded message
            function openWhatsApp() {
                const numero = '57326695';
                // Use WhatsApp API format: https://api.whatsapp.com/send
                // This format handles emojis better than wa.me
                const mensaje = 'Hello! ðŸ”‘ I want to activate my professional plan ðŸ“¡ to access all premium features âœ… Could you help me with the process? âš™ï¸';
                const url = 'https://api.whatsapp.com/send?phone=' + numero + '&text=' + encodeURIComponent(mensaje);
                window.open(url, '_blank');
            }

            // Function to check plan status
            async function checkPlanStatus() {
                try {
                    const response = await fetch(PLAN_STATUS_API);
                    const result = await response.json();

                    console.log('API Response:', result);

                    if (result.success && result.data && result.data.length > 0) {
                        const planData = result.data[0];

                        console.log('Plan Data from API:', planData);
                        console.log('All keys in planData:', Object.keys(planData));

                        // Get plan name (check multiple possible field names)
                        const planName = (planData.planes || planData.plan || planData.planName || 'Normal').toString();
                        const planNameLower = planName.toLowerCase().trim();

                        // Check if plan contains "professional" or "proffesional" (flexible spelling)
                        const isProfessional = planNameLower.includes('professional') || planNameLower.includes('proffesional');

                        // Get status (check multiple possible values: active, si, yes, true, 1)
                        const statusValue = (planData.status || planData.estado || 'inactive').toString().toLowerCase();
                        const isActive = statusValue === 'active' || statusValue === 'si' || statusValue === 'yes' || statusValue === 'true' || statusValue === '1' || statusValue === 'activo';

                        currentPlanStatus = {
                            plan: planNameLower,
                            status: isActive ? 'active' : 'inactive',
                            originalPlan: planName,
                            originalStatus: statusValue,
                            isProfessional: isProfessional
                        };

                        console.log('Processed Plan Status:', currentPlanStatus);
                        console.log('Is Professional and Active?', isProfessional && isActive);

                        return currentPlanStatus;
                    }
                    console.log('No data found in API response');
                    return null;
                } catch (error) {
                    console.error('Error checking plan status:', error);
                    return null;
                }
            }

            // Function to update premium card based on plan status
            async function updatePremiumCard() {
                const planStatusText = document.getElementById('planStatusText');
                const planActivateButton = document.getElementById('planActivateButton');

                if (!planStatusText || !planActivateButton) return;

                const planStatus = await checkPlanStatus();

                if (planStatus && planStatus.isProfessional && planStatus.status === 'active') {
                    planStatusText.className = 'plan-status-badge active';
                    planStatusText.innerHTML = '<i class="fas fa-check-circle"></i><span>Professional Plan Active</span>';
                    planActivateButton.style.display = 'none';
                } else {
                    planStatusText.className = 'plan-status-badge inactive';
                    planStatusText.innerHTML = '<i class="fas fa-times-circle"></i><span>Professional Plan Inactive</span>';
                    planActivateButton.style.display = 'block';
                }
            }

            // Function to update download button based on plan
            async function updateDownloadButton() {
                const downloadBtn = document.querySelector('button[onclick="downloadAllUrls()"]');
                if (!downloadBtn) return;

                const planStatus = await checkPlanStatus();

                if (planStatus && planStatus.isProfessional && planStatus.status === 'active') {
                    downloadBtn.disabled = false;
                    downloadBtn.style.opacity = '1';
                    downloadBtn.style.cursor = 'pointer';
                    downloadBtn.title = '';
                } else {
                    downloadBtn.disabled = true;
                    downloadBtn.style.opacity = '0.5';
                    downloadBtn.style.cursor = 'not-allowed';
                    downloadBtn.title = 'Se requiere plan Professional activo para descargar URLs';
                }
            }

            // Function to download all URLs as TXT file
            async function downloadAllUrls() {
                // Check plan status first
                const planStatus = await checkPlanStatus();

                console.log('Download check - Plan Status:', planStatus);
                console.log('Is Professional?', planStatus?.isProfessional);
                console.log('Is Active?', planStatus?.status === 'active');

                if (!planStatus || !planStatus.isProfessional || planStatus.status !== 'active') {
                    console.log('Showing plan required modal');
                    showPlanRequiredModal();
                    return;
                }

                const usedUrls = getUsedUrls();

                if (usedUrls.length === 0) {
                    alert('No hay URLs para descargar');
                    return;
                }

                // Create text content with all URLs
                let textContent = 'Implementation URLs\n';
                textContent += '=======================\n\n';

                usedUrls.forEach((url, index) => {
                    textContent += `URL ${index + 1}:\n${url}\n\n`;
                });

                // Create blob and download
                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `urls_implementacion_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // API URL for implementation URLs
            const IMPLEMENTATION_URLS_API = 'https://script.google.com/macros/s/AKfycbwpaMnp13WbGz4tT403HhdGbaGZ2-BggokASYOdGpmi4trVqBIXGz1P1TaXWZKvufhq/exec';

            // API URL for plan status
            const PLAN_STATUS_API = 'https://script.google.com/macros/s/AKfycby4R7LUw3Qiw0LM790h05aMd86xLXgp7xaorKwm4LVgFdWXgo-cOj8BePtpRpkf3PeSuw/exec';

            // Global variable for plan status
            let currentPlanStatus = null;

            // Function to get used URLs from localStorage
            function getUsedUrls() {
                try {
                    const used = localStorage.getItem('usedImplementationUrls');
                    return used ? JSON.parse(used) : [];
                } catch (e) {
                    return [];
                }
            }

            // Function to mark URL as used
            function markUrlAsUsed(url) {
                try {
                    const used = getUsedUrls();
                    if (!used.includes(url)) {
                        used.push(url);
                        localStorage.setItem('usedImplementationUrls', JSON.stringify(used));
                    }
                } catch (e) {
                    console.error('Error marking URL as used:', e);
                }
            }

            // Function to render implemented URLs list
            function renderImplementedUrlsList() {
                const listContainer = document.getElementById('implementedUrlsList');
                if (!listContainer) return;

                const usedUrls = getUsedUrls();

                if (usedUrls.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; color: #999; font-size: 13px; padding: 20px;">No URLs implemented yet</p>';
                    return;
                }

                listContainer.innerHTML = usedUrls.map((url, index) => {
                    return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 12px; font-weight: 600; color: #667eea; margin-bottom: 4px;">URL ${index + 1}</div>
                            <div style="font-size: 11px; color: #666; word-break: break-all;">${url}</div>
                        </div>
                        <button onclick="copyUrlFromList('${url}')" style="padding: 6px 10px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; transition: all 0.3s; flex-shrink: 0;" title="Copiar URL">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                `;
                }).join('');
            }

            // Function to show plan required modal
            function showPlanRequiredModal() {
                const modal = document.getElementById('planRequiredModal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            }

            // Function to close plan required modal
            function closePlanRequiredModal() {
                const modal = document.getElementById('planRequiredModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // Function to show limit modal
            function showLimitModal() {
                const modal = document.getElementById('limitModal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            }

            // Function to close limit modal
            function closeLimitModal() {
                const modal = document.getElementById('limitModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // Function to copy URL from list
            function copyUrlFromList(url) {
                navigator.clipboard.writeText(url).then(() => {
                    // Show feedback
                    const button = event.target.closest('button');
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i>';
                    button.style.background = '#22c55e';
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.style.background = '#667eea';
                    }, 2000);
                }).catch(err => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);

                    // Show feedback
                    const button = event.target.closest('button');
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i>';
                    button.style.background = '#22c55e';
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.style.background = '#667eea';
                    }, 2000);
                });
            }

            // Function to generate new implementation URL
            async function generateNewImplementationUrl() {
                // Show loading state with button
                const generateBtn = event.target.closest('button');
                const originalBtnText = generateBtn.innerHTML;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Generating...';
                generateBtn.disabled = true;

                try {
                    // Fetch available URLs from API
                    const response = await fetch(IMPLEMENTATION_URLS_API);
                    const result = await response.json();

                    if (!result.success || !result.data || !Array.isArray(result.data)) {
                        throw new Error('Error getting URLs from API');
                    }

                    // Get used URLs
                    const usedUrls = getUsedUrls();

                    // Find first unused URL
                    const availableUrls = result.data.filter(url => !usedUrls.includes(url));

                    if (availableUrls.length === 0) {
                        // No more URLs available
                        generateBtn.innerHTML = originalBtnText;
                        generateBtn.disabled = false;
                        showLimitModal();
                        return;
                    }

                    // Get first available URL
                    const newUrl = availableUrls[0];

                    // Mark as used
                    markUrlAsUsed(newUrl);

                    // Refresh the implemented URLs list
                    renderImplementedUrlsList();

                    // Reset button
                    generateBtn.innerHTML = originalBtnText;
                    generateBtn.disabled = false;

                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001; font-size: 14px;';
                    successMsg.innerHTML = '<i class="fas fa-check-circle" style="margin-right: 8px;"></i>URL generated successfully';
                    document.body.appendChild(successMsg);
                    setTimeout(() => {
                        successMsg.remove();
                    }, 3000);

                } catch (error) {
                    console.error('Error generating implementation URL:', error);
                    generateBtn.innerHTML = originalBtnText;
                    generateBtn.disabled = false;
                    alert('Error generating URL: ' + error.message);
                }
            }

            // Function to hide loading screen
            function hideLoadingScreen() {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 300);
                }
            }

            // Function to update loading screen logo text
            function updateLoadingLogoText(companyName) {
                if (!companyName) return;

                const loadingLogo = document.getElementById('loadingLogoText');
                if (loadingLogo) {
                    // Split company name - take first word before space as main, rest as highlight
                    const nameParts = companyName.split(' ');
                    if (nameParts.length > 1) {
                        const mainName = nameParts[0];
                        const highlightName = nameParts.slice(1).join(' ');
                        loadingLogo.innerHTML = `${mainName}<span class="highlight"> ${highlightName}</span>`;
                    } else {
                        loadingLogo.innerHTML = `${companyName}<span class="highlight"></span>`;
                    }
                }
            }

            // Set Dashboard as active on page load
            window.addEventListener('DOMContentLoaded', function () {
                // Load and render implemented URLs list
                renderImplementedUrlsList();
                // Check plan status and update download button and premium card
                updateDownloadButton();
                updatePremiumCard();
                // Load cached company name immediately for loading screen (from inline script or localStorage)
                const cachedCompanyName = window._cachedCompanyName || (() => {
                    try {
                        const cachedData = localStorage.getItem('dashboard_companyData');
                        if (cachedData) {
                            const data = JSON.parse(cachedData);
                            return data.companyName;
                        }
                    } catch (e) {
                        console.error('Error parsing cached company name:', e);
                    }
                    return null;
                })();

                if (cachedCompanyName) {
                    updateLoadingLogoText(cachedCompanyName);
                }

                document.getElementById('dashboardMenuItem').classList.add('active');

                // Load company data to update logo and other display elements (with cache fallback)
                loadCompanyData(true);
                // Load random users for dashboard (with cache fallback)
                loadRandomUsers(true);
                // Load recent activity (with cache fallback)
                loadRecentActivity(true);

                // Hide loading screen after data is loaded (give it time to render)
                setTimeout(() => {
                    hideLoadingScreen();
                }, 1500);

                // Update data after 5 seconds
                setTimeout(() => {
                    loadCompanyData(false);
                    loadRandomUsers(false);
                    loadRecentActivity(false);
                }, 5000);

                // Add device button event listener
                const addDeviceBtn = document.getElementById('addDeviceBtn');
                if (addDeviceBtn) {
                    addDeviceBtn.addEventListener('click', addDevice);
                }
            });
        </script>

        <!-- Client Selection Modal -->
        <div id="clientModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 20px; color: #1a1a2e;">
                        <i class="fas fa-users" style="margin-right: 8px; color: #667eea;"></i>Select Clients
                    </h3>
                    <button onclick="closeClientModal()"
                        style="background: none; border: none; font-size: 24px; color: #888; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="clientsListContainer"
                    style="border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
                    <div id="clientsList">
                        <!-- Clients will be loaded dynamically here -->
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="update-btn" onclick="closeClientModal()"
                        style="background: #ef5350; min-width: 100px;">
                        Cancel
                    </button>
                    <button class="update-btn" onclick="confirmClientSelection()" style="min-width: 100px;">
                        Confirm
                    </button>
                </div>
            </div>
        </div>

        <script>
            function openClientModal() {
                document.getElementById('clientModal').style.display = 'flex';
                loadClients();
            }

            function closeClientModal() {
                document.getElementById('clientModal').style.display = 'none';
            }

            // Variable global para almacenar emails de clientes seleccionados
            let selectedClientEmails = [];

            function confirmClientSelection() {
                const selectedClients = document.querySelectorAll('.client-option[data-selected="true"]');
                const button = document.getElementById('openClientModal');

                // Extraer emails de los clientes seleccionados
                selectedClientEmails = [];
                selectedClients.forEach(el => {
                    const text = el.querySelector('span:last-child').textContent;
                    console.log('Texto del cliente:', text);

                    // Intentar extraer email - formato puede ser "Name - email@example.com" o solo "email@example.com"
                    let email = '';
                    if (text.includes(' - ')) {
                        // Formato: "Name - email@example.com"
                        const parts = text.split(' - ');
                        email = parts[parts.length - 1].trim();
                    } else {
                        // Intentar encontrar email con regex
                        const emailMatch = text.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                        if (emailMatch) {
                            email = emailMatch[1];
                        }
                    }

                    if (email && email.includes('@')) {
                        selectedClientEmails.push(email);
                        console.log('Email extraÃ­do:', email);
                    } else {
                        console.warn('No se pudo extraer email de:', text);
                    }
                });

                console.log('Emails seleccionados:', selectedClientEmails);

                if (selectedClients.length > 0) {
                    const names = Array.from(selectedClients).map(el => {
                        return el.querySelector('span:last-child').textContent.split(' - ')[0];
                    });
                    button.innerHTML = `<i class="fas fa-users" style="margin-right: 8px;"></i>${selectedClients.length} client(s) selected`;
                } else {
                    button.innerHTML = `<i class="fas fa-users" style="margin-right: 8px;"></i>Select clients`;
                    selectedClientEmails = [];
                }
                closeClientModal();
            }

            // FunciÃ³n para resetear el formulario
            function resetCustomEmailForm() {
                document.getElementById('customEmailSubject').value = '';
                document.getElementById('customEmailMessage').value = '';
                document.getElementById('customEmailImage').value = '';
                document.getElementById('customEmailImagePreview').style.display = 'none';
                document.getElementById('customEmailPreviewImg').src = '';
                document.querySelector('input[name="recipients"][value="all"]').checked = true;
                document.getElementById('openClientModal').style.display = 'none';
                document.getElementById('openClientModal').innerHTML = '<i class="fas fa-users" style="margin-right: 8px;"></i>Select clients';
                selectedClientEmails = [];
                document.getElementById('customEmailMsg').style.display = 'none';
            }

            // FunciÃ³n para convertir imagen a Base64
            function convertImageToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // FunciÃ³n para enviar correo personalizado vÃ­a formulario oculto
            function sendCustomEmailViaForm(subject, message, imageBase64, imageFileName, recipients, selectedClients) {
                return new Promise((resolve, reject) => {
                    try {
                        if (!CUSTOM_EMAILS_API_URL) {
                            reject(new Error('CUSTOM_EMAILS_API_URL is not configured'));
                            return;
                        }

                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = CUSTOM_EMAILS_API_URL;
                        form.target = 'hiddenCustomEmailIframe_' + Date.now();
                        form.style.display = 'none';

                        const fields = {
                            action: 'send_custom_email',
                            subject: subject,
                            message: message,
                            image: imageBase64 || '',
                            imageFileName: imageFileName || '',
                            recipients: recipients,
                            selectedClients: JSON.stringify(selectedClients)
                        };

                        Object.keys(fields).forEach(key => {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = key;
                            input.value = fields[key];
                            form.appendChild(input);
                        });

                        // Crear iframe Ãºnico para esta solicitud
                        const iframe = document.createElement('iframe');
                        iframe.name = form.target;
                        iframe.style.display = 'none';
                        document.body.appendChild(iframe);

                        // Limpiar iframe despuÃ©s de un tiempo
                        setTimeout(() => {
                            if (iframe.parentNode) {
                                iframe.parentNode.removeChild(iframe);
                            }
                        }, 10000);

                        document.body.appendChild(form);
                        form.submit();

                        // Resolver despuÃ©s de un pequeÃ±o delay para permitir el envÃ­o
                        setTimeout(() => {
                            resolve();
                        }, 1000);
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            // FunciÃ³n para enviar correo personalizado
            async function sendCustomEmail() {
                const subject = document.getElementById('customEmailSubject').value.trim();
                const message = document.getElementById('customEmailMessage').value.trim();
                const imageInput = document.getElementById('customEmailImage');
                const recipientsRadio = document.querySelector('input[name="recipients"]:checked');
                const recipients = recipientsRadio ? recipientsRadio.value : 'all';
                const msgDiv = document.getElementById('customEmailMsg');
                const sendBtn = document.getElementById('sendCustomEmailBtn');

                // Validaciones
                if (!subject) {
                    msgDiv.textContent = 'Please enter an email subject';
                    msgDiv.style.display = 'block';
                    msgDiv.style.background = '#fee';
                    msgDiv.style.color = '#c00';
                    return;
                }

                if (!message) {
                    msgDiv.textContent = 'Please enter an email message';
                    msgDiv.style.display = 'block';
                    msgDiv.style.background = '#fee';
                    msgDiv.style.color = '#c00';
                    return;
                }

                if (recipients === 'selected' && selectedClientEmails.length === 0) {
                    msgDiv.textContent = 'Please select at least one client';
                    msgDiv.style.display = 'block';
                    msgDiv.style.background = '#fee';
                    msgDiv.style.color = '#c00';
                    return;
                }

                // Convertir imagen a Base64 si existe
                let imageBase64 = '';
                let imageFileName = '';
                if (imageInput.files && imageInput.files.length > 0) {
                    try {
                        imageBase64 = await convertImageToBase64(imageInput.files[0]);
                        imageFileName = imageInput.files[0].name;
                    } catch (error) {
                        console.error('Error converting image:', error);
                        msgDiv.textContent = 'Error processing image. Please try again.';
                        msgDiv.style.display = 'block';
                        msgDiv.style.background = '#fee';
                        msgDiv.style.color = '#c00';
                        return;
                    }
                }

                // Mostrar mensaje de carga
                msgDiv.textContent = 'Sending email...';
                msgDiv.style.display = 'block';
                msgDiv.style.background = '#e3f2fd';
                msgDiv.style.color = '#1976d2';
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Sending...';

                try {
                    // Enviar usando formulario oculto (mÃ©todo compatible con scripts que requieren sesiÃ³n)
                    await sendCustomEmailViaForm(
                        subject,
                        message,
                        imageBase64,
                        imageFileName,
                        recipients,
                        selectedClientEmails
                    );

                    msgDiv.textContent = 'âœ… Email(s) sent successfully';
                    msgDiv.style.background = '#e8f5e9';
                    msgDiv.style.color = '#2e7d32';

                    // Resetear formulario despuÃ©s de 3 segundos
                    setTimeout(() => {
                        resetCustomEmailForm();
                    }, 3000);
                } catch (error) {
                    console.error('Error sending email:', error);
                    msgDiv.textContent = 'Error sending email. Please try again.';
                    msgDiv.style.background = '#fee';
                    msgDiv.style.color = '#c00';
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 8px;"></i>Send Email';
                }
            }

            // Vista previa de imagen
            document.addEventListener('DOMContentLoaded', function () {
                const imageInput = document.getElementById('customEmailImage');
                const imagePreview = document.getElementById('customEmailImagePreview');
                const previewImg = document.getElementById('customEmailPreviewImg');
                const removeImageBtn = document.getElementById('removeCustomEmailImageBtn');

                if (imageInput) {
                    imageInput.addEventListener('change', function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                previewImg.src = e.target.result;
                                imagePreview.style.display = 'block';
                            };
                            reader.readAsDataURL(file);
                        } else {
                            imagePreview.style.display = 'none';
                        }
                    });
                }

                if (removeImageBtn) {
                    removeImageBtn.addEventListener('click', function () {
                        if (imageInput) imageInput.value = '';
                        imagePreview.style.display = 'none';
                        previewImg.src = '';
                    });
                }
            });
        </script>

    </div>
    <!-- End Dashboard Container -->

    <!-- Color Picker Modal -->
    <div id="colorPickerModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; width: 90%; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <button class="modal-close" onclick="closeColorPickerModal()">&times;</button>
            <h2 style="color: #1a1a2e; margin-bottom: 20px; font-size: 24px;">
                <i class="fas fa-palette" style="margin-right: 10px; color: #667eea;"></i>
                Color Picker
            </h2>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                    Select a Color:
                </label>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <input type="color" id="colorInput" value="#667eea" 
                        style="width: 80px; height: 80px; border: 3px solid #e0e0e0; border-radius: 10px; cursor: pointer;">
                    <div style="flex: 1;">
                        <input type="text" id="hexColorDisplay" value="#667eea" readonly
                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 18px; font-weight: 600; text-align: center; font-family: monospace; background: #f8f9fa;">
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; font-size: 14px;">
                    Quick Colors:
                </label>
                <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px;">
                    <div class="quick-color" data-color="#667eea" style="background: #667eea;"></div>
                    <div class="quick-color" data-color="#764ba2" style="background: #764ba2;"></div>
                    <div class="quick-color" data-color="#f093fb" style="background: #f093fb;"></div>
                    <div class="quick-color" data-color="#4facfe" style="background: #4facfe;"></div>
                    <div class="quick-color" data-color="#00f2fe" style="background: #00f2fe;"></div>
                    <div class="quick-color" data-color="#43e97b" style="background: #43e97b;"></div>
                    <div class="quick-color" data-color="#38f9d7" style="background: #38f9d7;"></div>
                    <div class="quick-color" data-color="#fa709a" style="background: #fa709a;"></div>
                    <div class="quick-color" data-color="#fee140" style="background: #fee140;"></div>
                    <div class="quick-color" data-color="#30cfd0" style="background: #30cfd0;"></div>
                    <div class="quick-color" data-color="#a8edea" style="background: #a8edea;"></div>
                    <div class="quick-color" data-color="#ff6a00" style="background: #ff6a00;"></div>
                    <div class="quick-color" data-color="#ee0979" style="background: #ee0979;"></div>
                    <div class="quick-color" data-color="#ff6a00" style="background: #ff6a00;"></div>
                    <div class="quick-color" data-color="#c71d6f" style="background: #c71d6f;"></div>
                    <div class="quick-color" data-color="#d4418e" style="background: #d4418e;"></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="copyHexColor()" 
                    style="flex: 1; background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-copy" style="margin-right: 8px;"></i>
                    Copy HEX
                </button>
                <button onclick="closeColorPickerModal()" 
                    style="flex: 1; background: #95a5a6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Close
                </button>
            </div>

            <div id="colorCopyMsg" style="margin-top: 15px; text-align: center; font-size: 13px; font-weight: 600; color: #27ae60; display: none;">
                <i class="fas fa-check-circle"></i> Color copied to clipboard!
            </div>
        </div>
    </div>

    <!-- Hidden form for Company Data API submission -->
    <form id="apiForm" method="POST"
        action="https://script.google.com/macros/s/AKfycbyMB7QouKTWnRwNzxhE9xgrZaXY6GATvTF-fsfaR3gFRE6tLJk3Fnw_ta6lRnBKD0_q/exec"
        target="hiddenIframe" style="display: none;">
        <input type="hidden" name="companyName" id="formCompanyName">
        <input type="hidden" name="logo" id="formLogo">
        <input type="hidden" name="adminEmail" id="formAdminEmail">
        <input type="hidden" name="timezone" id="formTimezone">
        <input type="hidden" name="signatureUrl" id="formSignatureUrl">
    </form>

    <!-- Hidden form for Users API submission -->
    <form id="usersApiForm" method="POST"
        action="https://script.google.com/macros/s/AKfycbwpVMDk_-c1UTk5GX-G4P2QHv00tI23ny11Jq7BSGCcZMQgtuBzszNeZFP33JVdWSKDjQ/exec"
        target="hiddenUsersIframe" style="display: none;">
        <input type="hidden" name="email" id="formUserEmail">
        <input type="hidden" name="password" id="formUserPassword">
        <input type="hidden" name="role" id="formUserRole">
        <input type="hidden" name="builds" id="formUserBuilds">
    </form>

    <!-- Hidden form for User Status update -->
    <form id="userStatusForm" method="POST"
        action="https://script.google.com/macros/s/AKfycbwpVMDk_-c1UTk5GX-G4P2QHv00tI23ny11Jq7BSGCcZMQgtuBzszNeZFP33JVdWSKDjQ/exec"
        target="hiddenUserStatusIframe" style="display: none;">
        <input type="hidden" name="email" id="formStatusEmail">
        <input type="hidden" name="password" id="formStatusPassword">
        <input type="hidden" name="role" id="formStatusRole">
        <input type="hidden" name="estado" id="formEstado">
        <input type="hidden" name="builds" id="formStatusBuilds">
    </form>

    <!-- Hidden form for deleting users -->
    <form id="deleteUserForm"
        action="https://script.google.com/macros/s/AKfycbxUleHuPBZ9FxPX8_p2bZz63NFTpI7oUWd8qX6dP2ktH6LonR7YULPLoCPW28Avv-KArQ/exec"
        method="post" target="hiddenUserDeleteIframe" style="display: none;">
        <input type="email" name="correo" id="deleteUserEmail" placeholder="Email of user to delete" required="">
        <input type="hidden" name="action" value="delete_user">
    </form>

    <!-- Hidden form for adding devices -->
    <form id="addDeviceForm"
        action="https://script.google.com/macros/s/AKfycbyEyIQFBkpPRfo31BPKX0neg3k8ufj-M_unbtYM2xKI0yL6QBNdokHD0bghSNxpS2Hm/exec"
        method="post" target="hiddenIframe" style="display: none;">
        <input type="text" name="deviceId" id="addDeviceId" required="">
        <input type="text" name="buildingName" id="addDeviceBuilding" required="">
        <input type="text" name="unitElevator" id="addDeviceUnit" required="">
        <input type="email" name="clientEmail" id="addDeviceEmail">
        <input type="hidden" name="action" value="add_device">
    </form>

    <iframe name="hiddenIframe" id="hiddenIframe" style="display: none;"></iframe>
    <iframe name="hiddenUsersIframe" id="hiddenUsersIframe" style="display: none;"></iframe>
    <iframe name="hiddenUserStatusIframe" id="hiddenUserStatusIframe" style="display: none;"></iframe>
    <iframe name="hiddenUserDeleteIframe" id="hiddenUserDeleteIframe" style="display: none;"></iframe>
    
    <!-- Hidden form for Email Configuration API submission - Alerta -->
    <form id="emailConfigAlertaForm" method="POST"
        action="https://script.google.com/macros/s/AKfycbxFdhEMkxNW-umxKiRkevwzL8Nl90DBUe-eJnamcJW2KlREmLSwtlLe2fVkIEMc9RmhdQ/exec"
        target="hiddenEmailConfigAlertaIframe" style="display: none;">
        <input type="hidden" name="tipo" value="alerta">
        <input type="hidden" name="titulo del corre" id="formEmailTitleAlerta">
        <input type="hidden" name="mensaje del correo" id="formEmailMessageAlerta">
        <input type="hidden" name="mensaje de ignore" id="formIgnoreMessageAlerta">
        <input type="hidden" name="mensaje inferior" id="formBottomMessageAlerta">
    </form>
    <iframe name="hiddenEmailConfigAlertaIframe" id="hiddenEmailConfigAlertaIframe" style="display: none;"></iframe>
    
    <!-- Hidden form for Email Configuration API submission - Resuelto -->
    <form id="emailConfigResueltoForm" method="POST"
        action="https://script.google.com/macros/s/AKfycbxFdhEMkxNW-umxKiRkevwzL8Nl90DBUe-eJnamcJW2KlREmLSwtlLe2fVkIEMc9RmhdQ/exec"
        target="hiddenEmailConfigResueltoIframe" style="display: none;">
        <input type="hidden" name="tipo" value="resuelto">
        <input type="hidden" name="titulo del corre" id="formEmailTitleResuelto">
        <input type="hidden" name="mensaje del correo" id="formEmailMessageResuelto">
        <input type="hidden" name="mensaje de ignore" id="formIgnoreMessageResuelto">
        <input type="hidden" name="mensaje inferior" id="formBottomMessageResuelto">
    </form>
    <iframe name="hiddenEmailConfigResueltoIframe" id="hiddenEmailConfigResueltoIframe" style="display: none;"></iframe>

    <!-- Delete Support ID Modal -->
    <div id="deleteSupportModal" onclick="if(event.target === this) closeDeleteSupportModal()"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div
            style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
            <div style="text-align: center; margin-bottom: 20px;">
                <div
                    style="width: 60px; height: 60px; background: linear-gradient(135deg, #ef5350 0%, #c62828 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                    <i class="fas fa-trash-alt" style="color: white; font-size: 28px;"></i>
                </div>
                <h2 style="margin: 0; color: #1a1a2e; font-size: 24px;">Delete Support ID</h2>
                <p style="color: #888; font-size: 14px; margin-top: 10px;">Are you sure you want to delete Support ID: <strong id="deleteSupportIdText"></strong>?</p>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="closeDeleteSupportModal()"
                    style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; background: white; color: #1a1a2e; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                    Cancel
                </button>
                <button onclick="confirmDeleteSupportId()"
                    style="flex: 1; padding: 12px; border-radius: 8px; border: none; background: linear-gradient(135deg, #ef5350 0%, #c62828 100%); color: white; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(239, 83, 80, 0.3);">
                    <i class="fas fa-trash-alt" style="margin-right: 5px;"></i>Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logoutModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div
            style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
            <div style="text-align: center; margin-bottom: 20px;">
                <div
                    style="width: 60px; height: 60px; background: linear-gradient(135deg, #ef5350 0%, #c62828 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                    <i class="fas fa-sign-out-alt" style="color: white; font-size: 28px;"></i>
                </div>
                <h2 style="margin: 0; color: #1a1a2e; font-size: 24px;">Logout</h2>
                <p style="color: #888; font-size: 14px; margin-top: 10px;">Â¿EstÃ¡s seguro de que deseas cerrar sesiÃ³n?
                </p>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="closeLogoutModal()"
                    style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; background: white; color: #1a1a2e; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                    Cancel
                </button>
                <button onclick="handleLogout()"
                    style="flex: 1; padding: 12px; border-radius: 8px; border: none; background: linear-gradient(135deg, #ef5350 0%, #c62828 100%); color: white; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(239, 83, 80, 0.3);">
                    <i class="fas fa-sign-out-alt" style="margin-right: 5px;"></i>Cerrar SesiÃ³n
                </button>
            </div>
        </div>
    </div>

    <!-- Delete User Confirmation Modal -->
    <div id="deleteUserModal" onclick="if(event.target === this) closeDeleteUserModal()"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div
            style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
            <div style="text-align: center; margin-bottom: 20px;">
                <div
                    style="width: 60px; height: 60px; background: linear-gradient(135deg, #ef5350 0%, #c62828 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                    <i class="fas fa-trash" style="color: white; font-size: 28px;"></i>
                </div>
                <h2 style="margin: 0; color: #1a1a2e; font-size: 24px;">Delete User</h2>
                <p style="color: #888; font-size: 14px; margin-top: 10px;">Are you sure you want to delete user <strong
                        id="deleteUserEmailDisplay"></strong>?</p>
                <p style="color: #ef5350; font-size: 12px; margin-top: 10px;">This action cannot be undone.</p>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="closeDeleteUserModal()"
                    style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; background: white; color: #1a1a2e; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                    Cancel
                </button>
                <button onclick="confirmDeleteUser()"
                    style="flex: 1; padding: 12px; border-radius: 8px; border: none; background: linear-gradient(135deg, #ef5350 0%, #c62828 100%); color: white; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(239, 83, 80, 0.3);">
                    <i class="fas fa-trash" style="margin-right: 5px;"></i>Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Building Devices Modal -->
    <div id="buildingDevicesModal" onclick="if(event.target === this) closeBuildingDevicesModal()"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div
            style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 90%; max-height: 80vh; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 id="buildingDevicesModalTitle"
                    style="margin: 0; color: #1a1a2e; font-size: 24px; font-weight: 700;">
                    <i class="fas fa-building" style="margin-right: 10px; color: #667eea;"></i>Building Devices
                </h2>
                <button onclick="closeBuildingDevicesModal()"
                    style="background: none; border: none; font-size: 28px; cursor: pointer; color: #888; transition: color 0.3s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="buildingDevicesList" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Devices will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Device Details Modal -->
    <div id="deviceDetailsModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; box-shadow: rgba(39, 174, 96, 0.4) 0px 10px 30px; border: 3px solid rgb(39, 174, 96);">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 id="elevator-title" style="margin: 0; color: #2c3e50; font-size: 24px;">Continental test monitoring
                </h2>
            </div>
            <p id="elevator-timestamp" class="timestamp" style="color: #7f8c8d; margin-bottom: 20px;">Last Update:
                15/11/2025, 08:47:27</p>
            <div id="elevator-statuses" style="margin-bottom: 20px;">
                <div class="status-item"
                    style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>input1</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">
                        NORMAL
                    </span>
                </div>
                <div class="status-item"
                    style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>input2</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">
                        NORMAL
                    </span>
                </div>
                <div class="status-item"
                    style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>input3</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">
                        NORMAL
                    </span>
                </div>
                <div class="status-item"
                    style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>input4</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">
                        NORMAL
                    </span>
                </div>
                <div class="status-item"
                    style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>input5</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">
                        NO
                    </span>
                </div>
                <div class="status-item"
                    style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                    <span>input6</span>
                    <span class="false" style="color: #27ae60; font-weight: 600;">
                        NO
                    </span>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="close-elevator-modal" onclick="closeDeviceDetailsModal()"
                    style="background: #000000; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // API URL for device status data
        const DEVICE_STATUS_API_URL = 'https://script.google.com/macros/s/AKfycbyyoDNlKjoSYVX4fUg8nrYCGkidCt9RIz6mswQcq73oxmb0xkGwkE14Du5XOyP7rzlQ/exec';

        // API URL for custom field names per device
        const CUSTOM_FIELD_NAMES_API_URL = 'https://script.google.com/macros/s/AKfycbxCi-ACbof00iUsnsnGvPvpI7mp934AVlVAhpdBXMmC4iOdHmnduXbcU2EXmPDgyv8E/exec';

        // API URL for custom emails
        const CUSTOM_EMAILS_API_URL = 'https://script.google.com/macros/s/AKfycbxYKi26lGhAWuQ13AmxsjAOdvOcJ7Bqz0qEtGKIp9awBs4BQg2HvbT3Dhvg1ZEHo8C5/exec';

        // API URL for support IDs
        const SUPPORT_API_URL = 'https://script.google.com/macros/s/AKfycbzPbNKPbZGovmHraMO7JpAdFrNDx_vhH_U42DrsyvOZwMA2qliC6gqO9_MRg3wFUGlE/exec';

        // Variable to track if input update is in progress
        let isInputUpdateInProgress = false;

        // Hidden form and iframe for custom alert names
        const hiddenCustomAlertForm = document.createElement('form');
        hiddenCustomAlertForm.id = 'hiddenCustomAlertForm';
        hiddenCustomAlertForm.method = 'POST';
        hiddenCustomAlertForm.action = CUSTOM_FIELD_NAMES_API_URL;
        hiddenCustomAlertForm.target = 'hiddenCustomAlertIframe';
        hiddenCustomAlertForm.style.display = 'none';

        const hiddenCustomAlertIframe = document.createElement('iframe');
        hiddenCustomAlertIframe.id = 'hiddenCustomAlertIframe';
        hiddenCustomAlertIframe.name = 'hiddenCustomAlertIframe';
        hiddenCustomAlertIframe.style.display = 'none';

        document.body.appendChild(hiddenCustomAlertForm);
        document.body.appendChild(hiddenCustomAlertIframe);

        // Function to load and display custom alert names
        async function loadCustomAlertsList() {
            try {
                const response = await fetch(CUSTOM_FIELD_NAMES_API_URL);
                const data = await response.json();

                const alertsList = document.getElementById('customAlertsList');
                alertsList.innerHTML = '';

                if (data && data.success && data.data && Array.isArray(data.data) && data.data.length > 0) {
                    data.data.forEach(item => {
                        const deviceId = item.id || item.device_id;
                        if (!deviceId) return;

                        const alertHTML = `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div style="flex: 1;">
                                        <h4 style="font-size: 18px; color: #1a1a2e; margin: 0 0 10px 0;">
                                            <i class="fas fa-mobile-alt" style="margin-right: 8px; color: #667eea;"></i>${deviceId}
                                        </h4>
                                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                                            ${item.out_of_service ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" checked style="width: 18px; height: 18px; cursor: pointer;"><strong>input1:</strong> <span style="color: #667eea;">${item.out_of_service}</span></div>` : ''}
                                            ${item.fire_service ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" checked style="width: 18px; height: 18px; cursor: pointer;"><strong>input2:</strong> <span style="color: #667eea;">${item.fire_service}</span></div>` : ''}
                                            ${item.phone_comm ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" checked style="width: 18px; height: 18px; cursor: pointer;"><strong>input3:</strong> <span style="color: #667eea;">${item.phone_comm}</span></div>` : ''}
                                            ${item.pit_flooded ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" checked style="width: 18px; height: 18px; cursor: pointer;"><strong>input4:</strong> <span style="color: #667eea;">${item.pit_flooded}</span></div>` : ''}
                                            ${item.at_floor ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" checked style="width: 18px; height: 18px; cursor: pointer;"><strong>input5:</strong> <span style="color: #667eea;">${item.at_floor}</span></div>` : ''}
                                            ${item.moving ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" checked style="width: 18px; height: 18px; cursor: pointer;"><strong>input6:</strong> <span style="color: #667eea;">${item.moving}</span></div>` : ''}
                                        </div>
                                    </div>
                                    <button onclick="deleteCustomAlert('${deviceId.replace(/'/g, "\\'")}')" style="padding: 8px 16px; border-radius: 8px; border: 2px solid #ef5350; background: white; color: #ef5350; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s; margin-left: 15px;">
                                        <i class="fas fa-trash" style="margin-right: 5px;"></i>Delete
                                    </button>
                                </div>
                            </div>
                        `;
                        alertsList.innerHTML += alertHTML;
                    });
                } else {
                    alertsList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px; font-size: 14px;">No custom alert names configured yet.</p>';
                }
            } catch (error) {
                console.error('Error loading custom alerts:', error);
                const alertsList = document.getElementById('customAlertsList');
                alertsList.innerHTML = '<p style="text-align: center; color: #ef5350; padding: 20px; font-size: 14px;">Error loading custom alerts. Please try again.</p>';
            }
        }

        // Function to delete custom alert names
        function deleteCustomAlert(deviceId) {
            if (!confirm(`Are you sure you want to delete custom names for device ${deviceId}?`)) {
                return;
            }

            // Clear previous form fields
            while (hiddenCustomAlertForm.firstChild) {
                hiddenCustomAlertForm.removeChild(hiddenCustomAlertForm.firstChild);
            }

            // Add form fields for deletion
            const deviceIdInput = document.createElement('input');
            deviceIdInput.type = 'hidden';
            deviceIdInput.name = 'id';
            deviceIdInput.value = deviceId;
            hiddenCustomAlertForm.appendChild(deviceIdInput);

            const deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = 'delete';
            deleteInput.value = 'true';
            hiddenCustomAlertForm.appendChild(deleteInput);

            // Submit form
            hiddenCustomAlertForm.submit();

            // Clear cache to reload custom names
            customFieldNamesCache = null;

            // Handle iframe load
            hiddenCustomAlertIframe.onload = function () {
                // Reload the list after deletion
                setTimeout(() => {
                    loadCustomAlerts();
                }, 500);
            };
        }

        // Function to toggle custom alert form
        function toggleCustomAlertForm() {
            const form = document.getElementById('customAlertForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
                // Clear form fields
                document.getElementById('customAlertDeviceId').value = '';
                document.getElementById('customAlertOutOfService').value = '';
                document.getElementById('customAlertFireService').value = '';
                document.getElementById('customAlertPhoneComm').value = '';
                document.getElementById('customAlertPitFlooded').value = '';
                document.getElementById('customAlertAtFloor').value = '';
                document.getElementById('customAlertMoving').value = '';
                document.getElementById('customAlertStatusFalse').value = '';
                document.getElementById('customAlertStatusTrue').value = '';
                document.getElementById('customAlertMsg').style.display = 'none';
            }
        }

        // Function to save custom alert names
        function saveCustomAlertNames(event) {
            event.preventDefault();

            const deviceId = document.getElementById('customAlertDeviceId').value.trim();
            const outOfService = document.getElementById('customAlertOutOfService').value.trim();
            const fireService = document.getElementById('customAlertFireService').value.trim();
            const phoneComm = document.getElementById('customAlertPhoneComm').value.trim();
            const pitFlooded = document.getElementById('customAlertPitFlooded').value.trim();
            const atFloor = document.getElementById('customAlertAtFloor').value.trim();
            const moving = document.getElementById('customAlertMoving').value.trim();

            if (!deviceId) {
                alert('Device ID is required');
                return;
            }

            // Clear previous form fields
            while (hiddenCustomAlertForm.firstChild) {
                hiddenCustomAlertForm.removeChild(hiddenCustomAlertForm.firstChild);
            }

            // Add form fields
            const deviceIdInput = document.createElement('input');
            deviceIdInput.type = 'hidden';
            deviceIdInput.name = 'id';
            deviceIdInput.value = deviceId;
            hiddenCustomAlertForm.appendChild(deviceIdInput);

            if (outOfService) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'out_of_service';
                input.value = outOfService;
                hiddenCustomAlertForm.appendChild(input);
            }

            if (fireService) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'fire_service';
                input.value = fireService;
                hiddenCustomAlertForm.appendChild(input);
            }

            if (phoneComm) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'phone_comm';
                input.value = phoneComm;
                hiddenCustomAlertForm.appendChild(input);
            }

            if (pitFlooded) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'pit_flooded';
                input.value = pitFlooded;
                hiddenCustomAlertForm.appendChild(input);
            }

            if (atFloor) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'at_floor';
                input.value = atFloor;
                hiddenCustomAlertForm.appendChild(input);
            }

            if (moving) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'moving';
                input.value = moving;
                hiddenCustomAlertForm.appendChild(input);
            }

            const statusFalse = document.getElementById('customAlertStatusFalse').value.trim();
            if (statusFalse) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'status_false';
                input.value = statusFalse;
                hiddenCustomAlertForm.appendChild(input);
            }

            const statusTrue = document.getElementById('customAlertStatusTrue').value.trim();
            if (statusTrue) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'status_true';
                input.value = statusTrue;
                hiddenCustomAlertForm.appendChild(input);
            }

            // Show loading message
            const msgElement = document.getElementById('customAlertMsg');
            msgElement.textContent = 'Saving custom names...';
            msgElement.style.color = '#667eea';
            msgElement.style.display = 'block';

            // Submit form
            hiddenCustomAlertForm.submit();

            // Clear cache to reload custom names
            customFieldNamesCache = null;

            // Handle iframe load
            hiddenCustomAlertIframe.onload = function () {
                msgElement.textContent = 'Custom names saved successfully!';
                msgElement.style.color = '#27ae60';

                // Reload the list after saving
                setTimeout(() => {
                    loadCustomAlerts();
                }, 500);

                // Clear form after success
                setTimeout(() => {
                    document.getElementById('customAlertDeviceId').value = '';
                    document.getElementById('customAlertOutOfService').value = '';
                    document.getElementById('customAlertFireService').value = '';
                    document.getElementById('customAlertPhoneComm').value = '';
                    document.getElementById('customAlertPitFlooded').value = '';
                    document.getElementById('customAlertAtFloor').value = '';
                    document.getElementById('customAlertMoving').value = '';
                    document.getElementById('customAlertStatusFalse').value = '';
                    document.getElementById('customAlertStatusTrue').value = '';
                    document.getElementById('customAlertForm').style.display = 'none';
                    msgElement.style.display = 'none';
                }, 2000);
            };
        }

        // Cache for custom field names
        let customFieldNamesCache = null;

        // Function to load custom field names from API
        async function loadCustomFieldNames() {
            if (!CUSTOM_FIELD_NAMES_API_URL) {
                return {}; // Return empty object if no API URL configured
            }

            if (customFieldNamesCache) {
                return customFieldNamesCache;
            }

            try {
                const response = await fetch(CUSTOM_FIELD_NAMES_API_URL);
                const data = await response.json();

                if (data && data.success && data.data) {
                    // Transform array to object: { "device_id": { "field_name": "custom_name" } }
                    // Format: { "id": "ID10", "out_of_service": "FUERA DE SERVI", ... }
                    const customNames = {};
                    if (Array.isArray(data.data)) {
                        data.data.forEach(item => {
                            const deviceId = item.id || item.device_id;
                            if (!deviceId) return;

                            if (!customNames[deviceId]) {
                                customNames[deviceId] = {};
                            }

                            // Map all field names (convert to uppercase for matching)
                            // Handle both snake_case and UPPER_CASE field names
                            Object.keys(item).forEach(key => {
                                if (key !== 'id' && key !== 'device_id') {
                                    // Store both lowercase and uppercase versions for flexible matching
                                    const upperKey = key.toUpperCase();
                                    customNames[deviceId][upperKey] = item[key];
                                    customNames[deviceId][key] = item[key]; // Also store original case
                                    
                                    // Also handle status_false and status_true specifically
                                    if (key === 'status_false' || key === 'status_true') {
                                        customNames[deviceId][upperKey] = item[key];
                                    }
                                }
                            });
                            
                            // Debug: Log what was loaded for this device
                            console.log(`ðŸ“‹ Loaded custom names for ${deviceId}:`, customNames[deviceId]);
                        });
                    }
                    customFieldNamesCache = customNames;
                    return customNames;
                }
            } catch (error) {
                console.error('Error loading custom field names:', error);
            }

            return {};
        }

        // Function to get display name for a field (custom or default)
        function getFieldDisplayName(deviceId, fieldName, defaultName) {
            if (!customFieldNamesCache || !customFieldNamesCache[deviceId]) {
                return defaultName;
            }

            // Try exact match first (uppercase)
            const upperFieldName = fieldName.toUpperCase();
            let customName = customFieldNamesCache[deviceId][upperFieldName];

            // If not found, try original case
            if (!customName) {
                customName = customFieldNamesCache[deviceId][fieldName];
            }

            // If still not found, try lowercase
            if (!customName) {
                customName = customFieldNamesCache[deviceId][fieldName.toLowerCase()];
            }

            // NUEVO: Si el nombre personalizado tiene formato "NOMBRE/TRUE/FALSE", extraer solo el nombre
            if (customName && typeof customName === 'string' && customName.includes('/')) {
                const parts = customName.split('/');
                if (parts.length >= 1) {
                    return parts[0].trim(); // Retornar solo el nombre (primera parte)
                }
            }

            return customName || defaultName;
        }

        // Function to get custom status text (STATUS FALSE/TRUE) for a device
        // Retorna objeto: { text: string, color: string|null }
        function getCustomStatusText(deviceId, value, fieldName = null) {
            try {
                // Handle boolean values directly
                let isTrue = false;
                let isFalse = false;
                
                if (typeof value === 'boolean') {
                    isTrue = value === true;
                    isFalse = value === false;
                } else {
                    const valueStr = String(value).toLowerCase().trim();
                    // Check if value is true/active
                    isTrue = valueStr === 'true' || 
                             valueStr === '1' || 
                             valueStr === 'yes' || 
                             valueStr === 'alerta' ||
                             valueStr === 'active' ||
                             valueStr === 'on';
                    // Check if value is false/inactive
                    isFalse = valueStr === 'false' || 
                              valueStr === '0' || 
                              valueStr === 'no' || 
                              valueStr === 'normal' ||
                              valueStr === 'inactive' ||
                              valueStr === 'off' ||
                              valueStr === '';
                }
                
                if (!customFieldNamesCache || !customFieldNamesCache[deviceId]) {
                    // If no custom config, return default based on value
                    console.log(`âš ï¸ No custom config for device ${deviceId}, using default: ${isTrue ? 'ALERT' : 'NORMAL'}`);
                    return { text: isTrue ? 'ALERT' : 'NORMAL', color: null };
                }

                const deviceData = customFieldNamesCache[deviceId];
                
                // NUEVO: Si el fieldName tiene formato "NOMBRE/TRUE/FALSE/COLOR", usar esos valores
                if (fieldName) {
                    const upperFieldName = fieldName.toUpperCase();
                    let customFieldValue = deviceData[upperFieldName] || deviceData[fieldName] || deviceData[fieldName.toLowerCase()];
                    
                    if (customFieldValue && typeof customFieldValue === 'string' && customFieldValue.includes('/')) {
                        const parts = customFieldValue.split('/');
                        
                        // Formato con color: NOMBRE/TRUE/FALSE/COLOR (4 partes)
                        if (parts.length === 4) {
                            const customTrue = parts[1].trim();
                            const customFalse = parts[2].trim();
                            const customColor = parts[3].trim();
                            
                            console.log(`ðŸŽ¨ Using field-specific format with color for ${fieldName}: TRUE="${customTrue}", FALSE="${customFalse}", COLOR="${customColor}"`);
                            
                            if (isTrue && customTrue) {
                                console.log(`âœ… Using field-specific STATUS_TRUE with color: ${customTrue} (${customColor})`);
                                return { text: customTrue, color: customColor };
                            }
                            if (isFalse && customFalse) {
                                console.log(`âœ… Using field-specific STATUS_FALSE with color: ${customFalse} (${customColor})`);
                                return { text: customFalse, color: customColor };
                            }
                        }
                        // Formato sin color: NOMBRE/TRUE/FALSE (3 partes)
                        else if (parts.length === 3) {
                            const customTrue = parts[1].trim();
                            const customFalse = parts[2].trim();
                            
                            console.log(`ðŸ” Using field-specific format for ${fieldName}: TRUE="${customTrue}", FALSE="${customFalse}"`);
                            
                            if (isTrue && customTrue) {
                                console.log(`âœ… Using field-specific STATUS_TRUE: ${customTrue}`);
                                return { text: customTrue, color: null };
                            }
                            if (isFalse && customFalse) {
                                console.log(`âœ… Using field-specific STATUS_FALSE: ${customFalse}`);
                                return { text: customFalse, color: null };
                            }
                        }
                    }
                }
                
                console.log(`ðŸ” Custom status text for ${deviceId}: value=${value} (${typeof value}), isTrue=${isTrue}, isFalse=${isFalse}, STATUS_TRUE=${deviceData['STATUS_TRUE']}, STATUS_FALSE=${deviceData['STATUS_FALSE']}`);

                // If value is true and there's custom STATUS_TRUE text, use it
                if (isTrue && deviceData['STATUS_TRUE']) {
                    console.log(`âœ… Using custom STATUS_TRUE: ${deviceData['STATUS_TRUE']}`);
                    return { text: deviceData['STATUS_TRUE'], color: null };
                }

                // If value is false and there's custom STATUS_FALSE text, use it
                if (isFalse && deviceData['STATUS_FALSE']) {
                    console.log(`âœ… Using custom STATUS_FALSE: ${deviceData['STATUS_FALSE']}`);
                    return { text: deviceData['STATUS_FALSE'], color: null };
                }

                // Fallback to default
                console.log(`âš ï¸ No custom text found, using default: ${isTrue ? 'ALERT' : 'NORMAL'}`);
                return { text: isTrue ? 'ALERT' : 'NORMAL', color: null };

            } catch (error) {
                console.error(`Error getting custom status text for ${deviceId}:`, error);
                const valueStr = String(value).toLowerCase().trim();
                const isTrue = valueStr === 'true' || valueStr === '1' || valueStr === 'yes' || valueStr === 'alerta' || valueStr === 'active' || valueStr === 'on';
                return { text: isTrue ? 'ALERT' : 'NORMAL', color: null };
            }
        }

        // Cache variables for device status API
        let apiDataCache = null;
        let cacheTimestamp = null;
        const CACHE_DURATION = 5000; // 5 seconds

        // Function to get device status data from API with cache
        async function getApiDataWithCache() {
            const now = Date.now();

            // Check if we have valid cache in memory
            if (apiDataCache && cacheTimestamp && (now - cacheTimestamp) < CACHE_DURATION) {
                return apiDataCache;
            }

            // Check localStorage
            const cachedData = localStorage.getItem('elevatorApiData');
            const cachedTimestamp = localStorage.getItem('elevatorApiTimestamp');

            if (cachedData && cachedTimestamp && (now - parseInt(cachedTimestamp)) < CACHE_DURATION) {
                apiDataCache = JSON.parse(cachedData);
                cacheTimestamp = parseInt(cachedTimestamp);
                return apiDataCache;
            }

            try {
                const response = await fetch(DEVICE_STATUS_API_URL);
                const data = await response.json();

                if (data.success && data.data && Array.isArray(data.data)) {
                    // Save to memory cache
                    apiDataCache = data;
                    cacheTimestamp = now;

                    // Save to localStorage
                    localStorage.setItem('elevatorApiData', JSON.stringify(data));
                    localStorage.setItem('elevatorApiTimestamp', now.toString());

                    return data;
                } else {
                    return null;
                }
            } catch (error) {
                console.error('Error fetching device status data:', error);
                return null;
            }
        }

        // Function to format field name (replace underscores with spaces)
        function formatFieldName(fieldName) {
            // Map original field names to input1-input6
            const fieldMapping = {
                'OUT_OF_SERVICE': 'input1',
                'FIRE_SERVICE': 'input2',
                'PHONE_COMM': 'input3',
                'PIT_FLOODED': 'input4',
                'AT_FLOOR': 'input5',
                'MOVING': 'input6'
            };

            // Return mapped name if exists, otherwise format normally
            if (fieldMapping[fieldName]) {
                return fieldMapping[fieldName];
            }

            return fieldName.replace(/_/g, ' ');
        }

        async function openDeviceDetailsModal(deviceId) {
            // Load custom field names before opening modal
            await loadCustomFieldNames();
            
            // Debug: Verify cache is loaded
            console.log(`ðŸ” Cache loaded for modal. Device ${deviceId} in cache:`, customFieldNamesCache && customFieldNamesCache[deviceId] ? 'YES' : 'NO');
            if (customFieldNamesCache && customFieldNamesCache[deviceId]) {
                console.log(`ðŸ“‹ Cache data for ${deviceId}:`, customFieldNamesCache[deviceId]);
            }
            
            const modal = document.getElementById('deviceDetailsModal');
            const title = document.getElementById('elevator-title');
            const timestamp = document.getElementById('elevator-timestamp');
            const statusesContainer = document.getElementById('elevator-statuses');

            // Get device info from devices list to get building name
            let deviceName = deviceId;
            try {
                const devicesResponse = await fetch(DEVICES_API_URL);
                const devicesResult = await devicesResponse.json();
                if (devicesResult.success && devicesResult.data) {
                    const device = devicesResult.data.find(d => d.deviceId === deviceId);
                    if (device && device.buildingName) {
                        deviceName = device.buildingName;
                    }
                }
            } catch (error) {
                // Use deviceId as fallback
            }

            // Update title
            title.textContent = deviceName;

            // Show loading
            statusesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">Loading device status...</div>';

            // Show modal
            modal.style.display = 'flex';

            try {
                // Get real-time data from API with cache
                const data = await getApiDataWithCache();

                if (data && data.success && data.data && Array.isArray(data.data)) {
                    // Find the specific device in the data
                    const deviceData = data.data.find(d => d.device_id === deviceId);

                    if (deviceData) {
                        // Update timestamp
                        const deviceTime = new Date(deviceData.timestamp);
                        const bermudaTime = deviceTime.toLocaleString('en-US', {
                            timeZone: 'Atlantic/Bermuda',
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        timestamp.textContent = `Last Update: ${bermudaTime}`;

                        // Check if device is offline (more than 60 seconds since timestamp)
                        const now = new Date();
                        const timeDiff = now - deviceTime;
                        const secondsDiff = timeDiff / 1000;
                        const isOffline = secondsDiff > 60;

                        // Check if there are critical alarms - dynamically check all boolean fields
                        // Exclude metadata fields and info-only fields (position/movement related)
                        const metadataFields = ['device_id', 'timestamp', 'raw_json'];
                        const isInfoField = (fieldName) => {
                            const upper = fieldName.toUpperCase();
                            return upper.includes('FLOOR') || upper.includes('DZ') ||
                                upper.includes('MOVING') || upper.includes('MOVE') ||
                                upper.includes('POSITION') || upper.includes('LEVEL');
                        };
                        const hasAlarm = Object.keys(deviceData).some(key => {
                            if (metadataFields.includes(key)) return false;
                            if (isInfoField(key)) return false; // Info fields are not alarms
                            const value = deviceData[key];
                            return value === true || value === 'true';
                        });

                        // Apply border to modal based on status
                        const modalContent = modal.querySelector('.modal-content');
                        if (isOffline) {
                            modalContent.style.border = '3px solid #95a5a6';
                            modalContent.style.boxShadow = '0 10px 30px rgba(149, 165, 166, 0.4)';
                        } else if (hasAlarm) {
                            modalContent.style.border = '3px solid #e74c3c';
                            modalContent.style.boxShadow = '0 10px 30px rgba(231, 76, 60, 0.4)';
                        } else {
                            modalContent.style.border = '3px solid #27ae60';
                            modalContent.style.boxShadow = '0 10px 30px rgba(39, 174, 96, 0.4)';
                        }

                        // Update statuses with real data
                        if (isOffline) {
                            // Show all statuses as OFFLINE - dynamically get fields from API
                            const metadataFields = ['device_id', 'timestamp', 'raw_json'];
                            const allFields = Object.keys(deviceData).filter(key => !metadataFields.includes(key));

                            // Emoji mapping for common fields
                            const emojiMap = {
                                'OUT_OF_SERVICE': '',
                                'FIRE_SERVICE': '',
                                'PHONE_COMM': '',
                                'PIT_FLOODED': '',
                                'AT_FLOOR': '',
                                'ATFLOOR': '',
                                'MOVING': ''
                            };

                            const getEmoji = (fieldName) => {
                                if (emojiMap[fieldName]) return emojiMap[fieldName];
                                const upperField = fieldName.toUpperCase();
                                for (const key in emojiMap) {
                                    if (key.toUpperCase() === upperField) {
                                        return emojiMap[key];
                                    }
                                }
                                return '';
                            };

                            let offlineHTML = '';
                            allFields.forEach(field => {
                                const defaultDisplayName = formatFieldName(field);
                                const displayName = getFieldDisplayName(deviceId, field, defaultDisplayName);
                                const emoji = getEmoji(field);
                                offlineHTML += `
                                    <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                        <span>${displayName}</span>
                                        <span class="offline" style="color: #95a5a6; font-weight: 600;">OFFLINE</span>
                                    </div>
                                `;
                            });
                            statusesContainer.innerHTML = offlineHTML;
                        } else {
                            // Show normal statuses with alarms if any
                            // Dynamically get all fields from API response
                            const metadataFields = ['device_id', 'timestamp', 'raw_json'];

                            // Get all fields except metadata
                            const allFields = Object.keys(deviceData).filter(key => !metadataFields.includes(key));

                            // Determine info-only fields dynamically - fields that should show YES/NO instead of ALARM/NORMAL
                            // These are typically fields related to position/movement, not alarms
                            const isInfoField = (fieldName) => {
                                const upper = fieldName.toUpperCase();
                                return upper.includes('FLOOR') || upper.includes('DZ') ||
                                    upper.includes('MOVING') || upper.includes('MOVE') ||
                                    upper.includes('POSITION') || upper.includes('LEVEL');
                            };

                            // Emoji mapping for common fields
                            const emojiMap = {
                                'OUT_OF_SERVICE': '',
                                'FIRE_SERVICE': '',
                                'PHONE_COMM': '',
                                'PIT_FLOODED': '',
                                'AT_FLOOR': '',
                                'ATFLOOR': '',
                                'MOVING': ''
                            };

                            // Default emoji for unknown fields
                            const getEmoji = (fieldName) => {
                                // Try exact match first
                                if (emojiMap[fieldName]) return emojiMap[fieldName];

                                // Try case-insensitive match
                                const upperField = fieldName.toUpperCase();
                                for (const key in emojiMap) {
                                    if (key.toUpperCase() === upperField) {
                                        return emojiMap[key];
                                    }
                                }

                                return ''; // Default emoji
                            };

                            let statusHTML = '';

                            // Process all fields dynamically
                            allFields.forEach(fieldKey => {
                                const value = deviceData[fieldKey];
                                const defaultDisplayName = formatFieldName(fieldKey);
                                const displayName = getFieldDisplayName(deviceId, fieldKey, defaultDisplayName);
                                const emoji = getEmoji(fieldKey);

                                // Check if it's an info-only field (YES/NO) or alarm field (ALARM/NORMAL)
                                if (isInfoField(fieldKey)) {
                                    // Info fields (YES/NO) - use custom status text
                                    const isYes = value === true || value === 'true';
                                    const statusObj = getCustomStatusText(deviceId, value, fieldKey);
                                    const statusColor = statusObj.color || (isYes ? '#e74c3c' : '#27ae60');
                                    statusHTML += `
                                        <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                            <span>${displayName}</span>
                                            <span class="${isYes ? 'true' : 'false'}" style="color: ${statusColor}; font-weight: 600;">
                                                ${statusObj.text}
                                            </span>
                                        </div>
                                    `;
                                } else {
                                    // Alarm fields (true = alarm, false = normal) - use custom status text
                                    const isAlarm = value === true || value === 'true';
                                    const statusObj = getCustomStatusText(deviceId, value, fieldKey);
                                    const statusColor = statusObj.color || (isAlarm ? '#e74c3c' : '#27ae60');
                                    statusHTML += `
                                        <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef; ${isAlarm ? 'border: 2px solid #e74c3c; border-radius: 5px; background-color: #fdf2f2;' : ''}">
                                            <span>${displayName}</span>
                                            <span class="${isAlarm ? 'true' : 'false'}" style="color: ${statusColor}; font-weight: 600;">
                                                ${statusObj.text}
                                            </span>
                                        </div>
                                    `;
                                }
                            });

                            statusesContainer.innerHTML = statusHTML;
                        }
                    } else {
                        // Device not found
                        timestamp.textContent = 'Device not found';
                        const modalContent = modal.querySelector('.modal-content');
                        modalContent.style.border = '3px solid #2c3e50';
                        modalContent.style.boxShadow = '0 10px 30px rgba(44, 62, 80, 0.4)';

                        const statusFields = ['OUT_OF_SERVICE', 'FIRE_SERVICE', 'PHONE_COMM', 'PIT_FLOODED', 'AT_FLOOR', 'MOVING'];
                        let offlineHTML = '';
                        statusFields.forEach(field => {
                            const displayName = formatFieldName(field);
                            offlineHTML += `
                                <div class="status-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #e9ecef;">
                                    <span>${displayName}</span>
                                    <span class="offline" style="color: #e67e22; font-weight: 600;">OFFLINE</span>
                                </div>
                            `;
                        });
                        statusesContainer.innerHTML = offlineHTML;
                    }
                } else {
                    // API error
                    timestamp.textContent = 'Error loading real-time data';
                    statusesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading device status</div>';
                }
            } catch (error) {
                console.error('Error loading device status:', error);
                timestamp.textContent = 'Error loading real-time data';
                statusesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading device status</div>';
            }
        }

        // Delete device function
        function deleteDevice(clientEmail) {
            if (!confirm(`Are you sure you want to delete device with email ${clientEmail}?`)) {
                return;
            }

            // Create a form to delete device
            const deleteForm = document.createElement('form');
            deleteForm.method = 'POST';
            deleteForm.action = 'https://script.google.com/macros/s/AKfycbyEyIQFBkpPRfo31BPKX0neg3k8ufj-M_unbtYM2xKI0yL6QBNdokHD0bghSNxpS2Hm/exec';
            deleteForm.target = 'hiddenIframe';
            deleteForm.style.display = 'none';

            const emailInput = document.createElement('input');
            emailInput.type = 'hidden';
            emailInput.name = 'clientEmail';
            emailInput.value = clientEmail;

            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'delete_device';

            deleteForm.appendChild(emailInput);
            deleteForm.appendChild(actionInput);
            document.body.appendChild(deleteForm);

            deleteForm.submit();

            // Show loading state
            const devicesList = document.getElementById('devicesList');
            if (devicesList) {
                devicesList.innerHTML = '<p style="text-align: center; color: #667eea; padding: 40px;"><i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i>Deleting device...</p>';
            }

            // Reload devices list after a delay
            setTimeout(() => {
                loadDevices();
                document.body.removeChild(deleteForm);
            }, 2000);
        }

        function closeDeviceDetailsModal() {
            document.getElementById('deviceDetailsModal').style.display = 'none';
        }

        // Building Devices Modal functions
        async function openBuildingDevicesModal(buildingName) {
            try {
                const response = await fetch(DEVICES_API_URL);
                const result = await response.json();

                const modal = document.getElementById('buildingDevicesModal');
                const modalTitle = document.getElementById('buildingDevicesModalTitle');
                const devicesList = document.getElementById('buildingDevicesList');

                modalTitle.innerHTML = `<i class="fas fa-building" style="margin-right: 10px; color: #667eea;"></i>${buildingName} - Devices`;
                devicesList.innerHTML = '';

                if (result.success && result.data && Array.isArray(result.data)) {
                    // Filter devices by building name
                    const buildingDevices = result.data.filter(device =>
                        device.buildingName === buildingName && device.deviceId && device.deviceId !== ''
                    );

                    if (buildingDevices.length === 0) {
                        devicesList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No devices found for this building</p>';
                    } else {
                        buildingDevices.forEach((device, deviceIndex) => {
                            const deviceGradients = [
                                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
                                'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
                            ];
                            const deviceBorderColors = ['#667eea', '#22c55e', '#f59e0b'];
                            const deviceGradient = deviceGradients[deviceIndex % deviceGradients.length];
                            const deviceBorderColor = deviceBorderColors[deviceIndex % deviceBorderColors.length];

                            const escapedDeviceId = (device.deviceId || '').replace(/'/g, "\\'");

                            const deviceHTML = `
                                <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid ${deviceBorderColor};">
                                    <div style="width: 50px; height: 50px; border-radius: 8px; background: ${deviceGradient}; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                                        <i class="fas fa-mobile-alt"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h5 style="font-size: 16px; color: #1a1a2e; margin-bottom: 5px;">Device ID: ${device.deviceId || 'N/A'}</h5>
                                        <p style="color: #888; font-size: 14px; margin-bottom: 5px;">Unit/Elevator: ${device.unitElevator || 'N/A'}</p>
                                        <p style="color: #888; font-size: 14px;">Client: ${device.clientEmail || 'N/A'}</p>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="openDeviceDetailsModal('${escapedDeviceId}'); closeBuildingDevicesModal();" style="padding: 8px 16px; border-radius: 8px; border: 2px solid #667eea; background: white; color: #667eea; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s;">
                                            <i class="fas fa-info-circle" style="margin-right: 5px;"></i>Details
                                        </button>
                                    </div>
                                </div>
                            `;
                            devicesList.innerHTML += deviceHTML;
                        });
                    }
                } else {
                    devicesList.innerHTML = '<p style="text-align: center; color: #ef5350; padding: 40px;">Error loading devices</p>';
                }

                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error loading building devices:', error);
                const devicesList = document.getElementById('buildingDevicesList');
                devicesList.innerHTML = '<p style="text-align: center; color: #ef5350; padding: 40px;">Error loading devices. Please try again.</p>';
                document.getElementById('buildingDevicesModal').style.display = 'flex';
            }
        }

        function closeBuildingDevicesModal() {
            document.getElementById('buildingDevicesModal').style.display = 'none';
        }

        // Reports API URL
        const REPORTS_API_URL = 'https://script.google.com/macros/s/AKfycbwmymPhQ89H9I0Mc25PYBYcgLSFANar8FyWbFTF0wCzk8OCbm6IXproy9YFhgKvpOJD_w/exec';

        // Function to get data from reports API
        async function fetchReportsData() {
            try {
                const response = await fetch(REPORTS_API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error('API returned invalid JSON response');
                }

                if (data.success && data.data) {
                    return data.data;
                } else {
                    throw new Error(`API returned unsuccessful response: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                throw error;
            }
        }

        // Function to filter data by device and date range
        function filterReportsData(data, deviceId, startDate, endDate, reportType = 'all') {
            let filteredData = data;

            // Filter by device if not "all"
            if (deviceId !== 'all') {
                filteredData = filteredData.filter(item => item.device_id === deviceId);
            }

            // Filter out AT_FLOOR and MOVING events (these should not appear in reports)
            const excludedEvents = ['AT_FLOOR', 'MOVING'];
            filteredData = filteredData.filter(item => {
                const inputChanged = item.input_changed || '';
                const shouldExclude = excludedEvents.includes(inputChanged);
                return !shouldExclude;
            });

            // Filter by report type and state changes
            if (reportType === 'service') {
                // Service Log: Show when events go from true to false (problem resolved)
                filteredData = filteredData.filter(item => {
                    const oldValue = item.old_value;
                    const newValue = item.new_value;
                    const isServiceResolution = oldValue === true && newValue === false;
                    return isServiceResolution;
                });
            } else if (reportType === 'alarms') {
                // Alarm: Show when events go from false to true (alarm activated)
                filteredData = filteredData.filter(item => {
                    const oldValue = item.old_value;
                    const newValue = item.new_value;
                    const isAlarmActivation = oldValue === false && newValue === true;
                    return isAlarmActivation;
                });
            }
            // For 'summary' and other types, show all events (no additional filtering)

            // Filter by date range
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);

                filteredData = filteredData.filter(item => {
                    const timestamp = item.timestamp || '';
                    let itemDate = null;

                    try {
                        if (timestamp.includes(',')) {
                            const dateTimePart = timestamp.split(',')[0].trim();
                            let timePart = timestamp.split(',')[1].trim();

                            if (timePart.includes('(Bermuda Time)')) {
                                timePart = timePart.replace('(Bermuda Time)', '').trim();
                            }

                            const [day, month, year] = dateTimePart.split('/');
                            const [hour, minute, second] = timePart.split(':');
                            itemDate = new Date(year, month - 1, day, hour, minute, second);
                        } else if (timestamp.includes(' ')) {
                            let cleanTimestamp = timestamp;
                            if (cleanTimestamp.includes('(Bermuda Time)')) {
                                cleanTimestamp = cleanTimestamp.replace('(Bermuda Time)', '').trim();
                            }

                            const [datePart, timePart] = cleanTimestamp.split(' ');
                            const [day, month, year] = datePart.split('/');
                            const [hour, minute, second] = timePart.split(':');
                            itemDate = new Date(year, month - 1, day, hour, minute, second);
                        } else {
                            itemDate = new Date(timestamp);
                        }

                        if (isNaN(itemDate.getTime())) {
                            console.warn('Invalid timestamp format:', timestamp);
                            return false;
                        }

                        const endDateInclusive = new Date(end);
                        endDateInclusive.setDate(endDateInclusive.getDate() + 1);

                        return itemDate >= start && itemDate < endDateInclusive;
                    } catch (error) {
                        console.warn('Error parsing timestamp:', timestamp, error);
                        return false;
                    }
                });
            }

            return filteredData;
        }

        // Function to load devices in reports select
        async function loadReportDevices() {
            const select = document.getElementById('reportDeviceSelect');
            if (!select) {
                return;
            }

            select.innerHTML = '<option value="all">Loading devices...</option>';
            select.disabled = true;

            try {
                const apiData = await fetchReportsData();
                const uniqueDevices = [...new Set(apiData.map(item => item.device_id))].filter(id => id);

                select.innerHTML = '';

                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'All Devices';
                allOption.selected = true;
                select.appendChild(allOption);

                if (uniqueDevices.length === 0) {
                    const noDevicesOption = document.createElement('option');
                    noDevicesOption.value = '';
                    noDevicesOption.textContent = 'No devices available';
                    noDevicesOption.disabled = true;
                    select.appendChild(noDevicesOption);
                } else {
                    uniqueDevices.forEach(deviceId => {
                        const option = document.createElement('option');
                        option.value = deviceId;
                        option.textContent = `Device ${deviceId}`;
                        select.appendChild(option);
                    });
                }

                select.disabled = false;
            } catch (error) {
                select.innerHTML = '<option value="all">Error loading devices</option>';
                select.disabled = false;

                const reportMsg = document.getElementById('reportMsg');
                if (reportMsg) {
                    reportMsg.textContent = 'Error loading devices. Using default data.';
                    reportMsg.className = 'success-msg error';
                    setTimeout(() => {
                        reportMsg.textContent = '';
                        reportMsg.className = '';
                    }, 5000);
                }
            }
        }

        // Update daily alerts counter
        function updateDailyAlertsCounter(count) {
            const counterElement = document.getElementById('dailyAlertsCount');
            if (counterElement) {
                counterElement.innerHTML = count;
            }
        }

        // Render recent activity events
        function renderRecentActivity(events, deviceToBuildingMap = {}) {
            const recentActivityList = document.getElementById('recentActivityList');
            if (!recentActivityList) return;

            if (!events || events.length === 0) {
                recentActivityList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No activity today</p>';
                return;
            }

            recentActivityList.innerHTML = '';

            events.forEach(event => {
                // Get personalized field name or use default
                const deviceId = event.device_id || 'N/A';
                const fieldName = event.input_changed || '';
                const defaultFieldName = fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const displayFieldName = getFieldDisplayName(deviceId, fieldName, defaultFieldName);

                // Get building name from mapping
                const buildingName = deviceToBuildingMap[deviceId] || '';
                const deviceDisplay = buildingName ? `${deviceId} - ${buildingName}` : deviceId;

                // FunciÃ³n para determinar si un valor representa una alarma (true/Alert/Active)
                const isAlarmValue = (value) => {
                    if (value === true || value === 'true') return true;
                    if (value === false || value === 'false') return false;
                    
                    const valueStr = String(value).toLowerCase().trim();
                    // Check if value represents alarm/active state
                    if (valueStr === 'alert' || valueStr === 'alarm' || valueStr === 'active' || 
                        valueStr === 'yes' || valueStr === '1' || valueStr === 'on') {
                        return true;
                    }
                    // Check if value represents normal/inactive state
                    if (valueStr === 'normal' || valueStr === 'no' || valueStr === '0' || 
                        valueStr === 'off' || valueStr === 'inactive' || valueStr === '') {
                        return false;
                    }
                    
                    // Check against custom status texts
                    if (customFieldNamesCache && customFieldNamesCache[deviceId]) {
                        const deviceData = customFieldNamesCache[deviceId];
                        const statusTrue = String(deviceData['STATUS_TRUE'] || '').toLowerCase().trim();
                        const statusFalse = String(deviceData['STATUS_FALSE'] || '').toLowerCase().trim();
                        
                        if (statusTrue && valueStr === statusTrue) return true;
                        if (statusFalse && valueStr === statusFalse) return false;
                    }
                    
                    // Default: if it's not clearly false, assume it might be an alarm
                    return valueStr !== 'normal' && valueStr !== 'no' && valueStr !== '';
                };

                const oldValue = event.old_value;
                const newValue = event.new_value;
                const newIsAlarm = isAlarmValue(newValue);

                // Determine icon color based on new_value
                // Alarm = red, Resolved = green
                const iconBg = newIsAlarm === true ? '#e74c3c' : '#27ae60';
                const iconText = newIsAlarm === true ? 'ðŸš¨' : 'âœ”';
                const progressBg = newIsAlarm === true ? '#e74c3c' : '#27ae60';

                // Format the change text with personalized name
                let changeText;
                if (newIsAlarm === true) {
                    changeText = `${displayFieldName}: <span style="white-space: nowrap;">ðŸš¨ ALARM</span>`;
                } else if (newIsAlarm === false) {
                    changeText = `${displayFieldName}: <span style="white-space: nowrap;">âœ… RESOLVED</span>`;
                } else {
                    // Fallback for unknown values
                    const oldVal = oldValue === true || oldValue === 'true' ? 'ON' : 'OFF';
                    const newVal = newValue === true || newValue === 'true' ? 'ON' : 'OFF';
                    changeText = `${displayFieldName}: ${oldVal} â†’ ${newVal}`;
                }

                // Format timestamp (show relative time if recent, otherwise show date)
                const timestamp = event.timestamp || '';

                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `
                    <span class="icon" style="background: ${iconBg};">${iconText}</span>
                    <span class="msg">
                        <strong>${deviceDisplay}</strong> <small>${changeText}</small><br>
                        <small style="opacity: 0.7;">${timestamp}</small>
                    </span>
                    <div class="progress" style="background: ${progressBg};"></div>
                `;
                recentActivityList.appendChild(toast);
            });
        }

        // Load recent activity for dashboard
        async function loadRecentActivity(useCache = true) {
            try {
                const recentActivityList = document.getElementById('recentActivityList');
                if (!recentActivityList) return;

                // Load custom field names first to ensure they're available when rendering
                await loadCustomFieldNames();

                // Load devices to get building names mapping
                let deviceToBuildingMap = {};
                try {
                    const devicesResponse = await fetch(DEVICES_API_URL);
                    const devicesData = await devicesResponse.json();

                    if (devicesData.success && devicesData.data && Array.isArray(devicesData.data)) {
                        devicesData.data.forEach(device => {
                            if (device.deviceId && device.buildingName) {
                                deviceToBuildingMap[device.deviceId] = device.buildingName;
                            }
                        });
                    }
                } catch (devicesError) {
                    console.error('Error loading devices for building names:', devicesError);
                }

                // Try to load from cache first if useCache is true
                if (useCache) {
                    const cachedData = localStorage.getItem('dashboard_recentActivity');
                    const cachedTimestamp = localStorage.getItem('dashboard_recentActivity_timestamp');

                    if (cachedData && cachedTimestamp) {
                        try {
                            const events = JSON.parse(cachedData);
                            updateDailyAlertsCounter(events.length);
                            renderRecentActivity(events, deviceToBuildingMap);
                        } catch (e) {
                            console.error('Error parsing cached activity:', e);
                        }
                    }
                }

                // Fetch fresh data from API
                const apiData = await fetchReportsData();
                if (!apiData || !Array.isArray(apiData)) {
                    if (!useCache || !localStorage.getItem('dashboard_recentActivity')) {
                        recentActivityList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No recent activity</p>';
                    }
                    return;
                }

                // Get today's date in local timezone (YYYY-MM-DD format)
                const today = new Date();
                const todayStr = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;

                // Filter events from today only
                const todayEvents = apiData.filter(event => {
                    if (!event.timestamp) return false;
                    // Parse timestamp - format: "DD/MM/YYYY, HH:MM:SS (Bermuda Time)"
                    const parts = event.timestamp.split(', ');
                    if (parts.length < 1) return false;
                    const datePart = parts[0]; // "DD/MM/YYYY"
                    return datePart === todayStr;
                });

                if (todayEvents.length === 0) {
                    if (!useCache || !localStorage.getItem('dashboard_recentActivity')) {
                        recentActivityList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No activity today</p>';
                    }
                    updateDailyAlertsCounter(0);
                    return;
                }

                // Sort by timestamp descending (most recent first)
                const sortedData = [...todayEvents].sort((a, b) => {
                    // Parse timestamps - format: "DD/MM/YYYY, HH:MM:SS (Bermuda Time)"
                    const parseTimestamp = (ts) => {
                        if (!ts) return 0;
                        const parts = ts.split(', ');
                        if (parts.length < 2) return 0;
                        const datePart = parts[0].split('/');
                        const timePart = parts[1].split(' ')[0].split(':');
                        if (datePart.length !== 3 || timePart.length !== 3) return 0;
                        return new Date(
                            parseInt(datePart[2]), // year
                            parseInt(datePart[1]) - 1, // month (0-indexed)
                            parseInt(datePart[0]), // day
                            parseInt(timePart[0]), // hour
                            parseInt(timePart[1]), // minute
                            parseInt(timePart[2]) // second
                        ).getTime();
                    };
                    return parseTimestamp(b.timestamp) - parseTimestamp(a.timestamp);
                });

                // Save to cache
                localStorage.setItem('dashboard_recentActivity', JSON.stringify(sortedData));
                localStorage.setItem('dashboard_recentActivity_timestamp', Date.now().toString());

                // Update daily alerts counter
                updateDailyAlertsCounter(sortedData.length);

                // Render events with building names mapping
                renderRecentActivity(sortedData, deviceToBuildingMap);
            } catch (error) {
                console.error('Error loading recent activity:', error);
                const recentActivityList = document.getElementById('recentActivityList');
                if (recentActivityList && (!useCache || !localStorage.getItem('dashboard_recentActivity'))) {
                    recentActivityList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Error loading activity</p>';
                }
            }
        }

        // Function to convert timezone string to IANA timezone format - versiÃ³n universal
        function getIANATimezone(tzInput) {
            if (!tzInput) return 'Atlantic/Bermuda';

            let tz = tzInput.toString().trim();

            // Si ya es un timezone IANA vÃ¡lido, retornarlo tal cual
            if (tz.includes('/')) return tz;

            // Normalizar entrada
            tz = tz.toUpperCase().replace(/\s+/g, '');

            // Mapeo bÃ¡sico de offsets comunes
            const offsetMap = {
                'GMT-4': 'Atlantic/Bermuda',
                'UTC-4': 'Atlantic/Bermuda',
                'GMT-5': 'America/New_York',
                'UTC-5': 'America/New_York',
                'GMT-6': 'America/Chicago',
                'UTC-6': 'America/Chicago',
                'GMT-7': 'America/Denver',
                'UTC-7': 'America/Denver',
                'GMT-8': 'America/Los_Angeles',
                'UTC-8': 'America/Los_Angeles',
                'GMT+0': 'Europe/London',
                'UTC+0': 'Europe/London',
                'GMT+1': 'Europe/Paris',
                'UTC+1': 'Europe/Paris',
                'GMT+9': 'Asia/Tokyo',
                'UTC+9': 'Asia/Tokyo'
            };

            // Buscar coincidencia exacta
            if (offsetMap[tz]) {
                return offsetMap[tz];
            }

            // Intentar convertir GMT/UTC con offset
            const match = tz.match(/^(GMT|UTC)([+-])(\d{1,2})$/);
            if (match) {
                const sign = match[2] === '+' ? 1 : -1;
                const rawOffset = parseInt(match[3]) * sign;

                // Mapeo extendido basado en offset
                const offsetToIANA = {
                    '-12': 'Pacific/Midway',
                    '-11': 'Pacific/Samoa',
                    '-10': 'Pacific/Honolulu',
                    '-9': 'America/Anchorage',
                    '-8': 'America/Los_Angeles',
                    '-7': 'America/Denver',
                    '-6': 'America/Chicago',
                    '-5': 'America/New_York',
                    '-4': 'Atlantic/Bermuda',
                    '-3': 'America/Argentina/Buenos_Aires',
                    '-2': 'Atlantic/South_Georgia',
                    '-1': 'Atlantic/Azores',
                    '0': 'Europe/London',
                    '1': 'Europe/Paris',
                    '2': 'Europe/Berlin',
                    '3': 'Europe/Moscow',
                    '4': 'Asia/Dubai',
                    '5': 'Asia/Karachi',
                    '6': 'Asia/Dhaka',
                    '7': 'Asia/Bangkok',
                    '8': 'Asia/Shanghai',
                    '9': 'Asia/Tokyo',
                    '10': 'Australia/Sydney',
                    '11': 'Pacific/Guadalcanal',
                    '12': 'Pacific/Auckland'
                };

                const offsetKey = rawOffset.toString();
                if (offsetToIANA[offsetKey]) {
                    return offsetToIANA[offsetKey];
                }
            }

            // Si no se encuentra, usar Bermuda por defecto
            console.warn(`âš ï¸ Timezone "${tzInput}" no reconocido, usando Atlantic/Bermuda`);
            return 'Atlantic/Bermuda';
        }

        // Function to compress and resize image for PDF (reduces file size significantly, preserves transparency)
        // Returns: { base64: string, width: number, height: number }
        async function compressImageForPDF(imageUrl, maxWidth = 200, maxHeight = 200, quality = 0.9) {
            return new Promise((resolve, reject) => {
                try {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';

                    img.onload = function () {
                        try {
                            // Calculate new dimensions maintaining aspect ratio
                            let width = img.width;
                            let height = img.height;

                            if (width > maxWidth || height > maxHeight) {
                                const ratio = Math.min(maxWidth / width, maxHeight / height);
                                width = width * ratio;
                                height = height * ratio;
                            }

                            // Create canvas and draw resized image
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');

                            // Clear canvas to ensure transparency is preserved
                            ctx.clearRect(0, 0, width, height);

                            // Use better image smoothing
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';

                            // Draw image (preserves transparency)
                            ctx.drawImage(img, 0, 0, width, height);

                            // Convert to base64 as PNG to preserve transparency (quality parameter is ignored for PNG)
                            const compressedBase64 = canvas.toDataURL('image/png');
                            resolve({ base64: compressedBase64, width: width, height: height });
                        } catch (error) {
                            console.log('Error compressing image:', error);
                            // Fallback: try to fetch and return as base64 without compression
                            fetch(imageUrl)
                                .then(response => response.blob())
                                .then(blob => {
                                    const reader = new FileReader();
                                    reader.onloadend = () => {
                                        const img2 = new Image();
                                        img2.onload = () => {
                                            resolve({ base64: reader.result, width: img2.width, height: img2.height });
                                        };
                                        img2.onerror = () => resolve({ base64: reader.result, width: 50, height: 50 });
                                        img2.src = reader.result;
                                    };
                                    reader.onerror = reject;
                                    reader.readAsDataURL(blob);
                                })
                                .catch(reject);
                        }
                    };

                    img.onerror = function () {
                        // If image fails to load, try fetch as fallback
                        fetch(imageUrl)
                            .then(response => response.blob())
                            .then(blob => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    const img2 = new Image();
                                    img2.onload = () => {
                                        resolve({ base64: reader.result, width: img2.width, height: img2.height });
                                    };
                                    img2.onerror = () => resolve({ base64: reader.result, width: 50, height: 50 });
                                    img2.src = reader.result;
                                };
                                reader.onerror = reject;
                                reader.readAsDataURL(blob);
                            })
                            .catch(reject);
                    };

                    img.src = imageUrl;
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Function to generate and download PDF reports
        async function generateReportPDF() {
            try {
                // Load company data if not already loaded
                if (!globalLogoUrl || !globalSignatureUrl) {
                    await loadCompanyData();
                }
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    alert('Error: jsPDF library not loaded. Please refresh the page.');
                    return;
                }

                const reportMsg = document.getElementById('reportMsg');
                reportMsg.textContent = 'Fetching data from API...';
                reportMsg.className = 'success-msg';

                const reportType = document.getElementById('reportType').value;
                const deviceSelect = document.getElementById('reportDeviceSelect');
                const selectedDevice = deviceSelect.value;
                const comments = document.getElementById('reportComments').value;

                let startDate, endDate, dateRangeText;

                if (reportType === 'summary') {
                    const monthValue = document.getElementById('reportMonth').value;
                    if (!monthValue) {
                        reportMsg.textContent = 'Please select a month for Monthly Summary';
                        reportMsg.className = 'success-msg error';
                        return;
                    }

                    const [year, month] = monthValue.split('-');
                    startDate = `${year}-${month}-01`;
                    endDate = `${year}-${month}-${new Date(year, month, 0).getDate()}`;
                    dateRangeText = `${monthValue} (${startDate} to ${endDate})`;
                } else {
                    startDate = document.getElementById('reportStartDate').value;
                    endDate = document.getElementById('reportEndDate').value;

                    if (!startDate || !endDate) {
                        reportMsg.textContent = 'Please select both start and end dates';
                        reportMsg.className = 'success-msg error';
                        return;
                    }

                    const startDateObj = new Date(startDate);
                    const endDateObj = new Date(endDate);

                    if (isNaN(startDateObj.getTime()) || isNaN(endDateObj.getTime())) {
                        reportMsg.textContent = 'Invalid date format. Please select valid dates.';
                        reportMsg.className = 'success-msg error';
                        return;
                    }

                    if (startDateObj > endDateObj) {
                        reportMsg.textContent = 'Start date must be before end date';
                        reportMsg.className = 'success-msg error';
                        return;
                    }

                    const today = new Date();
                    today.setHours(23, 59, 59, 999);
                    if (startDateObj > today) {
                        reportMsg.textContent = 'Start date cannot be in the future';
                        reportMsg.className = 'success-msg error';
                        return;
                    }

                    dateRangeText = `${startDate} to ${endDate}`;
                }

                reportMsg.textContent = 'Processing data...';
                let apiData;
                try {
                    apiData = await fetchReportsData();
                } catch (error) {
                    reportMsg.textContent = 'Error: Could not fetch data from API. Please try again.';
                    reportMsg.className = 'success-msg error';
                    return;
                }

                if (!apiData || !Array.isArray(apiData)) {
                    reportMsg.textContent = 'Error: Invalid data received from API';
                    reportMsg.className = 'success-msg error';
                    return;
                }

                const filteredData = filterReportsData(apiData, selectedDevice, startDate, endDate, reportType);

                if (filteredData.length === 0) {
                    reportMsg.textContent = `No data found for the selected criteria. Total records in API: ${apiData.length}`;
                    reportMsg.className = 'success-msg error';
                    return;
                }

                reportMsg.textContent = 'Generating PDF...';

                let doc;
                try {
                    const { jsPDF } = window.jspdf;
                    doc = new jsPDF();
                } catch (error) {
                    reportMsg.textContent = 'Error: Could not create PDF document. Please refresh the page.';
                    reportMsg.className = 'success-msg error';
                    return;
                }

                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                let yPosition = margin;

                function addText(text, x, y, maxWidth, fontSize = 10) {
                    doc.setFontSize(fontSize);
                    const lines = doc.splitTextToSize(text, maxWidth);
                    doc.text(lines, x, y);
                    return y + (lines.length * fontSize * 0.4);
                }

                function checkNewPage(requiredSpace) {
                    if (yPosition + requiredSpace > pageHeight - margin) {
                        doc.addPage();
                        yPosition = margin;
                        return true;
                    }
                    return false;
                }

                // Add logo image if available, otherwise use text
                let logoAdded = false;
                let headerHeight = 30; // Default height if no logo

                if (globalLogoUrl && globalLogoUrl.trim() !== '') {
                    try {
                        // High quality logo (max 720x720px for good quality, preserves transparency)
                        const logoData = await compressImageForPDF(globalLogoUrl, 720, 720, 1.0);
                        // Calculate PDF dimensions maintaining aspect ratio (max 60mm height for better quality)
                        const maxPdfHeight = 60;
                        const aspectRatio = logoData.width / logoData.height;
                        let pdfWidth = maxPdfHeight * aspectRatio;
                        let pdfHeight = maxPdfHeight;

                        // If width exceeds reasonable limit, scale down but keep quality
                        if (pdfWidth > 120) {
                            pdfWidth = 120;
                            pdfHeight = pdfWidth / aspectRatio;
                        }

                        // Calculate header height based on logo size
                        headerHeight = pdfHeight + 10;

                        // Report header (white background)
                        doc.setFillColor(255, 255, 255);
                        doc.rect(0, 0, pageWidth, headerHeight, 'F');

                        doc.addImage(logoData.base64, 'PNG', margin, 5, pdfWidth, pdfHeight);
                        yPosition = pdfHeight + 10;
                        logoAdded = true;
                    } catch (imgError) {
                        console.log('Could not add logo image:', imgError);
                        // Fall back to text
                        doc.setFillColor(255, 255, 255);
                        doc.rect(0, 0, pageWidth, headerHeight, 'F');
                    }
                } else {
                    // Report header (white background) - no logo
                    doc.setFillColor(255, 255, 255);
                    doc.rect(0, 0, pageWidth, headerHeight, 'F');
                }

                // If logo was not added, use text
                if (!logoAdded) {
                    doc.setTextColor(0, 0, 0);
                    const reportTitle = globalCompanyName ? `${globalCompanyName.toUpperCase()} - SYSTEM REPORT` : 'SYSTEM REPORT';
                    yPosition = addText(reportTitle, margin, 20, pageWidth - 2 * margin, 16);
                }

                doc.setTextColor(0, 0, 0);
                yPosition += 10;

                // Report information
                const reportTypeText = {
                    'alarms': 'Alarm History Report',
                    'service': 'Service Log Report',
                    'summary': 'Monthly Summary Report'
                };

                yPosition = addText(`Report Type: ${reportTypeText[reportType]}`, margin, yPosition, pageWidth - 2 * margin, 12);
                yPosition = addText(`Device: ${selectedDevice === 'all' ? 'All Devices' : selectedDevice}`, margin, yPosition, pageWidth - 2 * margin, 12);
                yPosition = addText(`Date Range: ${dateRangeText}`, margin, yPosition, pageWidth - 2 * margin, 12);
                yPosition = addText(`Total Records: ${filteredData.length}`, margin, yPosition, pageWidth - 2 * margin, 12);
                const timezone = getIANATimezone(globalTimezone);
                const timezoneLabel = timezone.split('/').pop().replace(/_/g, ' ') + ' Time';
                const localNow = new Date().toLocaleString('en-US', {
                    timeZone: timezone,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                yPosition = addText(`Generated: ${localNow} (${timezoneLabel})`, margin, yPosition, pageWidth - 2 * margin, 12);

                yPosition += 15;

                if (comments && comments.trim()) {
                    checkNewPage(30);
                    doc.setFillColor(248, 249, 250);
                    doc.rect(margin, yPosition - 5, pageWidth - 2 * margin, 25, 'F');
                    yPosition = addText('Technician Comments:', margin, yPosition, pageWidth - 2 * margin, 10);
                    yPosition = addText(comments, margin, yPosition, pageWidth - 2 * margin, 9);
                    yPosition += 10;
                }

                checkNewPage(50);

                const tableHeaders = ['Timestamp', 'Device', 'Event', 'Previous Value', 'New Value'];
                const colWidths = [45, 30, 40, 30, 30];
                const colPositions = [margin];

                for (let i = 1; i < colWidths.length; i++) {
                    colPositions.push(colPositions[i - 1] + colWidths[i - 1]);
                }

                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition, pageWidth - 2 * margin, 15, 'F');

                tableHeaders.forEach((header, index) => {
                    doc.setFontSize(8);
                    doc.text(header, colPositions[index], yPosition + 10);
                });

                yPosition += 20;

                filteredData.forEach((item, index) => {
                    checkNewPage(15);

                    if (index % 2 === 0) {
                        doc.setFillColor(255, 255, 255);
                    } else {
                        doc.setFillColor(248, 249, 250);
                    }
                    doc.rect(margin, yPosition - 5, pageWidth - 2 * margin, 15, 'F');

                    const normalizeBoolean = (value) => {
                        const s = String(value).trim().toLowerCase();
                        return s === 'true' || value === true;
                    };
                    const rowData = [
                        item.timestamp,
                        item.device_id,
                        item.input_changed,
                        normalizeBoolean(item.old_value) ? 'TRUE' : 'FALSE',
                        normalizeBoolean(item.new_value) ? 'TRUE' : 'FALSE'
                    ];

                    rowData.forEach((data, colIndex) => {
                        doc.setFontSize(7);
                        const text = String(data).substring(0, 15);
                        doc.text(text, colPositions[colIndex], yPosition + 5);
                    });

                    yPosition += 15;
                });

                yPosition += 20;
                checkNewPage(60);

                doc.setFontSize(12);
                doc.text('STATISTICAL SUMMARY', margin, yPosition);
                yPosition += 15;

                const eventCounts = {};
                const deviceCounts = {};

                filteredData.forEach(item => {
                    eventCounts[item.input_changed] = (eventCounts[item.input_changed] || 0) + 1;
                    deviceCounts[item.device_id] = (deviceCounts[item.device_id] || 0) + 1;
                });

                doc.setFontSize(10);
                yPosition = addText('Events by Type:', margin, yPosition, pageWidth - 2 * margin, 10);

                Object.entries(eventCounts).forEach(([event, count]) => {
                    yPosition = addText(`  â€¢ ${event}: ${count} occurrences`, margin + 10, yPosition, pageWidth - 2 * margin, 9);
                });

                yPosition += 5;
                yPosition = addText('Events by Device:', margin, yPosition, pageWidth - 2 * margin, 10);

                Object.entries(deviceCounts).forEach(([device, count]) => {
                    yPosition = addText(`  â€¢ ${device}: ${count} events`, margin + 10, yPosition, pageWidth - 2 * margin, 9);
                });

                // Add signature image before footer if available
                if (globalSignatureUrl) {
                    try {
                        // Get the last page
                        const lastPage = doc.internal.getNumberOfPages();
                        doc.setPage(lastPage);

                        // Add signature at the bottom (leave space for footer)
                        const signatureY = pageHeight - 40;
                        try {
                            // Compress and resize signature before adding to PDF (max 200x80px, preserves transparency)
                            const signatureData = await compressImageForPDF(globalSignatureUrl, 200, 80, 0.9);
                            // Calculate PDF dimensions maintaining aspect ratio
                            const maxPdfWidth = 50;
                            const maxPdfHeight = 20;
                            const aspectRatio = signatureData.width / signatureData.height;
                            let pdfWidth = maxPdfWidth;
                            let pdfHeight = maxPdfWidth / aspectRatio;

                            // If height exceeds limit, scale down
                            if (pdfHeight > maxPdfHeight) {
                                pdfHeight = maxPdfHeight;
                                pdfWidth = maxPdfHeight * aspectRatio;
                            }

                            doc.addImage(signatureData.base64, 'PNG', margin, signatureY, pdfWidth, pdfHeight);
                        } catch (imgError) {
                            // If image fails, skip signature
                            console.log('Could not add signature image:', imgError);
                        }
                    } catch (error) {
                        console.log('Error adding signature:', error);
                    }
                }

                // Footer
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - 30, pageHeight - 10);
                    const footerText = globalCompanyName ? `Generated by ${globalCompanyName} System` : 'Generated by Elevator System';
                    doc.text(footerText, margin, pageHeight - 10);
                }

                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const deviceSuffix = selectedDevice === 'all' ? 'all' : selectedDevice;
                const filename = `bermuda_report_${reportType}_${deviceSuffix}_${timestamp}.pdf`;

                doc.save(filename);

                reportMsg.textContent = `Report generated successfully: ${filename}`;
                reportMsg.className = 'success-msg success';
            } catch (error) {
                const reportMsg = document.getElementById('reportMsg');
                reportMsg.textContent = `Error generating report: ${error.message}`;
                reportMsg.className = 'success-msg error';
            }
        }

        // Reports functionality
        document.addEventListener('DOMContentLoaded', function () {
            const reportType = document.getElementById('reportType');
            const dateRangeContainer = document.getElementById('dateRangeContainer');
            const monthSelectorContainer = document.getElementById('monthSelectorContainer');

            if (reportType) {
                reportType.addEventListener('change', function () {
                    if (this.value === 'summary') {
                        dateRangeContainer.style.display = 'none';
                        monthSelectorContainer.style.display = 'block';
                    } else {
                        dateRangeContainer.style.display = 'grid';
                        monthSelectorContainer.style.display = 'none';
                    }
                });
            }

            const generateReportBtn = document.getElementById('generateReportBtn');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    generateReportPDF();
                });
            }
        });

        // Load devices when reports section is opened
        function showReports(event) {
            event.preventDefault();
            const mainContent = document.getElementById('mainContent');
            const companySection = document.getElementById('companyDataSection');
            const usersSection = document.getElementById('usersSection');
            const notificationsSection = document.getElementById('notificationsSection');
            const devicesSection = document.getElementById('devicesSection');
            const reportsSection = document.getElementById('reportsSection');
            const buildingsSection = document.getElementById('buildingsSection');
            const rightSidebar = document.getElementById('rightSidebar');
            const dashboardMenuItem = document.getElementById('dashboardMenuItem');
            const companyDataMenuItem = document.getElementById('companyDataMenuItem');
            const usersMenuItem = document.getElementById('usersMenuItem');
            const notificationsMenuItem = document.getElementById('notificationsMenuItem');
            const devicesMenuItem = document.getElementById('devicesMenuItem');
            const reportsMenuItem = document.getElementById('reportsMenuItem');
            const buildingsMenuItem = document.getElementById('buildingsMenuItem');

            mainContent.style.display = 'none';
            rightSidebar.style.display = 'none';
            companySection.style.display = 'none';
            usersSection.style.display = 'none';
            notificationsSection.style.display = 'none';
            devicesSection.style.display = 'none';
            buildingsSection.style.display = 'none';
            reportsSection.style.display = 'block';
            dashboardMenuItem.classList.remove('active');
            companyDataMenuItem.classList.remove('active');
            usersMenuItem.classList.remove('active');
            notificationsMenuItem.classList.remove('active');
            devicesMenuItem.classList.remove('active');
            reportsMenuItem.classList.add('active');
            buildingsMenuItem.classList.remove('active');
            // Load devices when section is opened
            loadReportDevices();
        }
    </script>

    <script>
        // Login functionality
        function setAuthState(isLoggedIn) {
            const loginContainer = document.getElementById('loginContainer');
            const dashboardContainer = document.getElementById('dashboardContainer');
            if (isLoggedIn) {
                document.documentElement.classList.add('logged-in');
                document.documentElement.classList.remove('not-logged-in');
                loginContainer.style.display = 'none';
                dashboardContainer.classList.add('active');
            } else {
                document.documentElement.classList.add('not-logged-in');
                document.documentElement.classList.remove('logged-in');
                loginContainer.style.display = 'flex';
                dashboardContainer.classList.remove('active');
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            const loginError = document.getElementById('loginError');
            const validEmail = 'admin@codex.com';
            const validPassword = 'Bx9#mK7pL2qR';

            const email = (emailInput.value || '').trim().toLowerCase();
            const password = (passwordInput.value || '').trim();

            if (!email || !password) {
                loginError.textContent = 'Please enter both email and password.';
                loginError.style.display = 'block';
                return;
            }

            if (email === validEmail && password === validPassword) {
                localStorage.setItem('isLoggedIn', 'true');
                setAuthState(true);
                loginError.style.display = 'none';
            } else {
                loginError.textContent = 'Invalid email or password. Please try again.';
                loginError.style.display = 'block';
            }
        }

        // Check if user is already logged in (optional - using localStorage)
        document.addEventListener('DOMContentLoaded', function () {
            // LOGIN DESHABILITADO - Siempre entrar como logueado
            const isLoggedIn = true; // Antes: localStorage.getItem('isLoggedIn') === 'true';
            setAuthState(isLoggedIn);
        });

        // Logout Modal functionality
        function openLogoutModal(event) {
            event.preventDefault();
            document.getElementById('logoutModal').style.display = 'flex';
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        function handleLogout() {
            // Clear login state
            localStorage.removeItem('isLoggedIn');
            // Hide dashboard and show login
            setAuthState(false);
            // Clear login form
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            // Close modal
            closeLogoutModal();
        }

        // Company Data API functions
        const API_URL = 'https://script.google.com/macros/s/AKfycbyMB7QouKTWnRwNzxhE9xgrZaXY6GATvTF-fsfaR3gFRE6tLJk3Fnw_ta6lRnBKD0_q/exec';

        function updateCompanyData(field, event) {
            event.preventDefault();

            // Get all current values
            const companyName = document.getElementById('companyNameInput').value || '';
            const logo = document.getElementById('logoInput').value || '';
            const adminEmail = document.getElementById('adminEmailInput').value || '';
            const timezone = document.getElementById('timezoneInput').value || '';
            const signatureUrl = document.getElementById('signatureUrlInput').value || '';

            // Set form values
            document.getElementById('formCompanyName').value = companyName;
            document.getElementById('formLogo').value = logo;
            document.getElementById('formAdminEmail').value = adminEmail;
            document.getElementById('formTimezone').value = timezone;
            document.getElementById('formSignatureUrl').value = signatureUrl;

            // Submit form
            document.getElementById('apiForm').submit();

            // Show success message
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check" style="margin-right: 5px;"></i>Updated!';
            button.style.background = '#22c55e';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.background = '';
            }, 2000);
        }

        // Global variables for company data
        let globalCompanyLogo = '';
        let globalSignatureUrl = '';
        let globalLogoUrl = ''; // Alias for globalCompanyLogo (for compatibility with dispositivos.html)
        let globalCompanyName = '';
        let globalTimezone = 'Atlantic/Bermuda';

        // Load company data from API
        async function loadCompanyData(useCache = true) {
            try {
                // Try to load from cache first if useCache is true
                if (useCache) {
                    const cachedData = localStorage.getItem('dashboard_companyData');
                    const cachedTimestamp = localStorage.getItem('dashboard_companyData_timestamp');

                    if (cachedData && cachedTimestamp) {
                        try {
                            const data = JSON.parse(cachedData);
                            updateDisplayElements(data);

                            // Update loading screen logo text
                            if (data.companyName) {
                                updateLoadingLogoText(data.companyName);
                            }

                            // Store global values
                            const rawLogo = data.logo || '';
                            globalCompanyLogo = rawLogo.replace(/\[img\]/g, '').replace(/\[\/img\]/g, '').trim();
                            globalLogoUrl = globalCompanyLogo; // Alias for compatibility

                            const rawSignature = data.signatureUrl || '';
                            globalSignatureUrl = rawSignature.replace(/\[img\]/g, '').replace(/\[\/img\]/g, '').trim();

                            globalCompanyName = data.companyName || '';
                            globalTimezone = data.timezone || 'Atlantic/Bermuda';
                        } catch (e) {
                            console.error('Error parsing cached company data:', e);
                        }
                    }
                }

                // Fetch fresh data from API
                const response = await fetch(API_URL);
                const result = await response.json();

                if (result.success && result.data) {
                    // Handle both array and object formats
                    const data = Array.isArray(result.data) ? result.data[0] : result.data;

                    // Update loading screen logo text
                    if (data.companyName) {
                        updateLoadingLogoText(data.companyName);
                    }

                    if (data) {
                        // Save to cache
                        localStorage.setItem('dashboard_companyData', JSON.stringify(data));
                        localStorage.setItem('dashboard_companyData_timestamp', Date.now().toString());

                        // Store global values (clean URLs by removing [img] tags)
                        const rawLogo = data.logo || '';
                        globalCompanyLogo = rawLogo.replace(/\[img\]/g, '').replace(/\[\/img\]/g, '').trim();
                        globalLogoUrl = globalCompanyLogo; // Alias for compatibility

                        const rawSignature = data.signatureUrl || '';
                        globalSignatureUrl = rawSignature.replace(/\[img\]/g, '').replace(/\[\/img\]/g, '').trim();

                        globalCompanyName = data.companyName || '';
                        globalTimezone = data.timezone || 'Atlantic/Bermuda';

                        // Update input fields
                        if (data.companyName) {
                            document.getElementById('companyNameInput').value = data.companyName;
                        }
                        if (data.logo) {
                            // Remove [img] tags if present
                            const logoValue = data.logo.replace(/\[img\]/g, '').replace(/\[\/img\]/g, '');
                            document.getElementById('logoInput').value = logoValue;
                        }
                        if (data.adminEmail) {
                            document.getElementById('adminEmailInput').value = data.adminEmail;
                        }
                        if (data.timezone) {
                            document.getElementById('timezoneInput').value = data.timezone;
                        }
                        if (data.signatureUrl) {
                            // Remove [img] tags if present
                            const signatureValue = data.signatureUrl.replace(/\[img\]/g, '').replace(/\[\/img\]/g, '');
                            document.getElementById('signatureUrlInput').value = signatureValue;
                        }

                        // Update display elements
                        updateDisplayElements(data);
                    }
                }
            } catch (error) {
                console.error('Error loading company data:', error);
                // If error and no cache, show error message
                if (!useCache || !localStorage.getItem('dashboard_companyData')) {
                    console.error('No cached data available');
                }
            }
        }

        // Email Configuration API functions
        const EMAIL_CONFIG_URL = 'https://script.google.com/macros/s/AKfycbxFdhEMkxNW-umxKiRkevwzL8Nl90DBUe-eJnamcJW2KlREmLSwtlLe2fVkIEMc9RmhdQ/exec';

        // Load email configuration from API
        async function loadEmailConfig() {
            try {
                // Load alerta configuration
                const responseAlerta = await fetch(EMAIL_CONFIG_URL + '?tipo=alerta');
                const resultAlerta = await responseAlerta.json();

                if (resultAlerta.success && resultAlerta.data) {
                    const data = resultAlerta.data;
                    
                    // Update alerta input fields
                    if (data.emailTitle) {
                        document.getElementById('emailTitleAlertaInput').value = data.emailTitle;
                    }
                    if (data.emailMessage) {
                        document.getElementById('emailMessageAlertaInput').value = data.emailMessage;
                    }
                    if (data.ignoreMessage) {
                        document.getElementById('ignoreMessageAlertaInput').value = data.ignoreMessage;
                    }
                    if (data.bottomMessage) {
                        document.getElementById('bottomMessageAlertaInput').value = data.bottomMessage;
                    }
                }

                // Load resuelto configuration
                const responseResuelto = await fetch(EMAIL_CONFIG_URL + '?tipo=resuelto');
                const resultResuelto = await responseResuelto.json();

                if (resultResuelto.success && resultResuelto.data) {
                    const data = resultResuelto.data;
                    
                    // Update resuelto input fields
                    if (data.emailTitle) {
                        document.getElementById('emailTitleResueltoInput').value = data.emailTitle;
                    }
                    if (data.emailMessage) {
                        document.getElementById('emailMessageResueltoInput').value = data.emailMessage;
                    }
                    if (data.ignoreMessage) {
                        document.getElementById('ignoreMessageResueltoInput').value = data.ignoreMessage;
                    }
                    if (data.bottomMessage) {
                        document.getElementById('bottomMessageResueltoInput').value = data.bottomMessage;
                    }
                }
            } catch (error) {
                console.error('Error loading email configuration:', error);
            }
        }

        // Update email configuration
        function updateEmailConfig(tipo, event) {
            event.preventDefault();

            let emailTitle, emailMessage, ignoreMessage, bottomMessage;
            let formId, iframeId, buttonText;

            if (tipo === 'alerta') {
                // Get alerta values
                emailTitle = document.getElementById('emailTitleAlertaInput').value || '';
                emailMessage = document.getElementById('emailMessageAlertaInput').value || '';
                ignoreMessage = document.getElementById('ignoreMessageAlertaInput').value || '';
                bottomMessage = document.getElementById('bottomMessageAlertaInput').value || '';
                
                // Set form values
                document.getElementById('formEmailTitleAlerta').value = emailTitle;
                document.getElementById('formEmailMessageAlerta').value = emailMessage;
                document.getElementById('formIgnoreMessageAlerta').value = ignoreMessage;
                document.getElementById('formBottomMessageAlerta').value = bottomMessage;
                
                formId = 'emailConfigAlertaForm';
                iframeId = 'hiddenEmailConfigAlertaIframe';
                buttonText = 'Save Alert Email Configuration';
            } else if (tipo === 'resuelto') {
                // Get resuelto values
                emailTitle = document.getElementById('emailTitleResueltoInput').value || '';
                emailMessage = document.getElementById('emailMessageResueltoInput').value || '';
                ignoreMessage = document.getElementById('ignoreMessageResueltoInput').value || '';
                bottomMessage = document.getElementById('bottomMessageResueltoInput').value || '';
                
                // Set form values
                document.getElementById('formEmailTitleResuelto').value = emailTitle;
                document.getElementById('formEmailMessageResuelto').value = emailMessage;
                document.getElementById('formIgnoreMessageResuelto').value = ignoreMessage;
                document.getElementById('formBottomMessageResuelto').value = bottomMessage;
                
                formId = 'emailConfigResueltoForm';
                iframeId = 'hiddenEmailConfigResueltoIframe';
                buttonText = 'Save Resolved Email Configuration';
            } else {
                console.error('Invalid email type:', tipo);
                return;
            }

            // Set up iframe onload handler
            const hiddenEmailConfigIframe = document.getElementById(iframeId);
            hiddenEmailConfigIframe.onload = function() {
                // Show success message
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check" style="margin-right: 8px;"></i>Configuration Saved!';
                button.style.background = '#22c55e';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
                
                // Reload email config to ensure sync
                setTimeout(() => {
                    loadEmailConfig();
                }, 500);
            };

            // Submit form
            document.getElementById(formId).submit();

            // Fallback timeout in case iframe onload doesn't fire
            setTimeout(() => {
                const button = event.target;
                if (button.innerHTML.includes('Save')) {
                    button.innerHTML = '<i class="fas fa-check" style="margin-right: 8px;"></i>Configuration Saved!';
                    button.style.background = '#22c55e';
                    setTimeout(() => {
                        button.innerHTML = '<i class="fas fa-save" style="margin-right: 8px;"></i>' + buttonText;
                        button.style.background = '';
                    }, 2000);
                    loadEmailConfig();
                }
            }, 3000);
        }

        // Update display elements in dashboard
        function updateDisplayElements(data) {
            if (data.companyName) {
                const companyNameDisplay = document.getElementById('companyNameDisplay');
                if (companyNameDisplay) companyNameDisplay.textContent = data.companyName;
            }
            if (data.adminEmail) {
                const adminEmailDisplay = document.getElementById('adminEmailDisplay');
                if (adminEmailDisplay) adminEmailDisplay.textContent = data.adminEmail;
            }
            if (data.timezone) {
                const timezoneDisplay = document.getElementById('timezoneDisplay');
                if (timezoneDisplay) timezoneDisplay.textContent = data.timezone;
            }
            if (data.logo) {
                const logoDisplay = document.getElementById('logoDisplay');
                if (logoDisplay) {
                    const logoValue = data.logo.replace(/\[img\]/g, '').replace(/\[\/img\]/g, '').trim();
                    if (logoValue && (logoValue.startsWith('http') || logoValue.startsWith('data:'))) {
                        // Find the parent course-card and replace its content with the logo image
                        const courseCard = logoDisplay.closest('.course-card');
                        if (courseCard) {
                            // Replace entire card content with logo image that fills the card
                            courseCard.innerHTML = `<img src="${logoValue}" id="logoDisplay" style="width: 100%; height: 100%; object-fit: contain; border-radius: 20px; display: block;">`;
                        } else {
                            // Fallback: replace just the icon
                            logoDisplay.outerHTML = `<img src="${logoValue}" id="logoDisplay" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">`;
                        }
                    } else if (logoValue) {
                        // If it's not a URL, try to use it as a class name
                        logoDisplay.className = logoValue;
                    }
                }
            }
            if (data.signatureUrl) {
                const signatureImageDisplay = document.getElementById('signatureImageDisplay');
                if (signatureImageDisplay) {
                    const signatureValue = data.signatureUrl.replace(/\[img\]/g, '').replace(/\[\/img\]/g, '').trim();
                    if (signatureValue && (signatureValue.startsWith('http') || signatureValue.startsWith('data:'))) {
                        // Find the parent course-card and replace its content with the signature image
                        const courseCard = signatureImageDisplay.closest('.course-card');
                        if (courseCard) {
                            // Replace entire card content with signature image that fills the card
                            courseCard.innerHTML = `<img src="${signatureValue}" id="signatureImageDisplay" alt="Signature" style="width: 100%; height: 100%; object-fit: contain; border-radius: 20px; display: block;">`;
                        } else {
                            // Fallback: update just the image src
                            signatureImageDisplay.src = signatureValue;
                        }
                    } else if (signatureValue) {
                        // Fallback: update just the image src
                        signatureImageDisplay.src = signatureValue;
                    }
                }
            }
        }

        // Users API functions
        const USERS_API_URL = 'https://script.google.com/macros/s/AKfycbwpVMDk_-c1UTk5GX-G4P2QHv00tI23ny11Jq7BSGCcZMQgtuBzszNeZFP33JVdWSKDjQ/exec';

        // Render random users in the list
        function renderRandomUsers(users) {
            const randomUsersList = document.getElementById('randomUsersList');
            if (!randomUsersList) return;

            randomUsersList.innerHTML = '';

            if (!users || users.length === 0) {
                randomUsersList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No users found</p>';
                return;
            }

            // Icon colors and backgrounds
            const iconStyles = [
                { bg: '#ffebee', color: '#c62828' },
                { bg: '#e8eaf6', color: '#5e35b1' },
                { bg: '#e8f5e9', color: '#2e7d32' },
                { bg: '#fff3e0', color: '#f57c00' },
                { bg: '#e3f2fd', color: '#1976d2' }
            ];

            users.forEach((user, index) => {
                // Get name from email
                const emailParts = user.email.split('@');
                const name = emailParts[0].split('.')[0];
                const displayName = name.charAt(0).toUpperCase() + name.slice(1) + (emailParts[0].split('.')[1] ? ' ' + emailParts[0].split('.')[1].charAt(0).toUpperCase() + emailParts[0].split('.')[1].slice(1) : '');

                // Determine status
                const currentEstado = user.estado || '';
                const isPaused = currentEstado.toLowerCase() === 'pause';
                const statusText = isPaused ? 'Paused' : 'Active';

                // Get icon style (cycle through if more than 5 users)
                const iconStyle = iconStyles[index % iconStyles.length];

                const userItem = document.createElement('div');
                userItem.className = 'schedule-item';
                userItem.innerHTML = `
                    <div class="schedule-icon" style="background: ${iconStyle.bg};">
                        <i class="fas fa-user" style="color: ${iconStyle.color};"></i>
                    </div>
                    <div class="schedule-content">
                        <h4>${displayName}</h4>
                        <p>${statusText}</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                `;
                randomUsersList.appendChild(userItem);
            });
        }

        // Load 5 random users for dashboard
        async function loadRandomUsers(useCache = true) {
            try {
                const randomUsersList = document.getElementById('randomUsersList');
                if (!randomUsersList) return;

                // Try to load from cache first if useCache is true
                if (useCache) {
                    const cachedData = localStorage.getItem('dashboard_randomUsers');
                    const cachedTimestamp = localStorage.getItem('dashboard_randomUsers_timestamp');

                    if (cachedData && cachedTimestamp) {
                        try {
                            const users = JSON.parse(cachedData);
                            renderRandomUsers(users);
                        } catch (e) {
                            console.error('Error parsing cached users:', e);
                        }
                    }
                }

                // Fetch fresh data from API
                const response = await fetch(USERS_API_URL);
                const result = await response.json();

                if (result.success && result.data && Array.isArray(result.data)) {
                    // Filter users with valid emails
                    const validUsers = result.data.filter(user => user.email && user.email.trim() !== '');

                    if (validUsers.length === 0) {
                        if (!useCache || !localStorage.getItem('dashboard_randomUsers')) {
                            randomUsersList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No users found</p>';
                        }
                        return;
                    }

                    // Get first 5 users sorted alphabetically by email
                    const sortedUsers = validUsers.sort((a, b) => {
                        const emailA = (a.email || '').toLowerCase();
                        const emailB = (b.email || '').toLowerCase();
                        return emailA.localeCompare(emailB);
                    });
                    const randomUsers = sortedUsers.slice(0, Math.min(5, sortedUsers.length));

                    // Save to cache
                    localStorage.setItem('dashboard_randomUsers', JSON.stringify(randomUsers));
                    localStorage.setItem('dashboard_randomUsers_timestamp', Date.now().toString());

                    // Render users
                    renderRandomUsers(randomUsers);
                } else {
                    if (!useCache || !localStorage.getItem('dashboard_randomUsers')) {
                        randomUsersList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Error loading users</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading random users:', error);
                const randomUsersList = document.getElementById('randomUsersList');
                if (randomUsersList && (!useCache || !localStorage.getItem('dashboard_randomUsers'))) {
                    randomUsersList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Error loading users</p>';
                }
            }
        }

        // Load users from API with cached fallback
        async function loadUsers() {
            const usersList = document.getElementById('usersList');
            if (!usersList) return;

            let renderedFromCache = false;

            // Try to load cached users first so the UI never looks empty
            try {
                const cachedUsers = localStorage.getItem('users_list_cache');
                if (cachedUsers) {
                    const parsedUsers = JSON.parse(cachedUsers);
                    if (Array.isArray(parsedUsers) && parsedUsers.length > 0) {
                        renderUsersList(parsedUsers);
                        renderedFromCache = true;
                    }
                }
            } catch (cacheError) {
                console.error('Error parsing cached users list:', cacheError);
                localStorage.removeItem('users_list_cache');
                localStorage.removeItem('users_list_cache_timestamp');
            }

            if (!renderedFromCache) {
                usersList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">Loading users...</p>';
            }

            try {
                const response = await fetch(USERS_API_URL);
                const result = await response.json();

                if (result.success && result.data && Array.isArray(result.data)) {
                    const validUsers = result.data.filter(user => user && user.email && user.email.trim() !== '');

                    if (validUsers.length === 0) {
                        usersList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No users found</p>';
                        localStorage.removeItem('users_list_cache');
                        localStorage.removeItem('users_list_cache_timestamp');
                        return;
                    }

                    // Persist data for future fallback
                    localStorage.setItem('users_list_cache', JSON.stringify(validUsers));
                    localStorage.setItem('users_list_cache_timestamp', Date.now().toString());

                    renderUsersList(validUsers);
                } else if (!renderedFromCache) {
                    usersList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">Error loading users</p>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                if (!renderedFromCache) {
                    usersList.innerHTML = '<p style="text-align: center; color: #ef5350; padding: 40px;">Error loading users. Please try again.</p>';
                }
            }
        }

        function renderUsersList(users) {
            const usersList = document.getElementById('usersList');
            if (!usersList) return;

            usersList.innerHTML = '';

            if (!Array.isArray(users) || users.length === 0) {
                usersList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No users found</p>';
                return;
            }

            const roleColors = {
                'Client': '#667eea',
                'Technician': '#22c55e',
                'Admin': '#ef5350'
            };

            users.forEach((user, index) => {
                if (!user || !user.email) {
                    return;
                }

                const email = user.email.trim();
                if (!email) {
                    return;
                }

                const emailParts = email.split('@');
                const initials = emailParts[0].substring(0, 2).toUpperCase();
                const emailNameParts = emailParts[0].split('.');
                const computedName = emailNameParts
                    .filter(Boolean)
                    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                    .join(' ');
                const displayName = user.name || computedName || initials;

                const roleColor = roleColors[user.role] || '#667eea';

                const currentEstado = user.estado || '';
                const isPaused = currentEstado.toLowerCase() === 'pause';
                const statusText = isPaused ? 'Paused' : 'Active';
                const statusBg = isPaused ? '#fff3e0' : '#e8f5e9';
                const statusColor = isPaused ? '#f57c00' : '#2e7d32';
                const pauseButtonText = isPaused ? 'Resume' : 'Pause';
                const pauseButtonIcon = isPaused ? 'fa-play' : 'fa-pause';
                const newEstado = isPaused ? 'active' : 'pause';

                const escapedEmail = email.replace(/'/g, "\\'");
                const borderStyle = index < users.length - 1 ? '1px solid #f0f0f0' : 'none';

                const userHTML = `
                    <div style="display: flex; align-items: center; gap: 20px; padding: 20px; border-bottom: ${borderStyle};">
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, ${roleColor} 0%, ${roleColor}dd 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                            ${initials}
                        </div>
                        <div style="flex: 1;">
                            <h3 style="font-size: 18px; color: #1a1a2e; margin-bottom: 5px;">${displayName}</h3>
                            <p style="color: #888; font-size: 14px; margin-bottom: 5px;">${email}</p>
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <span style="background: ${roleColor}20; color: ${roleColor}; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${user.role || 'Client'}</span>
                                ${user.builds ? `<span style="background: #e8f5e9; color: #2e7d32; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${user.builds}</span>` : ''}
                            </div>
                        </div>
                        <div style="text-align: right; margin-right: 20px;">
                            <p style="color: #888; font-size: 12px; margin-bottom: 5px;">Status</p>
                            <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${statusText}</span>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button onclick="toggleUserStatus('${escapedEmail}', '${newEstado}')" style="padding: 8px 16px; border-radius: 8px; border: 2px solid #ffa726; background: white; color: #ffa726; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s;">
                                <i class="fas ${pauseButtonIcon}" style="margin-right: 5px;"></i>${pauseButtonText}
                            </button>
                            <button onclick="deleteUser('${escapedEmail}'); return false;" style="padding: 8px 16px; border-radius: 8px; border: 2px solid #ef5350; background: white; color: #ef5350; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s;">
                                <i class="fas fa-trash" style="margin-right: 5px;"></i>Delete
                            </button>
                            <button style="padding: 8px 16px; border-radius: 8px; border: 2px solid #667eea; background: white; color: #667eea; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s;">
                                <i class="fas fa-mobile-alt" style="margin-right: 5px;"></i>Devices
                            </button>
                        </div>
                    </div>
                `;

                usersList.innerHTML += userHTML;
            });
        }

        function saveUser(event) {
            event.preventDefault();

            // Get form values
            const email = document.getElementById('userEmailInput').value.trim();
            const password = document.getElementById('userPasswordInput').value.trim();
            const roleType = document.getElementById('userRoleInput').value;

            // Validate fields
            if (!email || !password || !roleType) {
                alert('Please fill in all fields');
                return;
            }

            // Map role values to match API format (capitalize first letter)
            const roleMap = {
                'client': 'Client',
                'technician': 'Technician',
                'admin': 'Admin'
            };
            const formattedRole = roleMap[roleType.toLowerCase()] || roleType;

            // Set builds value: "All Buildings" for Admin and Technician, empty for Client
            let buildsValue = '';
            if (formattedRole === 'Admin' || formattedRole === 'Technician') {
                buildsValue = 'All Buildings';
            }

            // Set form values
            document.getElementById('formUserEmail').value = email;
            document.getElementById('formUserPassword').value = password;
            document.getElementById('formUserRole').value = formattedRole;
            document.getElementById('formUserBuilds').value = buildsValue;

            // Submit form
            document.getElementById('usersApiForm').submit();

            // Show success message
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check" style="margin-right: 5px;"></i>Saved!';
            button.style.background = '#22c55e';
            button.disabled = true;

            // Clear form and close after delay, then reload users
            setTimeout(() => {
                document.getElementById('userEmailInput').value = '';
                document.getElementById('userPasswordInput').value = '';
                document.getElementById('userRoleInput').value = '';
                toggleAddUserForm();
                button.innerHTML = originalText;
                button.style.background = '';
                button.disabled = false;
                // Reload users list
                loadUsers();
            }, 2000);
        }

        // Toggle user status (pause/active)
        async function toggleUserStatus(email, newEstado) {
            try {
                // First, get all user data from API to preserve all fields
                const response = await fetch(USERS_API_URL);
                const result = await response.json();

                if (result.success && result.data && Array.isArray(result.data)) {
                    // Find the user to update
                    const userToUpdate = result.data.find(user => user.email && user.email.trim() === email.trim());

                    if (!userToUpdate) {
                        alert('User not found');
                        return;
                    }

                    // Get form and inputs
                    const form = document.getElementById('userStatusForm');
                    const emailInput = document.getElementById('formStatusEmail');
                    const passwordInput = document.getElementById('formStatusPassword');
                    const roleInput = document.getElementById('formStatusRole');
                    const estadoInput = document.getElementById('formEstado');
                    const buildsInput = document.getElementById('formStatusBuilds');

                    // Clear previous values
                    emailInput.value = '';
                    passwordInput.value = '';
                    roleInput.value = '';
                    estadoInput.value = '';
                    buildsInput.value = '';

                    // Set form values - preserve all user data, only change estado
                    emailInput.value = String(userToUpdate.email || email).trim();
                    passwordInput.value = String(userToUpdate.password || '').trim();
                    roleInput.value = String(userToUpdate.role || '').trim();
                    estadoInput.value = String(newEstado).trim();
                    buildsInput.value = String(userToUpdate.builds || '').trim();

                    // Submit form
                    form.submit();

                    // Show loading state
                    const usersList = document.getElementById('usersList');
                    usersList.innerHTML = '<p style="text-align: center; color: #667eea; padding: 40px;"><i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i>Updating status...</p>';

                    // Reload users list after a delay to allow API to process
                    setTimeout(() => {
                        loadUsers();
                    }, 2000);
                } else {
                    alert('Error loading user data');
                }
            } catch (error) {
                console.error('Error updating user status:', error);
                alert('Error updating user status. Please try again.');
            }
        }

        // Variable to store the email of the user to delete
        let userEmailToDelete = '';

        // Delete user - abre modal de confirmaciÃ³n
        function deleteUser(email) {
            // Prevenir comportamiento por defecto si hay alguno
            if (typeof event !== 'undefined') {
                event.preventDefault();
                event.stopPropagation();
            }

            userEmailToDelete = email;
            const emailDisplay = document.getElementById('deleteUserEmailDisplay');
            const modal = document.getElementById('deleteUserModal');

            if (emailDisplay) {
                emailDisplay.textContent = email;
            }

            if (modal) {
                modal.style.display = 'flex';
            } else {
                console.error('Modal deleteUserModal not found');
            }
        }

        // Cerrar modal de confirmaciÃ³n de eliminaciÃ³n
        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').style.display = 'none';
            userEmailToDelete = '';
        }

        // Confirmar eliminaciÃ³n de usuario
        function confirmDeleteUser() {
            if (!userEmailToDelete) {
                return;
            }

            // Cerrar modal
            closeDeleteUserModal();

            // Obtener el formulario de eliminaciÃ³n
            const deleteForm = document.getElementById('deleteUserForm');
            const emailInput = document.getElementById('deleteUserEmail');

            // Establecer el correo del usuario
            emailInput.value = userEmailToDelete;

            // Enviar el formulario
            deleteForm.submit();

            // Mostrar indicador de actualizaciÃ³n
            const usersList = document.getElementById('usersList');
            if (usersList) {
                usersList.innerHTML = '<p style="text-align: center; color: #667eea; padding: 40px;"><i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i>Deleting user...</p>';
            }

            // Esperar un momento para que el servidor procese la eliminaciÃ³n
            setTimeout(() => {
                // Recargar lista de usuarios
                loadUsers();
            }, 2000); // Esperar 2 segundos para que el servidor procese
        }

        // FunciÃ³n para generar identificador Ãºnico de email
        async function generateUniqueEmail(baseEmail) {
            let uniqueEmail = baseEmail;
            let counter = 1;

            try {
                // Consultar la API real para obtener todos los dispositivos
                const response = await fetch('https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec');
                const data = await response.json();

                if (data.success && data.data) {
                    // Extraer todos los emails de dispositivos de la API
                    const existingEmails = data.data
                        .map(device => device.clientEmail)
                        .filter(email => email && email !== -1 && email !== '-1');

                    // Buscar emails que coincidan con el patrÃ³n base-XX
                    const baseEmailPattern = new RegExp(`^${baseEmail.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(-\\d+)?$`);
                    const matchingEmails = existingEmails.filter(email => baseEmailPattern.test(email));

                    if (matchingEmails.length > 0) {
                        // Buscar el siguiente nÃºmero disponible
                        while (matchingEmails.includes(`${baseEmail}-${counter}`)) {
                            counter++;
                        }

                        uniqueEmail = `${baseEmail}-${counter}`;
                    }
                }
            } catch (error) {
                // Si hay error, usar el email base
            }

            return uniqueEmail;
        }

        // FunciÃ³n para limpiar formulario de dispositivo
        function clearDeviceForm() {
            document.getElementById('newId').value = '';
            document.getElementById('newBld').value = '';
            document.getElementById('newUnit').value = '';
            document.getElementById('newEmail').value = '';
            const deviceMsg = document.getElementById('deviceMsg');
            if (deviceMsg) {
                deviceMsg.textContent = '';
                deviceMsg.className = '';
            }
        }

        // FunciÃ³n para agregar dispositivo
        async function addDevice() {
            const deviceId = document.getElementById('newId').value.trim();
            const building = document.getElementById('newBld').value.trim();
            const unit = document.getElementById('newUnit').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const deviceMsg = document.getElementById('deviceMsg');

            // Validar campos requeridos
            if (!deviceId || !building || !unit) {
                deviceMsg.textContent = 'Please fill in all required fields';
                deviceMsg.className = 'error';
                return;
            }

            // Obtener el formulario oculto de agregar dispositivo
            const addForm = document.getElementById('addDeviceForm');
            const deviceIdInput = document.getElementById('addDeviceId');
            const buildingInput = document.getElementById('addDeviceBuilding');
            const unitInput = document.getElementById('addDeviceUnit');
            const emailInput = document.getElementById('addDeviceEmail');

            // Verificar que los elementos existen antes de establecer valores
            if (!deviceIdInput || !buildingInput || !unitInput || !emailInput) {
                deviceMsg.textContent = 'Error: Formulario no encontrado';
                deviceMsg.className = 'error';
                return;
            }

            // Generar email Ãºnico para el dispositivo
            const uniqueEmail = await generateUniqueEmail(email);

            // Establecer los valores en el formulario oculto
            deviceIdInput.value = deviceId;
            buildingInput.value = building;
            unitInput.value = unit;
            emailInput.value = uniqueEmail;

            // Enviar el formulario
            addForm.submit();

            // Limpiar formulario de entrada
            clearDeviceForm();

            // Mostrar mensaje de Ã©xito con email Ãºnico
            if (uniqueEmail !== email) {
                deviceMsg.textContent = `Device added successfully! (Unique Email: ${uniqueEmail})`;
            } else {
                deviceMsg.textContent = 'Device added successfully!';
            }
            deviceMsg.className = 'success';

            // Limpiar mensaje despuÃ©s de 3 segundos
            setTimeout(() => {
                deviceMsg.textContent = '';
                deviceMsg.className = '';
            }, 3000);

            // Reload devices list after a delay to show the new device
            setTimeout(() => {
                loadDevices();
            }, 2000);
        }

        // Devices API URL
        const DEVICES_API_URL = 'https://script.google.com/macros/s/AKfycbwt8uBwwZ2VBe-bTDST1sT_BxTjxqT163JVv42WxRdplMXjftHI9NOtYvr2T6tv7-z_Vg/exec';

        // Load buildings from API (grouped by buildingName)
        async function loadBuildings() {
            const buildingsList = document.getElementById('buildingsList');
            if (!buildingsList) return;

            let renderedFromCache = false;

            try {
                const cachedBuildings = localStorage.getItem('buildings_list_cache');
                if (cachedBuildings) {
                    const parsedBuildings = JSON.parse(cachedBuildings);
                    if (Array.isArray(parsedBuildings) && parsedBuildings.length > 0) {
                        renderBuildingsList(parsedBuildings);
                        renderedFromCache = true;
                    }
                }
            } catch (cacheError) {
                console.error('Error parsing cached buildings list:', cacheError);
                localStorage.removeItem('buildings_list_cache');
                localStorage.removeItem('buildings_list_cache_timestamp');
            }

            if (!renderedFromCache) {
                buildingsList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">Loading buildings...</p>';
            }

            try {
                const response = await fetch(DEVICES_API_URL);
                const result = await response.json();

                if (result.success && result.data && Array.isArray(result.data)) {
                    const validDevices = result.data.filter(device => device && device.deviceId && device.deviceId.trim() !== '');

                    if (validDevices.length === 0) {
                        buildingsList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No buildings found</p>';
                        localStorage.removeItem('buildings_list_cache');
                        localStorage.removeItem('buildings_list_cache_timestamp');
                        return;
                    }

                    const buildingsMap = {};
                    validDevices.forEach(device => {
                        const buildingName = (device.buildingName && device.buildingName.trim()) || 'Unknown Building';
                        if (!buildingsMap[buildingName]) {
                            buildingsMap[buildingName] = [];
                        }
                        buildingsMap[buildingName].push(device);
                    });

                    const buildingNames = Object.keys(buildingsMap).sort((a, b) => a.localeCompare(b));
                    if (buildingNames.length === 0) {
                        buildingsList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No buildings found</p>';
                        localStorage.removeItem('buildings_list_cache');
                        localStorage.removeItem('buildings_list_cache_timestamp');
                        return;
                    }

                    const buildingsData = buildingNames.map(name => ({
                        name,
                        devices: buildingsMap[name]
                    }));

                    localStorage.setItem('buildings_list_cache', JSON.stringify(buildingsData));
                    localStorage.setItem('buildings_list_cache_timestamp', Date.now().toString());

                    renderBuildingsList(buildingsData);
                } else if (!renderedFromCache) {
                    buildingsList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">Error loading buildings</p>';
                }
            } catch (error) {
                console.error('Error loading buildings:', error);
                if (!renderedFromCache) {
                    buildingsList.innerHTML = '<p style="text-align: center; color: #ef5350; padding: 40px;">Error loading buildings. Please try again.</p>';
                }
            }
        }

        function renderBuildingsList(buildingsData) {
            const buildingsList = document.getElementById('buildingsList');
            if (!buildingsList) return;

            buildingsList.innerHTML = '';

            if (!Array.isArray(buildingsData) || buildingsData.length === 0) {
                buildingsList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No buildings found</p>';
                return;
            }

            const gradients = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
                'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                'linear-gradient(135deg, #ef5350 0%, #c62828 100%)',
                'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)'
            ];
            const borderColors = ['#667eea', '#22c55e', '#f59e0b', '#ef5350', '#3b82f6'];

            buildingsData.forEach((building, buildingIndex) => {
                const buildingName = building.name || 'Unknown Building';
                const devices = Array.isArray(building.devices) ? building.devices : [];
                const deviceCount = devices.length;
                const gradient = gradients[buildingIndex % gradients.length];
                const borderColor = borderColors[buildingIndex % borderColors.length];
                const escapedBuildingName = buildingName.replace(/'/g, "\\'");

                const buildingHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); margin-bottom: 30px;">
                        <div style="display: flex; align-items: center; gap: 20px; padding: 20px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px;">
                            <div style="width: 80px; height: 80px; border-radius: 12px; background: ${gradient}; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px;">
                                <i class="fas fa-building"></i>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="font-size: 24px; color: #1a1a2e; margin-bottom: 8px;">${buildingName}</h3>
                                <p style="color: #888; font-size: 14px; margin-bottom: 5px;">Building Location</p>
                                <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Active</span>
                            </div>
                            <div style="text-align: right;">
                                <p style="color: #888; font-size: 12px; margin-bottom: 5px;">Total Devices</p>
                                <p style="color: #1a1a2e; font-size: 20px; font-weight: 600;">${deviceCount}</p>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <h4 style="font-size: 18px; color: #1a1a2e; margin-bottom: 15px;">
                                <i class="fas fa-mobile-alt" style="margin-right: 8px; color: #667eea;"></i>Assigned Devices
                            </h4>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid ${borderColor};">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 50px; height: 50px; border-radius: 8px; background: ${gradient}; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                                        <i class="fas fa-mobile-alt"></i>
                                    </div>
                                    <div>
                                        <p style="font-size: 16px; color: #1a1a2e; margin: 0; font-weight: 600;">${deviceCount} Device${deviceCount !== 1 ? 's' : ''}</p>
                                        <p style="color: #888; font-size: 14px; margin: 5px 0 0 0;">Click to view all devices</p>
                                    </div>
                                </div>
                                <button onclick="openBuildingDevicesModal('${escapedBuildingName}')" style="padding: 10px 20px; border-radius: 8px; border: 2px solid ${borderColor}; background: white; color: ${borderColor}; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                                    <i class="fas fa-eye" style="margin-right: 5px;"></i>View Devices
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                buildingsList.innerHTML += buildingHTML;
            });
        }

        // Load devices from API with cached fallback
        async function loadDevices() {
            const devicesList = document.getElementById('devicesList');
            if (!devicesList) return;

            let renderedFromCache = false;

            try {
                const cachedDevices = localStorage.getItem('devices_list_cache');
                if (cachedDevices) {
                    const parsedDevices = JSON.parse(cachedDevices);
                    if (Array.isArray(parsedDevices) && parsedDevices.length > 0) {
                        renderDevicesList(parsedDevices);
                        renderedFromCache = true;
                    }
                }
            } catch (cacheError) {
                console.error('Error parsing cached devices list:', cacheError);
                localStorage.removeItem('devices_list_cache');
                localStorage.removeItem('devices_list_cache_timestamp');
            }

            if (!renderedFromCache) {
                devicesList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">Loading devices...</p>';
            }

            try {
                const response = await fetch(DEVICES_API_URL);
                const result = await response.json();

                if (result.success && result.data && Array.isArray(result.data)) {
                    const validDevices = result.data.filter(device => device && device.deviceId && device.deviceId.trim() !== '');

                    if (validDevices.length === 0) {
                        devicesList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No devices found</p>';
                        localStorage.removeItem('devices_list_cache');
                        localStorage.removeItem('devices_list_cache_timestamp');
                        return;
                    }

                    localStorage.setItem('devices_list_cache', JSON.stringify(validDevices));
                    localStorage.setItem('devices_list_cache_timestamp', Date.now().toString());

                    renderDevicesList(validDevices);
                } else if (!renderedFromCache) {
                    devicesList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">Error loading devices</p>';
                }
            } catch (error) {
                console.error('Error loading devices:', error);
                if (!renderedFromCache) {
                    devicesList.innerHTML = '<p style="text-align: center; color: #ef5350; padding: 40px;">Error loading devices. Please try again.</p>';
                }
            }
        }

        function renderDevicesList(devices) {
            const devicesList = document.getElementById('devicesList');
            if (!devicesList) return;

            devicesList.innerHTML = '';

            if (!Array.isArray(devices) || devices.length === 0) {
                devicesList.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">No devices found</p>';
                return;
            }

            devices.forEach((device, index) => {
                if (!device || !device.deviceId) {
                    return;
                }

                const deviceId = device.deviceId.trim();
                const escapedDeviceId = deviceId.replace(/'/g, "\\'");
                const escapedClientEmail = (device.clientEmail || 'N/A').replace(/'/g, "\\'");
                const borderStyle = index < devices.length - 1 ? 'border-bottom: 1px solid #f0f0f0;' : '';

                const deviceHTML = `
                    <div style="display: flex; align-items: center; gap: 20px; padding: 20px; ${borderStyle}">
                        <div style="width: 60px; height: 60px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div style="flex: 1;">
                            <h3 style="font-size: 18px; color: #1a1a2e; margin-bottom: 5px;">Device ID: ${deviceId || 'N/A'}</h3>
                            <p style="color: #888; font-size: 14px; margin-bottom: 5px;">Building: ${device.buildingName || 'N/A'}</p>
                            <p style="color: #888; font-size: 14px; margin-bottom: 5px;">Unit/Elevator: ${device.unitElevator || 'N/A'}</p>
                            <p style="color: #888; font-size: 14px;">Client: ${device.clientEmail || 'N/A'}</p>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button onclick="openDeviceDetailsModal('${escapedDeviceId}')" style="padding: 8px 16px; border-radius: 8px; border: 2px solid #667eea; background: white; color: #667eea; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s;">
                                <i class="fas fa-info-circle" style="margin-right: 5px;"></i>Details
                            </button>
                            <button onclick="deleteDevice('${escapedClientEmail}')" style="padding: 8px 16px; border-radius: 8px; border: 2px solid #ef5350; background: white; color: #ef5350; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s;">
                                <i class="fas fa-trash" style="margin-right: 5px;"></i>Delete
                            </button>
                        </div>
                    </div>
                `;

                devicesList.innerHTML += deviceHTML;
            });
        }

        // Load clients from API for notification modal
        async function loadClients() {
            try {
                const response = await fetch(USERS_API_URL);
                const result = await response.json();

                const clientsList = document.getElementById('clientsList');
                clientsList.innerHTML = '';

                if (result.success && result.data && Array.isArray(result.data)) {
                    // Filter only clients - check for both 'Client' and 'client' (case insensitive)
                    const clients = result.data.filter(user => {
                        const hasValidEmail = user.email && user.email.trim() !== '';
                        const isClient = user.role && (user.role.toLowerCase() === 'client');
                        return hasValidEmail && isClient;
                    });

                    console.log('Total users:', result.data.length);
                    console.log('Filtered clients:', clients.length);
                    console.log('Clients:', clients);

                    if (clients.length === 0) {
                        clientsList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No clients found</p>';
                        return;
                    }

                    clients.forEach((client, index) => {
                        // Get name from email
                        const emailParts = client.email.split('@');
                        const nameParts = emailParts[0].split('.');
                        const firstName = nameParts[0].charAt(0).toUpperCase() + nameParts[0].slice(1);
                        const lastName = nameParts[1] ? nameParts[1].charAt(0).toUpperCase() + nameParts[1].slice(1) : '';
                        const displayName = lastName ? `${firstName} ${lastName}` : firstName;

                        // Escape email for onclick - escape quotes and special characters
                        const escapedEmail = client.email.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const escapedDisplayName = displayName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const escapedEmailDisplay = client.email.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                        const clientHTML = `
                            <div class="client-option" style="display: flex; align-items: center; padding: 12px 16px; cursor: pointer; ${index < clients.length - 1 ? 'border-bottom: 1px solid #f0f0f0;' : ''}" onclick="toggleClient(this, '${escapedEmail}')">
                                <i class="fas fa-check" style="display: none; color: #667eea; margin-right: 10px; width: 16px;"></i>
                                <span style="width: 16px; margin-right: 10px;"></span>
                                <span style="font-size: 14px; color: #1a1a2e;">${escapedDisplayName} - ${escapedEmailDisplay}</span>
                            </div>
                        `;
                        clientsList.innerHTML += clientHTML;
                    });
                } else {
                    clientsList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Error loading clients</p>';
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                const clientsList = document.getElementById('clientsList');
                clientsList.innerHTML = '<p style="text-align: center; color: #ef5350; padding: 20px;">Error loading clients. Please try again.</p>';
            }
        }

        // Toggle Custom Alert Form
        function toggleCustomAlertForm() {
            const form = document.getElementById('customAlertForm');
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
                // Clear form
                document.getElementById('customAlertDeviceId').value = '';
                document.getElementById('customAlertOutOfService').value = '';
                document.getElementById('customAlertFireService').value = '';
                document.getElementById('customAlertPhoneComm').value = '';
                document.getElementById('customAlertPitFlooded').value = '';
                document.getElementById('customAlertAtFloor').value = '';
                document.getElementById('customAlertMoving').value = '';
                document.getElementById('customAlertStatusFalse').value = '';
                document.getElementById('customAlertStatusTrue').value = '';
                // Reset checkboxes to checked
                document.getElementById('activeInput1').checked = true;
                document.getElementById('activeInput2').checked = true;
                document.getElementById('activeInput3').checked = true;
                document.getElementById('activeInput4').checked = true;
                document.getElementById('activeInput5').checked = true;
                document.getElementById('activeInput6').checked = true;
            }
        }

        // Save Custom Alert Names
        async function saveCustomAlertNames(event) {
            event.preventDefault();

            const deviceId = document.getElementById('customAlertDeviceId').value.trim();
            const outOfService = document.getElementById('customAlertOutOfService').value.trim();
            const fireService = document.getElementById('customAlertFireService').value.trim();
            const phoneComm = document.getElementById('customAlertPhoneComm').value.trim();
            const pitFlooded = document.getElementById('customAlertPitFlooded').value.trim();
            const atFloor = document.getElementById('customAlertAtFloor').value.trim();
            const moving = document.getElementById('customAlertMoving').value.trim();

            // Get active inputs
            const activeInputs = [];
            if (document.getElementById('activeInput1').checked) activeInputs.push('input1');
            if (document.getElementById('activeInput2').checked) activeInputs.push('input2');
            if (document.getElementById('activeInput3').checked) activeInputs.push('input3');
            if (document.getElementById('activeInput4').checked) activeInputs.push('input4');
            if (document.getElementById('activeInput5').checked) activeInputs.push('input5');
            if (document.getElementById('activeInput6').checked) activeInputs.push('input6');

            const activeAlert = activeInputs.join(',');

            if (!deviceId) {
                alert('Please enter a Device ID');
                return;
            }

            const msgElement = document.getElementById('customAlertMsg');
            msgElement.textContent = 'Saving...';
            msgElement.style.display = 'block';
            msgElement.style.color = '#667eea';

            try {
                const formData = new FormData();
                formData.append('id', deviceId);
                formData.append('out_of_service', outOfService);
                formData.append('fire_service', fireService);
                formData.append('phone_comm', phoneComm);
                formData.append('pit_flooded', pitFlooded);
                formData.append('at_floor', atFloor);
                formData.append('moving', moving);
                formData.append('active_alert', activeAlert);
                
                const statusFalse = document.getElementById('customAlertStatusFalse').value.trim();
                const statusTrue = document.getElementById('customAlertStatusTrue').value.trim();
                formData.append('status_false', statusFalse);
                formData.append('status_true', statusTrue);

                const response = await fetch(CUSTOM_FIELD_NAMES_API_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    msgElement.textContent = 'âœ“ Custom names saved successfully!';
                    msgElement.style.color = '#27ae60';

                    // Clear form
                    toggleCustomAlertForm();

                    // Reload list
                    loadCustomAlerts();

                    setTimeout(() => {
                        msgElement.style.display = 'none';
                    }, 3000);
                } else {
                    msgElement.textContent = 'âœ— Error: ' + (result.message || 'Failed to save');
                    msgElement.style.color = '#ef5350';
                }
            } catch (error) {
                console.error('Error saving custom alert names:', error);
                msgElement.textContent = 'âœ— Error saving custom names';
                msgElement.style.color = '#ef5350';
            }
        }

        // Load Custom Alerts
        async function loadCustomAlerts() {
            const listContainer = document.getElementById('customAlertsList');

            try {
                const response = await fetch(CUSTOM_FIELD_NAMES_API_URL);
                const result = await response.json();

                if (result.success && result.data && Array.isArray(result.data)) {
                    if (result.data.length === 0) {
                        listContainer.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No custom alert names configured yet</p>';
                        return;
                    }

                    listContainer.innerHTML = '';

                    result.data.forEach(item => {
                        const deviceId = item.id || 'Unknown';
                        const escapedDeviceId = deviceId.replace(/'/g, "\\'");

                        // Parse active_alert to get which inputs are active
                        const activeInputs = item.active_alert 
                            ? item.active_alert.split(',').map(s => s.trim()).filter(s => s)
                            : [];
                        const isInput1Active = activeInputs.includes('input1');
                        const isInput2Active = activeInputs.includes('input2');
                        const isInput3Active = activeInputs.includes('input3');
                        const isInput4Active = activeInputs.includes('input4');
                        const isInput5Active = activeInputs.includes('input5');
                        const isInput6Active = activeInputs.includes('input6');

                        const alertHTML = `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div style="flex: 1;">
                                        <h4 style="font-size: 18px; color: #1a1a2e; margin: 0 0 10px 0;">
                                            <i class="fas fa-mobile-alt" style="margin-right: 8px; color: #667eea;"></i>${deviceId}
                                        </h4>
                                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                                            ${item.out_of_service ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" ${isInput1Active ? 'checked' : ''} onclick="toggleInputActive('${escapedDeviceId}', 'input1', this.checked)" style="width: 18px; height: 18px; cursor: pointer;"><strong>input1:</strong> <span style="color: #667eea;">${item.out_of_service}</span></div>` : ''}
                                            ${item.fire_service ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" ${isInput2Active ? 'checked' : ''} onclick="toggleInputActive('${escapedDeviceId}', 'input2', this.checked)" style="width: 18px; height: 18px; cursor: pointer;"><strong>input2:</strong> <span style="color: #667eea;">${item.fire_service}</span></div>` : ''}
                                            ${item.phone_comm ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" ${isInput3Active ? 'checked' : ''} onclick="toggleInputActive('${escapedDeviceId}', 'input3', this.checked)" style="width: 18px; height: 18px; cursor: pointer;"><strong>input3:</strong> <span style="color: #667eea;">${item.phone_comm}</span></div>` : ''}
                                            ${item.pit_flooded ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" ${isInput4Active ? 'checked' : ''} onclick="toggleInputActive('${escapedDeviceId}', 'input4', this.checked)" style="width: 18px; height: 18px; cursor: pointer;"><strong>input4:</strong> <span style="color: #667eea;">${item.pit_flooded}</span></div>` : ''}
                                            ${item.at_floor ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" ${isInput5Active ? 'checked' : ''} onclick="toggleInputActive('${escapedDeviceId}', 'input5', this.checked)" style="width: 18px; height: 18px; cursor: pointer;"><strong>input5:</strong> <span style="color: #667eea;">${item.at_floor}</span></div>` : ''}
                                            ${item.moving ? `<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" ${isInput6Active ? 'checked' : ''} onclick="toggleInputActive('${escapedDeviceId}', 'input6', this.checked)" style="width: 18px; height: 18px; cursor: pointer;"><strong>input6:</strong> <span style="color: #667eea;">${item.moving}</span></div>` : ''}
                                        </div>
                                        ${item.active_alert ? `
                                            <div style="margin-top: 10px; padding: 8px 12px; background: #e8f5e9; border-radius: 6px; display: inline-block;">
                                                <strong style="color: #2e7d32;">Active Inputs:</strong> 
                                                <span style="color: #2e7d32;">${item.active_alert}</span>
                                            </div>
                                        ` : `
                                            <div style="margin-top: 10px; padding: 8px 12px; background: #fee2e2; border-radius: 6px; display: inline-block;">
                                                <strong style="color: #dc2626;">No Active Inputs</strong>
                                            </div>
                                        `}
                                    </div>
                                    <div style="display: flex; gap: 10px; margin-left: 15px;">
                                        <button onclick="editCustomAlert('${escapedDeviceId}')" style="padding: 8px 16px; border-radius: 8px; border: 2px solid #667eea; background: white; color: #667eea; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s;">
                                            <i class="fas fa-edit" style="margin-right: 5px;"></i>Edit
                                        </button>
                                        <button onclick="deleteCustomAlert('${escapedDeviceId}')" style="padding: 8px 16px; border-radius: 8px; border: 2px solid #ef5350; background: white; color: #ef5350; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s;">
                                            <i class="fas fa-trash" style="margin-right: 5px;"></i>Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        listContainer.innerHTML += alertHTML;
                    });
                } else {
                    listContainer.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No custom alert names found</p>';
                }
            } catch (error) {
                console.error('Error loading custom alerts:', error);
                listContainer.innerHTML = '<p style="text-align: center; color: #ef5350; padding: 20px;">Error loading custom alerts</p>';
            }
        }

        // Toggle Signal Active State
        async function toggleInputActive(deviceId, inputName, isChecked) {
            // Block if update is in progress
            if (isInputUpdateInProgress) {
                // Revert checkbox state - find the checkbox that was clicked
                const checkboxes = document.querySelectorAll(`#customAlertsList input[onclick*="toggleInputActive('${deviceId.replace(/'/g, "\\'")}', '${inputName}'"]`);
                checkboxes.forEach(cb => cb.checked = !isChecked);
                return;
            }

            // Set update in progress and disable all checkboxes
            isInputUpdateInProgress = true;
            const allCheckboxes = document.querySelectorAll('#customAlertsList input[type="checkbox"]');
            allCheckboxes.forEach(cb => cb.disabled = true);

            try {
                // Get current data for this device
                const response = await fetch(CUSTOM_FIELD_NAMES_API_URL);
                const result = await response.json();

                if (!result.success || !result.data) {
                    alert('Error loading device data');
                    // Re-enable checkboxes
                    isInputUpdateInProgress = false;
                    allCheckboxes.forEach(cb => cb.disabled = false);
                    return;
                }

                // Find the device
                const device = result.data.find(item => item.id === deviceId);
                if (!device) {
                    alert('Device not found');
                    // Re-enable checkboxes
                    isInputUpdateInProgress = false;
                    allCheckboxes.forEach(cb => cb.disabled = false);
                    return;
                }

                // Parse current active inputs - only include valid input names
                let activeInputs = device.active_alert 
                    ? device.active_alert.split(',').map(s => s.trim()).filter(s => s && (s.startsWith('input') && ['input1', 'input2', 'input3', 'input4', 'input5', 'input6'].includes(s)))
                    : [];

                // Update the active inputs array based on checkbox state
                if (isChecked) {
                    // Add input if not already present (only if it's a valid input)
                    if (!activeInputs.includes(inputName) && ['input1', 'input2', 'input3', 'input4', 'input5', 'input6'].includes(inputName)) {
                        activeInputs.push(inputName);
                    }
                } else {
                    // Remove input from active list
                    activeInputs = activeInputs.filter(s => s !== inputName);
                }

                // Sort inputs to maintain order (input1, input2, etc.)
                activeInputs.sort();

                // Create new active_alert string - only includes checked inputs
                // If no inputs are checked, send empty string
                const newActiveAlert = activeInputs.length > 0 ? activeInputs.join(',') : '';

                // Clear previous form fields
                while (hiddenCustomAlertForm.firstChild) {
                    hiddenCustomAlertForm.removeChild(hiddenCustomAlertForm.firstChild);
                }

                // Add form fields - always send all fields including active_alert
                const deviceIdInput = document.createElement('input');
                deviceIdInput.type = 'hidden';
                deviceIdInput.name = 'id';
                deviceIdInput.value = deviceId;
                hiddenCustomAlertForm.appendChild(deviceIdInput);

                // Always send active_alert field (even if empty)
                const activeAlertInput = document.createElement('input');
                activeAlertInput.type = 'hidden';
                activeAlertInput.name = 'active_alert';
                activeAlertInput.value = newActiveAlert;
                hiddenCustomAlertForm.appendChild(activeAlertInput);

                // Send other fields if they exist
                if (device.out_of_service) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'out_of_service';
                    input.value = device.out_of_service;
                    hiddenCustomAlertForm.appendChild(input);
                }

                if (device.fire_service) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'fire_service';
                    input.value = device.fire_service;
                    hiddenCustomAlertForm.appendChild(input);
                }

                if (device.phone_comm) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'phone_comm';
                    input.value = device.phone_comm;
                    hiddenCustomAlertForm.appendChild(input);
                }

                if (device.pit_flooded) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'pit_flooded';
                    input.value = device.pit_flooded;
                    hiddenCustomAlertForm.appendChild(input);
                }

                if (device.at_floor) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'at_floor';
                    input.value = device.at_floor;
                    hiddenCustomAlertForm.appendChild(input);
                }

                if (device.moving) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'moving';
                    input.value = device.moving;
                    hiddenCustomAlertForm.appendChild(input);
                }

                // Clear cache to reload custom names
                customFieldNamesCache = null;

                // Remove previous onload handler to avoid conflicts
                hiddenCustomAlertIframe.onload = null;

                // Submit form
                hiddenCustomAlertForm.submit();

                // Handle iframe load - reload after update
                hiddenCustomAlertIframe.onload = function () {
                    // Small delay to ensure server processed the update
                    setTimeout(() => {
                        loadCustomAlerts();
                        // Re-enable checkboxes
                        isInputUpdateInProgress = false;
                    }, 1000);
                };

                // Fallback: reload after 2 seconds even if iframe doesn't fire onload
                setTimeout(() => {
                    if (isSignalUpdateInProgress) {
                        loadCustomAlerts();
                        // Re-enable checkboxes
                        isInputUpdateInProgress = false;
                    }
                }, 2000);
            } catch (error) {
                console.error('Error toggling signal active state:', error);
                loadCustomAlerts();
                // Re-enable checkboxes
                isSignalUpdateInProgress = false;
            }
        }

        // Edit Custom Alert - Load data into form
        async function editCustomAlert(deviceId) {
            try {
                console.log('ðŸ” Editing custom alert for device:', deviceId);
                
                // Fetch all custom alerts
                const response = await fetch(CUSTOM_FIELD_NAMES_API_URL);
                const result = await response.json();

                console.log('ðŸ“‹ API Response:', result);
                console.log('ðŸ“‹ API Success:', result.success);
                console.log('ðŸ“‹ API Data:', result.data);

                if (result.success && result.data && Array.isArray(result.data)) {
                    console.log('âœ… Data is valid array with', result.data.length, 'items');
                    
                    // Find the device
                    const device = result.data.find(item => {
                        console.log('ðŸ” Comparing:', item.id, '===', deviceId, '?', item.id === deviceId);
                        return item.id === deviceId;
                    });
                    
                    console.log('ðŸ“¦ Found device:', device);
                    
                    if (!device) {
                        alert(`Device ${deviceId} not found in API response`);
                        console.error('âŒ Device not found. Available devices:', result.data.map(d => d.id));
                        return;
                    }

                    // Fill form with device data
                    document.getElementById('customAlertDeviceId').value = device.id || '';
                    document.getElementById('customAlertOutOfService').value = device.out_of_service || '';
                    document.getElementById('customAlertFireService').value = device.fire_service || '';
                    document.getElementById('customAlertPhoneComm').value = device.phone_comm || '';
                    document.getElementById('customAlertPitFlooded').value = device.pit_flooded || '';
                    document.getElementById('customAlertAtFloor').value = device.at_floor || '';
                    document.getElementById('customAlertMoving').value = device.moving || '';
                    document.getElementById('customAlertStatusFalse').value = device.status_false || '';
                    document.getElementById('customAlertStatusTrue').value = device.status_true || '';

                    console.log('âœ… Form fields filled');

                    // Set active signals checkboxes (IDs are activeInput1, activeInput2, etc.)
                    const activeSignals = device.active_alert 
                        ? device.active_alert.split(',').map(s => s.trim()).filter(s => s)
                        : [];
                    
                    console.log('ðŸ“¡ Active signals:', activeSignals);
                    
                    // Corregido: usar activeInput1-6 en lugar de activeSignal1-6
                    const input1Checkbox = document.getElementById('activeInput1');
                    const input2Checkbox = document.getElementById('activeInput2');
                    const input3Checkbox = document.getElementById('activeInput3');
                    const input4Checkbox = document.getElementById('activeInput4');
                    const input5Checkbox = document.getElementById('activeInput5');
                    const input6Checkbox = document.getElementById('activeInput6');
                    
                    if (input1Checkbox) input1Checkbox.checked = activeSignals.includes('signal1') || activeSignals.includes('input1');
                    if (input2Checkbox) input2Checkbox.checked = activeSignals.includes('signal2') || activeSignals.includes('input2');
                    if (input3Checkbox) input3Checkbox.checked = activeSignals.includes('signal3') || activeSignals.includes('input3');
                    if (input4Checkbox) input4Checkbox.checked = activeSignals.includes('signal4') || activeSignals.includes('input4');
                    if (input5Checkbox) input5Checkbox.checked = activeSignals.includes('signal5') || activeSignals.includes('input5');
                    if (input6Checkbox) input6Checkbox.checked = activeSignals.includes('signal6') || activeSignals.includes('input6');

                    console.log('âœ… Checkboxes set');

                    // Show the form
                    const formElement = document.getElementById('customAlertForm');
                    if (formElement) {
                        formElement.style.display = 'block';
                        // Scroll to form
                        formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        console.log('âœ… Form displayed and scrolled into view');
                    } else {
                        console.error('âŒ customAlertForm element not found');
                    }
                } else {
                    console.error('âŒ Invalid API response structure');
                    console.error('Result:', result);
                    alert('Error loading device data: Invalid API response');
                }
            } catch (error) {
                console.error('âŒ Error loading device for edit:', error);
                console.error('Error details:', error.message, error.stack);
                alert(`Error loading device data: ${error.message}`);
            }
        }

        // Delete Custom Alert
        async function deleteCustomAlert(deviceId) {
            if (!confirm(`Are you sure you want to delete custom names for device ${deviceId}?`)) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('id', deviceId);
                formData.append('delete', 'true');

                const response = await fetch(CUSTOM_FIELD_NAMES_API_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Reload list
                    loadCustomAlerts();
                } else {
                    alert('Error deleting custom alert: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting custom alert:', error);
                alert('Error deleting custom alert');
            }
        }

        // Support IDs Management Functions
        async function addSupportId(event) {
            event.preventDefault();
            const supportIdInput = document.getElementById('supportIdInput');
            const supportMsg = document.getElementById('supportMsg');
            const supportId = supportIdInput.value.trim();

            if (!supportId) {
                supportMsg.textContent = 'Please enter a Support ID';
                supportMsg.style.color = '#e74c3c';
                supportMsg.style.display = 'block';
                return;
            }

            try {
                const formData = new FormData();
                formData.append('id', supportId);

                const response = await fetch(SUPPORT_API_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    supportMsg.textContent = result.message || 'Support ID added successfully';
                    supportMsg.style.color = '#27ae60';
                    supportMsg.style.display = 'block';
                    supportIdInput.value = '';
                    // Reload list
                    loadSupportIds();
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        supportMsg.style.display = 'none';
                    }, 3000);
                } else {
                    supportMsg.textContent = result.message || 'Error adding Support ID';
                    supportMsg.style.color = '#e74c3c';
                    supportMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('Error adding support ID:', error);
                supportMsg.textContent = 'Error adding Support ID';
                supportMsg.style.color = '#e74c3c';
                supportMsg.style.display = 'block';
            }
        }

        async function loadSupportIds() {
            const supportList = document.getElementById('supportList');
            if (!supportList) return;

            try {
                const response = await fetch(SUPPORT_API_URL);
                const result = await response.json();

                if (result.success && result.data && Array.isArray(result.data)) {
                    if (result.data.length === 0) {
                        supportList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No Support IDs found</p>';
                        return;
                    }

                    supportList.innerHTML = result.data.map(item => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e0e0e0; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px;">
                            <span style="font-size: 16px; color: #333; font-weight: 600;">${item.id || ''}</span>
                            <button onclick="deleteSupportId('${item.id}')" 
                                style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                                Delete
                            </button>
                        </div>
                    `).join('');
                } else {
                    supportList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No Support IDs found</p>';
                }
            } catch (error) {
                console.error('Error loading support IDs:', error);
                supportList.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 20px;">Error loading Support IDs</p>';
            }
        }

        // Variable to store the ID to delete
        let supportIdToDelete = null;

        function deleteSupportId(id) {
            supportIdToDelete = id;
            document.getElementById('deleteSupportIdText').textContent = id;
            document.getElementById('deleteSupportModal').style.display = 'flex';
        }

        function closeDeleteSupportModal() {
            document.getElementById('deleteSupportModal').style.display = 'none';
            supportIdToDelete = null;
        }

        async function confirmDeleteSupportId() {
            if (!supportIdToDelete) {
                closeDeleteSupportModal();
                return;
            }

            try {
                const formData = new FormData();
                formData.append('id', supportIdToDelete);
                formData.append('delete', 'true');

                const response = await fetch(SUPPORT_API_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Close modal
                    closeDeleteSupportModal();
                    // Reload list
                    loadSupportIds();
                } else {
                    closeDeleteSupportModal();
                    alert('Error deleting Support ID: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting support ID:', error);
                closeDeleteSupportModal();
                alert('Error deleting Support ID');
            }
        }

        // ============================================
        // COLOR PICKER FUNCTIONS
        // ============================================
        function openColorPickerModal() {
            const modal = document.getElementById('colorPickerModal');
            modal.style.display = 'flex';
            
            // Initialize color input and display
            const colorInput = document.getElementById('colorInput');
            const hexDisplay = document.getElementById('hexColorDisplay');
            
            // Update hex display when color changes
            colorInput.addEventListener('input', function() {
                hexDisplay.value = this.value.toUpperCase();
            });
            
            // Add click handlers to quick colors
            document.querySelectorAll('.quick-color').forEach(colorDiv => {
                colorDiv.onclick = function() {
                    const color = this.getAttribute('data-color');
                    colorInput.value = color;
                    hexDisplay.value = color.toUpperCase();
                };
            });
        }

        function closeColorPickerModal() {
            const modal = document.getElementById('colorPickerModal');
            modal.style.display = 'none';
            
            // Hide copy message
            document.getElementById('colorCopyMsg').style.display = 'none';
        }

        function copyHexColor() {
            const hexDisplay = document.getElementById('hexColorDisplay');
            const hexValue = hexDisplay.value;
            
            // Copy to clipboard
            navigator.clipboard.writeText(hexValue).then(() => {
                // Show success message
                const msg = document.getElementById('colorCopyMsg');
                msg.style.display = 'block';
                
                // Hide message after 2 seconds
                setTimeout(() => {
                    msg.style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                // Fallback method
                hexDisplay.select();
                document.execCommand('copy');
                
                const msg = document.getElementById('colorCopyMsg');
                msg.style.display = 'block';
                setTimeout(() => {
                    msg.style.display = 'none';
                }, 2000);
            });
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('colorPickerModal');
            if (event.target === modal) {
                closeColorPickerModal();
            }
        });

    </script>
</body>

</html>